<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>å—é–€åœ‹å°æ‹¼å­—æŒ‘æˆ°Go</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --ink:#111827; --muted:#6b7280;
      --blue:#3b82f6; --green:#22c55e; --red:#ef4444; --amber:#f59e0b;
      --line:#e5e7eb; --shadow:0 10px 24px rgba(0,0,0,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC",Segoe UI,Roboto,sans-serif}
    a{color:inherit}
    .wrap{max-width:980px;margin:0 auto;padding:16px 14px 80px}
    .topbar{
      position:sticky;top:0;z-index:5;background:rgba(245,247,251,.85);
      backdrop-filter: blur(10px);border-bottom:1px solid var(--line);
    }
    .topbar .inner{max-width:980px;margin:0 auto;padding:10px 14px;display:flex;align-items:center;gap:10px}
    .brand{font-weight:900;letter-spacing:.5px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:7px 10px;font-size:13px;color:var(--muted)}
    .btn{border:0;border-radius:14px;padding:12px 14px;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--blue);color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--line)}
    .btn.small{padding:8px 10px;border-radius:12px;font-weight:800;font-size:13px}
    .btn.danger{background:#fff;border:1px solid #fecaca;color:#b91c1c}
    .grid{display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .center{text-align:center}
    .title{font-size:22px;font-weight:950;margin:0}
    .subtitle{margin:6px 0 0;color:var(--muted);font-weight:700}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .hidden{display:none!important}

    /* Map */
    .mapWrap{position:relative}
    .mapLegend{display:flex;gap:8px;align-items:center;justify-content:center;margin:10px 0 2px;color:var(--muted);font-weight:700;font-size:13px}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .dot.done{background:var(--green)}
    .dot.now{background:var(--blue)}
    .dot.lock{background:#cbd5e1}
    .map{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:16px;
      padding:14px;
    }
    .node{
      width:82px;height:82px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      margin:0 auto;
      background:#fff;border:1px solid var(--line);
      box-shadow:0 10px 22px rgba(0,0,0,.08);
      font-weight:950;font-size:18px;
      user-select:none;
      position:relative;
    }
    .node.done{background:var(--green);color:#fff;border-color:rgba(255,255,255,.35)}
    .node.now{background:var(--blue);color:#fff;border-color:rgba(255,255,255,.35)}
    .node.lock{opacity:.35}
    .node .badge{
      position:absolute;bottom:-6px;right:-6px;
      font-size:12px;background:#fff;border:1px solid var(--line);
      border-radius:999px;padding:4px 6px;color:var(--muted);font-weight:900
    }
    .node.done .badge,.node.now .badge{background:rgba(255,255,255,.95)}
    .mapPath{
      position:absolute;inset:0;pointer-events:none;opacity:.25
    }

    /* Game */
    .hud{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .progressBar{height:12px;border-radius:999px;background:#e5e7eb;overflow:hidden;flex:1;min-width:200px}
    .progressBar > div{height:100%;background:var(--green);width:0%}
    .timer{font-weight:950;color:var(--red)}
    .modeTag{font-weight:950;border-radius:999px;padding:6px 10px;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe}
    .qTitle{font-size:36px;font-weight:950;margin:12px 0 6px}
    .helpText{color:var(--muted);font-weight:800;margin:0 0 10px}
    .options{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .opt{
      border:1px solid var(--line);background:#fff;border-radius:16px;padding:14px;
      font-weight:950;font-size:18px;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.06)
    }
    .opt:active{transform:scale(.99)}
    .opt.correct{border-color:#86efac;background:#ecfdf5}
    .opt.wrong{border-color:#fecaca;background:#fef2f2}
    .bigBtn{width:100%;padding:14px 14px;font-size:18px;border-radius:16px}

    .spellRow{display:flex;gap:10px;align-items:center}
    .spellInput{
      width:100%;border:1px solid var(--line);border-radius:16px;padding:14px;font-size:18px;font-weight:900
    }

    /* Matching */
    .matchGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .tile{
      border:1px solid var(--line);border-radius:16px;background:#fff;padding:14px;
      font-weight:950;font-size:18px;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.06)
    }
    .tile.sel{outline:3px solid #93c5fd}
    .tile.gone{opacity:.15;pointer-events:none}
    .combo{color:var(--muted);font-weight:900}

    /* Teacher */
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;font-size:13px}
    th{color:var(--muted)}
    .kpi{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .kpi .box{border:1px solid var(--line);border-radius:16px;background:#fff;padding:12px}
    .kpi .num{font-weight:950;font-size:20px}
    .kpi .lbl{color:var(--muted);font-weight:800;font-size:12px}

    /* Bottom nav */
    .nav{
      position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line);
      display:flex;justify-content:center;gap:10px;padding:10px;z-index:10
    }
    .nav .tab{flex:1;max-width:240px}
    .tab .btn{width:100%}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">ğŸ« å—é–€åœ‹å°æ‹¼å­—æŒ‘æˆ°Go</div>
      <div style="flex:1"></div>
      <div class="pill" title="ç›®å‰å­¸ç”Ÿ">
        ğŸ‘§ğŸ‘¦ <span id="who">æœªç™»å…¥</span>
      </div>
      <button class="btn small ghost" id="switchBtn">åˆ‡æ›/ç™»å…¥</button>
      <button class="btn small ghost" id="teacherBtn">ğŸ‘©â€ğŸ« è€å¸«å¾Œå°</button>
    </div>
  </div>

  <div class="wrap">

    <!-- LOGIN -->
    <section id="view-login" class="grid">
      <div class="card">
        <h1 class="title center">é–‹å§‹æŒ‘æˆ°ï¼</h1>
        <p class="subtitle center">è¼¸å…¥åå­—å°±èƒ½ç©ï¼ˆåŒä¸€å°å¯å¤šä½å­¸ç”Ÿåˆ‡æ›ï¼‰</p>
        <div class="divider"></div>
        <div class="grid">
          <input id="nameInput" class="spellInput" placeholder="ä¾‹å¦‚ï¼šå°æ˜ / Emma" />
          <button class="btn primary bigBtn" id="loginBtn">âœ… é€²å…¥åœ°åœ–</button>
          <div class="muted" style="font-weight:800;font-size:13px;line-height:1.4">
            â€» ä¸åŒæ‰‹æ©Ÿçš„é€²åº¦ä¸æœƒè‡ªå‹•äº’é€šï¼ˆé™¤éä½ å¦å¤–æ¥é›²ç«¯ï¼‰ã€‚<br/>
            è€å¸«å¾Œå°å¯ã€ŒåŒ¯å‡ºCSVã€æˆ–ã€ŒåŒ¯å…¥/åŒ¯å‡ºJSONã€å½™æ•´ã€‚
          </div>
        </div>
      </div>
    </section>

    <!-- MAP -->
    <section id="view-map" class="grid hidden">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:950;font-size:18px">ğŸ—ºï¸ é—œå¡åœ°åœ–ï¼ˆ100é—œï¼‰</div>
            <div class="muted" style="font-weight:800;font-size:13px">æ¯é—œ 10 é¡Œï¼ŒA/B/C/D éš¨æ©Ÿï¼›é€šé—œè§£é–ä¸‹ä¸€é—œï¼›å·²é€šé—œå¯é‡ç©ã€‚</div>
          </div>
          <button class="btn ghost" id="resumeBtn">â–¶ï¸ çºŒç©æœ€å¾Œä¸€é—œ</button>
        </div>

        <div class="mapLegend">
          <span class="dot done"></span>å·²é€šé—œ
          <span class="dot now" style="margin-left:10px"></span>å¯æŒ‘æˆ°
          <span class="dot lock" style="margin-left:10px"></span>æœªè§£é–
        </div>

        <div class="mapWrap">
          <svg class="mapPath" id="pathSvg"></svg>
          <div class="map" id="mapGrid"></div>
        </div>
      </div>
    </section>

    <!-- GAME -->
    <section id="view-game" class="grid hidden">
      <div class="card">
        <div class="hud">
          <div class="row" style="gap:10px;align-items:center">
            <span class="pill">ğŸ¯ ç¬¬ <span id="gLevel">1</span> é—œ</span>
            <span class="pill">ğŸ” ç¬¬ <span id="gAttempt">1</span> æ¬¡</span>
            <span class="modeTag" id="gMode">A</span>
          </div>

          <div class="progressBar" title="æœ¬é—œé€²åº¦">
            <div id="barFill"></div>
          </div>

          <div class="pill">â±ï¸ <span class="timer" id="gTimer">00:00</span></div>
        </div>

        <div class="divider"></div>

        <div id="gameArea"></div>

        <div class="divider"></div>

        <div class="row" style="justify-content:space-between">
          <button class="btn ghost" id="backToMapBtn">â¬…ï¸ å›åœ°åœ–</button>
          <button class="btn primary" id="nextBtn">â¡ï¸ ä¸‹ä¸€é¡Œ</button>
        </div>
      </div>
    </section>

    <!-- TEACHER -->
    <section id="view-teacher" class="grid hidden">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:950;font-size:18px">ğŸ‘©â€ğŸ« è€å¸«å¾Œå°</div>
            <div class="muted" style="font-weight:800;font-size:13px">æœ¬é è®€å–çš„æ˜¯ã€Œé€™å°è£ç½®ã€çš„è³‡æ–™ï¼›å¯åŒ¯å‡ºCSVã€åŒ¯å…¥/åŒ¯å‡ºJSONå½™æ•´å…¶ä»–æ‰‹æ©Ÿè³‡æ–™ã€‚</div>
          </div>
          <button class="btn danger" id="wipeBtn">æ¸…ç©ºæœ¬æ©Ÿè³‡æ–™</button>
        </div>

        <div class="divider"></div>

        <div class="kpi">
          <div class="box">
            <div class="num" id="kStudents">0</div>
            <div class="lbl">å­¸ç”Ÿæ•¸ï¼ˆæœ¬æ©Ÿï¼‰</div>
          </div>
          <div class="box">
            <div class="num" id="kLogs">0</div>
            <div class="lbl">ä½œç­”ç´€éŒ„ç­†æ•¸</div>
          </div>
          <div class="box">
            <div class="num" id="kPass">0</div>
            <div class="lbl">é€šé—œç¸½æ•¸ï¼ˆç´¯è¨ˆï¼‰</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn primary" id="exportCsvBtn">ğŸ“¤ åŒ¯å‡º Excel(CSV)</button>
          <button class="btn ghost" id="exportJsonBtn">ğŸ“¦ åŒ¯å‡º JSONï¼ˆå½™æ•´ç”¨ï¼‰</button>
          <label class="btn ghost" style="cursor:pointer">
            ğŸ“¥ åŒ¯å…¥ JSON
            <input type="file" id="importJsonFile" accept="application/json" style="display:none">
          </label>
        </div>

        <div class="divider"></div>

        <div class="grid">
          <div class="row" style="justify-content:space-between">
            <div style="font-weight:950">å­¸ç”Ÿé€²åº¦ç¸½è¦½</div>
            <div class="muted" style="font-weight:800;font-size:13px">é»å­¸ç”Ÿå¯çœ‹è¿‘30ç­†ä½œç­”</div>
          </div>
          <table>
            <thead>
              <tr>
                <th>å­¸ç”Ÿ</th>
                <th>å·²é€šé—œ</th>
                <th>æœ€ä½³å¹³å‡æ­£ç¢ºç‡</th>
                <th>æœ€å¾ŒéŠç©</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="stuTable"></tbody>
          </table>
        </div>

        <div class="divider"></div>

        <div id="stuDetail" class="hidden">
          <div class="row" style="justify-content:space-between">
            <div style="font-weight:950">ğŸ“Œ æ˜ç´°ï¼š<span id="stuName"></span></div>
            <button class="btn ghost" id="closeDetailBtn">é—œé–‰</button>
          </div>
          <div class="divider"></div>
          <table>
            <thead>
              <tr>
                <th>æ™‚é–“</th>
                <th>é—œå¡</th>
                <th>å›åˆ</th>
                <th>é¡Œå‹</th>
                <th>é¡Œç›®</th>
                <th>æ­£ç¢º</th>
              </tr>
            </thead>
            <tbody id="logTable"></tbody>
          </table>
        </div>

      </div>
    </section>

  </div>

  <div class="nav">
    <div class="tab"><button class="btn ghost" id="tabMap">ğŸ—ºï¸ åœ°åœ–</button></div>
    <div class="tab"><button class="btn ghost" id="tabGame">ğŸ® é—œå¡</button></div>
    <div class="tab"><button class="btn ghost" id="tabTeacher">ğŸ‘©â€ğŸ« è€å¸«</button></div>
  </div>

<script>
/* ===========================
   1) 153 å­—å®Œæ•´é¡Œåº«ï¼ˆä¾†è‡ªä½ PDFï¼‰
   =========================== */
const WORD_BANK = [
  {"en":"able","zh":"èƒ½å¤ "},{"en":"all","zh":"æ‰€æœ‰"},{"en":"after","zh":"åœ¨â€¦ä¹‹å¾Œ"},{"en":"and","zh":"å’Œ"},{"en":"any","zh":"ä»»ä½•"},
  {"en":"ant","zh":"èèŸ»"},{"en":"apple","zh":"è˜‹æœ"},{"en":"April","zh":"å››æœˆ"},{"en":"ask","zh":"å•"},{"en":"at","zh":"åœ¨"},
  {"en":"baby","zh":"å¬°å…’"},{"en":"back","zh":"èƒŒé¢ï¼›å›"},{"en":"ball","zh":"çƒ"},{"en":"banana","zh":"é¦™è•‰"},{"en":"baseball","zh":"æ£’çƒ"},
  {"en":"basket","zh":"ç±ƒå­"},{"en":"bat","zh":"çƒæ£’ï¼›è™è "},{"en":"be","zh":"æ˜¯"},{"en":"bear","zh":"ç†Š"},{"en":"bee","zh":"èœœèœ‚"},
  {"en":"bell","zh":"éˆ´"},{"en":"big","zh":"å¤§çš„"},{"en":"bird","zh":"é³¥"},{"en":"black","zh":"é»‘è‰²"},{"en":"blue","zh":"è—è‰²"},
  {"en":"boat","zh":"èˆ¹"},{"en":"book","zh":"æ›¸"},{"en":"boy","zh":"ç”·å­©"},{"en":"bread","zh":"éºµåŒ…"},{"en":"break","zh":"æ–·è£‚ï¼›æš«åœ"},
  {"en":"brother","zh":"å…„å¼Ÿ"},{"en":"cake","zh":"è›‹ç³•"},{"en":"cap","zh":"æ£’çƒå¸½"},{"en":"camp","zh":"ç‡Ÿåœ°ï¼›å¸³ç¯·"},{"en":"card","zh":"å¡ç‰‡"},
  {"en":"candy","zh":"ç³–æœ"},{"en":"care","zh":"é—œæ‡·ï¼›ç…§é¡§"},{"en":"catch","zh":"æŠ“"},{"en":"chair","zh":"æ¤…å­"},{"en":"chalk","zh":"ç²‰ç­†"},
  {"en":"check","zh":"æ‰“å‹¾ï¼›ç¢ºèª"},{"en":"cool","zh":"æ¶¼çˆ½çš„;é…·"},{"en":"child","zh":"å°å­©"},{"en":"circle","zh":"åœ“"},{"en":"coffee","zh":"å’–å•¡"},
  {"en":"cup","zh":"æ¯å­"},{"en":"cute","zh":"å¯æ„›çš„"},{"en":"dark","zh":"é»‘æš—çš„"},{"en":"dance","zh":"è·³èˆ"},{"en":"dear","zh":"è¦ªæ„›çš„"},
  {"en":"desk","zh":"æ¡Œå­"},{"en":"dog","zh":"ç‹—"},{"en":"doll","zh":"å¨ƒå¨ƒ"},{"en":"door","zh":"é–€"},{"en":"drink","zh":"å–"},
  {"en":"duck","zh":"é´¨å­"},{"en":"eat","zh":"åƒ"},{"en":"egg","zh":"è›‹"},{"en":"elephant","zh":"å¤§è±¡"},{"en":"end","zh":"çµæŸ"},
  {"en":"far","zh":"é çš„"},{"en":"fast","zh":"å¿«çš„"},{"en":"father","zh":"çˆ¸çˆ¸"},{"en":"fish","zh":"é­š"},{"en":"five","zh":"äº”"},
  {"en":"find","zh":"å°‹æ‰¾"},{"en":"first","zh":"ç¬¬ä¸€"},{"en":"fix","zh":"ä¿®ç†"},{"en":"flower","zh":"èŠ±"},{"en":"food","zh":"é£Ÿç‰©"},
  {"en":"forget","zh":"å¿˜è¨˜"},{"en":"fork","zh":"å‰å­"},{"en":"gas","zh":"ç“¦æ–¯"},{"en":"girl","zh":"å¥³å­©"},{"en":"game","zh":"éŠæˆ²"},
  {"en":"goat","zh":"å±±ç¾Š"},{"en":"green","zh":"ç¶ è‰²"},{"en":"garden","zh":"èŠ±åœ’"},{"en":"give","zh":"çµ¦äºˆ"},{"en":"go","zh":"å»"},
  {"en":"good","zh":"å¥½çš„"},{"en":"gray","zh":"ç°è‰²"},{"en":"great","zh":"å¾ˆæ£’çš„"},{"en":"hat","zh":"å¸½å­"},{"en":"ham","zh":"ç«è…¿"},
  {"en":"hand","zh":"æ‰‹"},{"en":"happy","zh":"å¿«æ¨‚çš„"},{"en":"hair","zh":"é ­é«®"},{"en":"hard","zh":"å›°é›£"},{"en":"hear","zh":"è½"},
  {"en":"heart","zh":"å¿ƒè‡Ÿ"},{"en":"heat","zh":"ç™¼ç†±"},{"en":"help","zh":"å¹«åŠ©"},{"en":"here","zh":"é€™è£¡"},{"en":"home","zh":"å®¶"},
  {"en":"hot","zh":"ç†±çš„"},{"en":"how","zh":"å¦‚ä½•"},{"en":"I","zh":"æˆ‘"},{"en":"ice","zh":"å†°"},{"en":"in","zh":"åœ¨â€¦è£¡"},
  {"en":"is","zh":"æ˜¯"},{"en":"jam","zh":"æœé†¬"},{"en":"jump","zh":"è·³"},{"en":"key","zh":"é‘°åŒ™"},{"en":"kid","zh":"å°å­©"},
  {"en":"kite","zh":"é¢¨ç®"},{"en":"lake","zh":"æ¹–"},{"en":"lamp","zh":"ç‡ˆ"},{"en":"left","zh":"å·¦é‚Š"},{"en":"leg","zh":"è…¿"},
  {"en":"like","zh":"å–œæ­¡"},{"en":"look","zh":"çœ‹"},{"en":"love","zh":"æ„›"},{"en":"mail","zh":"éƒµä»¶"},{"en":"marker","zh":"å½©è‰²ç­†"},
  {"en":"meat","zh":"è‚‰"},{"en":"milk","zh":"ç‰›å¥¶"},{"en":"moon","zh":"æœˆäº®"},{"en":"mother","zh":"åª½åª½"},{"en":"near","zh":"é è¿‘"},
  {"en":"neck","zh":"è„–å­"},{"en":"need","zh":"éœ€è¦"},{"en":"news","zh":"æ–°è"},{"en":"noon","zh":"ä¸­åˆ"},{"en":"nose","zh":"é¼»å­"},
  {"en":"oil","zh":"æ²¹"},{"en":"old","zh":"è€çš„ï¼›èˆŠçš„"},{"en":"only","zh":"å”¯ä¸€"},{"en":"open","zh":"æ‰“é–‹"},{"en":"orange","zh":"æ©˜å­"},
  {"en":"page","zh":"é "},{"en":"pan","zh":"å¹³åº•é‹"},{"en":"paper","zh":"ç´™"},{"en":"park","zh":"å…¬åœ’"},{"en":"pen","zh":"ç­†"},
  {"en":"pet","zh":"å¯µç‰©"},{"en":"pencil","zh":"é‰›ç­†"},{"en":"pizza","zh":"æ¯”è–©"},{"en":"pot","zh":"é‹å­"},{"en":"pillow","zh":"æ•é ­"},
  {"en":"queen","zh":"çš‡å"},{"en":"question","zh":"å•é¡Œ"},{"en":"quick","zh":"å¿«çš„"},{"en":"rain","zh":"é›¨"},{"en":"read","zh":"é–±è®€"},
  {"en":"red","zh":"ç´…è‰²"},{"en":"right","zh":"å³é‚Š"},{"en":"run","zh":"è·‘"},{"en":"sad","zh":"é›£éçš„"},{"en":"safe","zh":"å®‰å…¨çš„"},
  {"en":"school","zh":"å­¸æ ¡"},{"en":"sea","zh":"æµ·"},{"en":"see","zh":"çœ‹è¦‹"},{"en":"seven","zh":"ä¸ƒ"},{"en":"ship","zh":"èˆ¹"},
  {"en":"shoe","zh":"é‹å­"},{"en":"sing","zh":"å”±æ­Œ"},{"en":"sister","zh":"å§å¦¹"},{"en":"sleep","zh":"ç¡è¦º"},{"en":"small","zh":"å°çš„"},
  {"en":"snow","zh":"é›ª"},{"en":"sun","zh":"å¤ªé™½"},{"en":"swim","zh":"æ¸¸æ³³"},{"en":"table","zh":"æ¡Œå­"},{"en":"tea","zh":"èŒ¶"},
  {"en":"ten","zh":"å"},{"en":"tiger","zh":"è€è™"},{"en":"to","zh":"åˆ°"},{"en":"toy","zh":"ç©å…·"},{"en":"tree","zh":"æ¨¹"},
  {"en":"tub","zh":"æµ´ç¼¸"},{"en":"turtle","zh":"çƒé¾œ"},{"en":"up","zh":"ä¸Šé¢"},{"en":"yellow","zh":"é»ƒè‰²"}
];

/* ===========================
   2) App è¨­å®š
   =========================== */
const TOTAL_LEVELS = 100;
const QUESTIONS_PER_LEVEL = 10;
const MODES = ["A","B","C","D"]; // A è½é¸ä¸­(ä¸é¡¯è‹±), B è‹±é¸ä¸­, C é…å°, D è½æ‹¼å­—

const LS_STATE = "nmpsg_state_v2";
const LS_LOGS  = "nmpsg_logs_v2";

function nowISO(){ return new Date().toISOString(); }
function randInt(n){ return Math.floor(Math.random()*n); }
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function pad2(x){ return String(x).padStart(2,"0"); }
function mmss(ms){
  const s=Math.floor(ms/1000);
  return `${pad2(Math.floor(s/60))}:${pad2(s%60)}`;
}
function safeLower(s){ return String(s||"").trim().toLowerCase(); }

function loadState(){
  const raw = localStorage.getItem(LS_STATE);
  if(raw){ try{return JSON.parse(raw);}catch(e){} }
  return { currentStudent:null, students:{} };
}
function saveState(s){ localStorage.setItem(LS_STATE, JSON.stringify(s)); }
function loadLogs(){
  const raw = localStorage.getItem(LS_LOGS);
  if(raw){ try{return JSON.parse(raw);}catch(e){} }
  return [];
}
function saveLogs(l){ localStorage.setItem(LS_LOGS, JSON.stringify(l)); }

/* ===========================
   3) UI router
   =========================== */
const viewLogin = document.getElementById("view-login");
const viewMap = document.getElementById("view-map");
const viewGame = document.getElementById("view-game");
const viewTeacher = document.getElementById("view-teacher");

function show(view){
  [viewLogin,viewMap,viewGame,viewTeacher].forEach(v=>v.classList.add("hidden"));
  view.classList.remove("hidden");
}
function toast(msg){
  alert(msg);
}

/* ===========================
   4) Student / Progress model
   =========================== */
function ensureStudent(state, name){
  if(!state.students[name]){
    state.students[name] = {
      createdAt: nowISO(),
      lastSeen: nowISO(),
      passed: {},          // {level:true}
      attempts: {},        // {level:count}
      best: {},            // {level:{score,timeMs}}
      lastLevel: 1
    };
  }
  state.students[name].lastSeen = nowISO();
  return state.students[name];
}
function currentStudent(state){
  const n = state.currentStudent;
  if(!n) return null;
  return state.students[n] || null;
}
function maxUnlocked(stu){
  // level1 always unlocked
  let unlocked = 1;
  for(let i=1;i<=TOTAL_LEVELS;i++){
    if(stu.passed[i]) unlocked = Math.min(TOTAL_LEVELS, i+1);
  }
  return Math.min(TOTAL_LEVELS, unlocked);
}

/* ===========================
   5) Speech (TTS)
   =========================== */
function speakEN(word){
  // Use Web Speech API. On iOS Safari, must be triggered by a user click.
  return new Promise((resolve,reject)=>{
    try{
      const u = new SpeechSynthesisUtterance(word);
      u.lang = "en-US";
      u.rate = 0.92;
      u.onend = ()=>resolve();
      u.onerror = ()=>resolve(); // don't block
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }catch(e){ resolve(); }
  });
}

/* ===========================
   6) Level generator (10 questions)
   - æ¯é—œå›ºå®š10é¡Œ
   - æ¨¡å¼éš¨æ©Ÿ
   - å­—ä¸é‡è¤‡ï¼ˆåŒä¸€é—œï¼‰
   =========================== */
function makeLevel(level, attempt){
  // deterministic-ish seed: use level+attempt but still random enough for replay
  // We'll pick 10 unique words:
  let pool = shuffle(WORD_BANK);
  const picked = pool.slice(0, QUESTIONS_PER_LEVEL);

  // Build 10 questions each with random mode
  const qs = [];
  for(let i=0;i<QUESTIONS_PER_LEVEL;i++){
    const w = picked[i];
    const mode = MODES[randInt(MODES.length)];
    qs.push({ idx:i+1, mode, word:w });
  }
  return qs;
}

/* ===========================
   7) Game engine
   =========================== */
let G = {
  level:1, attempt:1, qIndex:0, qs:[],
  score:0, startMs:0, tickTimer:null,
  qStartMs:0,
};

const gLevel = document.getElementById("gLevel");
const gAttempt = document.getElementById("gAttempt");
const gMode = document.getElementById("gMode");
const gTimer = document.getElementById("gTimer");
const barFill = document.getElementById("barFill");
const gameArea = document.getElementById("gameArea");
const nextBtn = document.getElementById("nextBtn");

function startTimer(){
  G.startMs = performance.now();
  if(G.tickTimer) clearInterval(G.tickTimer);
  G.tickTimer = setInterval(()=>{
    const t = performance.now() - G.startMs;
    gTimer.textContent = mmss(t);
  }, 250);
}
function stopTimer(){
  if(G.tickTimer) clearInterval(G.tickTimer);
  G.tickTimer=null;
}
function setProgress(){
  const pct = Math.round((G.qIndex/QUESTIONS_PER_LEVEL)*100);
  barFill.style.width = pct + "%";
}
function logAnswer({student, level, attempt, qIndex, mode, en, zh, correct, ms, extra}){
  const logs = loadLogs();
  logs.push({ts: nowISO(), student, level, attempt, qIndex, mode, en, zh, correct, ms, extra: extra||null});
  saveLogs(logs);
}
function finishLevel(){
  const state = loadState();
  const stu = ensureStudent(state, state.currentStudent);
  const totalMs = performance.now() - G.startMs;

  // best record
  const prev = stu.best[G.level];
  const score = G.score;
  if(!prev || score>prev.score || (score===prev.score && totalMs<prev.timeMs)){
    stu.best[G.level] = { score, timeMs: Math.round(totalMs) };
  }

  // pass rule: 7/10 or above (you can change)
  const passed = (score >= 7);
  if(passed){
    stu.passed[G.level] = true;
    stu.lastLevel = Math.min(TOTAL_LEVELS, G.level+1);
  }else{
    stu.lastLevel = G.level;
  }
  saveState(state);

  // result screen
  gameArea.innerHTML = `
    <div class="center">
      <div style="font-weight:950;font-size:20px">ğŸ‰ ç¬¬ ${G.level} é—œå®Œæˆï¼</div>
      <div class="divider"></div>
      <div style="font-weight:950;font-size:18px">å¾—åˆ†ï¼š${score}/${QUESTIONS_PER_LEVEL}</div>
      <div class="muted" style="font-weight:800;margin-top:6px">æ™‚é–“ï¼š${mmss(totalMs)}</div>
      <div class="divider"></div>
      <div style="font-weight:900;color:${passed?'var(--green)':'var(--red)'}">
        ${passed ? "âœ… é€šé—œæˆåŠŸï¼å·²è§£é–ä¸‹ä¸€é—œ" : "âŒ æœªé€šé—œï¼ˆå»ºè­°å†æŒ‘æˆ°ä¸€æ¬¡ï¼‰"}
      </div>
      <div class="muted" style="font-weight:800;margin-top:8px">æœ¬é—œä»å¯é‡ç©ï¼ˆç¬¬ N æ¬¡æŒ‘æˆ°æœƒå¦å¤–è¨˜éŒ„ï¼‰</div>
      <div class="divider"></div>
      <div class="row" style="justify-content:center">
        <button class="btn ghost" id="retryBtn">ğŸ” é‡ç©æœ¬é—œ</button>
        <button class="btn primary" id="toMapBtn">ğŸ—ºï¸ å›åœ°åœ–</button>
      </div>
    </div>
  `;
  nextBtn.classList.add("hidden");

  document.getElementById("retryBtn").onclick=()=>startGame(G.level, true);
  document.getElementById("toMapBtn").onclick=()=>{ stopTimer(); showMap(); };
}

function startGame(level, forceNewAttempt){
  const state = loadState();
  if(!state.currentStudent){ show(viewLogin); return; }
  const stu = ensureStudent(state, state.currentStudent);

  // attempt count
  const prev = stu.attempts[level] || 0;
  const attempt = forceNewAttempt ? (prev+1) : (prev+1);
  stu.attempts[level] = attempt;
  stu.lastLevel = level;
  saveState(state);

  // init
  G.level = level;
  G.attempt = attempt;
  G.qIndex = 0;
  G.qs = makeLevel(level, attempt);
  G.score = 0;

  gLevel.textContent = level;
  gAttempt.textContent = attempt;
  show(viewGame);
  nextBtn.classList.remove("hidden");
  nextBtn.textContent = "â¡ï¸ ä¸‹ä¸€é¡Œ";
  nextBtn.disabled = true;

  startTimer();
  renderQuestion();
}

function renderQuestion(){
  setProgress();
  nextBtn.disabled = true;
  const q = G.qs[G.qIndex];
  gMode.textContent = `${q.mode} ${modeName(q.mode)}`;
  G.qStartMs = performance.now();

  if(q.mode==="A") renderModeA(q);
  if(q.mode==="B") renderModeB(q);
  if(q.mode==="C") renderModeC(q);
  if(q.mode==="D") renderModeD(q);
}

function modeName(m){
  if(m==="A") return "è½ â†’ é¸ä¸­æ–‡ï¼ˆä¸é¡¯ç¤ºè‹±æ–‡ï¼‰";
  if(m==="B") return "çœ‹è‹±æ–‡ â†’ é¸ä¸­æ–‡";
  if(m==="C") return "è‹±æ–‡ â†” ä¸­æ–‡é…å°";
  if(m==="D") return "è½ â†’ æ‹¼è‹±æ–‡";
  return "";
}

function makeZhOptions(correctZh){
  // 1 correct + 3 distractors
  const zhPool = shuffle(WORD_BANK.map(x=>x.zh).filter(z=>z!==correctZh));
  const opts = shuffle([correctZh, zhPool[0], zhPool[1], zhPool[2]]);
  return opts;
}
function answerCommon({correct, correctText, showCorrectAlso, chosenText}){
  const state = loadState();
  const stuName = state.currentStudent;
  const q = G.qs[G.qIndex];
  const elapsed = performance.now() - G.qStartMs;

  if(correct) G.score += 1;

  logAnswer({
    student: stuName,
    level: G.level,
    attempt: G.attempt,
    qIndex: q.idx,
    mode: q.mode,
    en: q.word.en,
    zh: q.word.zh,
    correct,
    ms: Math.round(elapsed),
    extra: chosenText ? {chosen:chosenText} : null
  });

  // feedback block
  const fb = document.createElement("div");
  fb.className = "center";
  fb.style.marginTop = "12px";
  fb.innerHTML = correct
    ? `<div style="color:var(--green);font-weight:950;font-size:18px">âœ… å°äº†ï¼</div>`
    : `<div style="color:var(--red);font-weight:950;font-size:18px">âŒ éŒ¯äº†</div>
       <div class="muted" style="font-weight:900;margin-top:6px">æ­£ç¢ºç­”æ¡ˆï¼š<span style="color:var(--ink)">${correctText}</span></div>`;
  gameArea.appendChild(fb);

  nextBtn.disabled = false;
  nextBtn.textContent = (G.qIndex===QUESTIONS_PER_LEVEL-1) ? "âœ… çµç®—æœ¬é—œ" : "â¡ï¸ ä¸‹ä¸€é¡Œ";
}

function next(){
  if(G.qIndex===QUESTIONS_PER_LEVEL-1){
    setProgress();
    barFill.style.width="100%";
    stopTimer();
    finishLevel();
    return;
  }
  G.qIndex += 1;
  renderQuestion();
}

nextBtn.onclick = next;

/* ---- Mode A: Listen -> pick Chinese (NO English shown) ---- */
function renderModeA(q){
  const zhOpts = makeZhOptions(q.word.zh);
  gameArea.innerHTML = `
    <div class="center">
      <div class="qTitle">ğŸ”Š</div>
      <p class="helpText">è½è‹±æ–‡å¾Œï¼Œé¸å‡ºæ­£ç¢ºä¸­æ–‡æ„æ€ï¼ˆä¸æœƒé¡¯ç¤ºè‹±æ–‡å–®å­—ï¼‰</p>
      <button class="btn primary bigBtn" id="playBtn">ğŸ”Š æ’­æ”¾</button>
      <div style="height:10px"></div>
      <div class="options" id="opts"></div>
    </div>
  `;
  document.getElementById("playBtn").onclick = ()=>speakEN(q.word.en);
  const opts = document.getElementById("opts");
  zhOpts.forEach(z=>{
    const b = document.createElement("button");
    b.className="opt";
    b.textContent=z;
    b.onclick=()=>{
      const correct = (z===q.word.zh);
      b.classList.add(correct?"correct":"wrong");
      // mark others
      [...opts.children].forEach(x=>x.disabled=true);
      answerCommon({
        correct,
        correctText:`${q.word.zh}ï¼ˆ${q.word.en}ï¼‰`,
        chosenText:z
      });
    };
    opts.appendChild(b);
  });
}

/* ---- Mode B: Show English -> pick Chinese ---- */
function renderModeB(q){
  const zhOpts = makeZhOptions(q.word.zh);
  gameArea.innerHTML = `
    <div class="center">
      <div class="qTitle">${escapeHTML(q.word.en)}</div>
      <p class="helpText">çœ‹è‹±æ–‡ï¼Œé¸å‡ºæ­£ç¢ºä¸­æ–‡æ„æ€</p>
      <div class="options" id="opts"></div>
    </div>
  `;
  const opts = document.getElementById("opts");
  zhOpts.forEach(z=>{
    const b=document.createElement("button");
    b.className="opt";
    b.textContent=z;
    b.onclick=()=>{
      const correct = (z===q.word.zh);
      b.classList.add(correct?"correct":"wrong");
      [...opts.children].forEach(x=>x.disabled=true);
      answerCommon({
        correct,
        correctText:`${q.word.zh}ï¼ˆ${q.word.en}ï¼‰`,
        chosenText:z
      });
    };
    opts.appendChild(b);
  });
}

/* ---- Mode C: Matching 5 pairs (counts as 1 question) ---- */
function renderModeC(q){
  // pick 5 unique words (including current)
  let pool = shuffle(WORD_BANK.filter(w=>w.en!==q.word.en));
  const five = [q.word, ...pool.slice(0,4)];
  const left = shuffle(five.map(w=>({k:w.en, t:w.en, pair:w.zh, side:"L"})));
  const right = shuffle(five.map(w=>({k:w.zh, t:w.zh, pair:w.en, side:"R"})));

  let sel = null;
  let matched = 0;
  let combo = 0;

  gameArea.innerHTML = `
    <div class="center">
      <div style="font-weight:950;font-size:22px;margin-top:6px">ğŸ”— é…å°</div>
      <p class="helpText">æŠŠè‹±æ–‡å’Œä¸­æ–‡é…å°ï¼ˆå®Œæˆ5çµ„ç®—æœ¬é¡Œå®Œæˆï¼‰</p>
      <div class="combo">é€£æ“Šï¼š<span id="combo">0</span></div>
      <div style="height:8px"></div>
      <div class="matchGrid" id="mg"></div>
    </div>
  `;
  const mg = document.getElementById("mg");
  const comboEl = document.getElementById("combo");

  const tiles = [];
  function addTile(obj){
    const d=document.createElement("button");
    d.className="tile";
    d.textContent=obj.t;
    d.dataset.key=obj.k;
    d.dataset.pair=obj.pair;
    d.dataset.side=obj.side;
    d.onclick=()=>{
      if(d.classList.contains("gone")) return;
      if(!sel){
        sel = d;
        d.classList.add("sel");
        return;
      }
      if(sel===d){ sel.classList.remove("sel"); sel=null; return; }

      // must be opposite sides
      if(sel.dataset.side===d.dataset.side){
        sel.classList.remove("sel");
        sel = d;
        d.classList.add("sel");
        return;
      }

      const ok = (sel.dataset.pair===d.dataset.key) && (d.dataset.pair===sel.dataset.key);
      if(ok){
        sel.classList.remove("sel");
        sel.classList.add("gone");
        d.classList.add("gone");
        matched++;
        combo++;
        comboEl.textContent = combo;
        sel = null;
        if(matched===5){
          // correct = true (always, because matching can't "finish wrong")
          answerCommon({
            correct:true,
            correctText:`é…å°å®Œæˆï¼ˆå«ï¼š${q.word.zh}ï¼ˆ${q.word.en}ï¼‰ï¼‰`,
            chosenText:"paired"
          });
        }
      }else{
        // wrong match: show correct hint briefly
        combo=0; comboEl.textContent="0";
        sel.classList.remove("sel");
        const a=sel, b=d;
        a.classList.add("wrong"); b.classList.add("wrong");
        setTimeout(()=>{ a.classList.remove("wrong"); b.classList.remove("wrong"); }, 450);
        sel=null;
        // still can continue; log the mistake without ending the question
        const state = loadState();
        logAnswer({
          student: state.currentStudent,
          level: G.level,
          attempt: G.attempt,
          qIndex: G.qs[G.qIndex].idx,
          mode: "C",
          en: q.word.en,
          zh: q.word.zh,
          correct: false,
          ms: Math.round(performance.now()-G.qStartMs),
          extra: {mistake:`${a.textContent} x ${b.textContent}`}
        });
      }
    };
    mg.appendChild(d);
    tiles.push(d);
  }
  left.forEach(addTile);
  right.forEach(addTile);
}

/* ---- Mode D: Listen -> spell English ---- */
function renderModeD(q){
  gameArea.innerHTML = `
    <div class="center">
      <div class="qTitle">ğŸ”Š</div>
      <p class="helpText">è½è‹±æ–‡ï¼Œæ‹¼å‡ºè‹±æ–‡å–®å­—ï¼ˆä¸çœ‹ç­”æ¡ˆï¼‰</p>
      <button class="btn primary bigBtn" id="playBtn">ğŸ”Š æ’­æ”¾</button>
      <div style="height:10px"></div>
      <div class="spellRow">
        <input class="spellInput" id="spell" placeholder="è¼¸å…¥è‹±æ–‡..." autocomplete="off" autocapitalize="none" />
      </div>
      <div style="height:10px"></div>
      <button class="btn ghost bigBtn" id="checkBtn">âœ… æª¢æŸ¥</button>
    </div>
  `;
  document.getElementById("playBtn").onclick=()=>speakEN(q.word.en);
  const inp=document.getElementById("spell");
  inp.focus();

  document.getElementById("checkBtn").onclick=()=>{
    const typed = safeLower(inp.value);
    const ans = safeLower(q.word.en);
    const correct = (typed===ans);
    answerCommon({
      correct,
      correctText:`${q.word.en}ï¼ˆ${q.word.zh}ï¼‰`,
      chosenText:typed
    });
  };
}

function escapeHTML(s){
  return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

/* ===========================
   8) MAP UI
   =========================== */
const mapGrid = document.getElementById("mapGrid");
const pathSvg = document.getElementById("pathSvg");

function drawMap(){
  const state = loadState();
  const stu = currentStudent(state);
  if(!stu){ show(viewLogin); return; }

  const unlocked = maxUnlocked(stu);
  mapGrid.innerHTML = "";
  // create nodes
  for(let i=1;i<=TOTAL_LEVELS;i++){
    const node = document.createElement("div");
    node.className = "node";
    const isDone = !!stu.passed[i];
    const isNow = (i===unlocked) || (i===1 && !stu.passed[1]);
    const isLock = (i>unlocked);

    if(isDone) node.classList.add("done");
    else if(!isLock) node.classList.add("now");
    else node.classList.add("lock");

    node.textContent = i;
    const badge = document.createElement("div");
    badge.className = "badge";
    const a = stu.attempts[i]||0;
    badge.textContent = a?`x${a}`:"";
    if(!a) badge.style.display="none";
    node.appendChild(badge);

    node.onclick=()=>{
      if(isLock) return;
      startGame(i, true);
    };
    mapGrid.appendChild(node);
  }

  // simple decorative path (optional)
  const rect = mapGrid.getBoundingClientRect();
  pathSvg.setAttribute("viewBox", `0 0 1000 1400`);
  pathSvg.innerHTML = `
    <path d="M120 80 C 420 140, 580 260, 820 340
             S 640 560, 860 640
             S 620 860, 800 980
             S 520 1180, 760 1280"
          fill="none" stroke="#94a3b8" stroke-width="18" stroke-linecap="round" stroke-dasharray="22 22"/>
  `;
}

function showMap(){
  show(viewMap);
  drawMap();
}

/* ===========================
   9) Teacher Dashboard
   =========================== */
function buildTeacher(){
  show(viewTeacher);
  const state = loadState();
  const logs = loadLogs();

  const names = Object.keys(state.students||{});
  document.getElementById("kStudents").textContent = names.length;
  document.getElementById("kLogs").textContent = logs.length;

  let passCount=0;
  names.forEach(n=>{
    const s=state.students[n];
    passCount += Object.keys(s.passed||{}).length;
  });
  document.getElementById("kPass").textContent = passCount;

  const tbody = document.getElementById("stuTable");
  tbody.innerHTML="";
  names.sort((a,b)=> (state.students[b].lastSeen||"").localeCompare(state.students[a].lastSeen||"")).forEach(n=>{
    const s = state.students[n];
    const passed = Object.keys(s.passed||{}).length;
    const last = (s.lastSeen||"").replace("T"," ").slice(0,16);

    // average accuracy best-ish: compute from logs per student
    const l = logs.filter(x=>x.student===n);
    const answered = l.filter(x=>["A","B","D"].includes(x.mode)).length; // C logs include mistakes; still okay
    const correct = l.filter(x=>x.correct===true && ["A","B","D","C"].includes(x.mode)).length;
    const acc = answered? Math.round((correct/answered)*100) : 0;

    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td style="font-weight:900">${escapeHTML(n)}</td>
      <td>${passed} / ${TOTAL_LEVELS}</td>
      <td>${acc}%</td>
      <td>${last || "-"}</td>
      <td><button class="btn small ghost" data-name="${escapeHTML(n)}">æŸ¥çœ‹</button></td>
    `;
    tr.querySelector("button").onclick=()=>openStudent(n);
    tbody.appendChild(tr);
  });

  document.getElementById("stuDetail").classList.add("hidden");
}

function openStudent(name){
  const logs = loadLogs().filter(x=>x.student===name).slice(-30).reverse();
  document.getElementById("stuName").textContent = name;
  const tb=document.getElementById("logTable");
  tb.innerHTML="";
  logs.forEach(x=>{
    const ts = (x.ts||"").replace("T"," ").slice(0,19);
    const q = x.mode==="A" ? "è½é¸ä¸­" : x.mode==="B" ? "çœ‹è‹±é¸ä¸­" : x.mode==="C" ? "é…å°" : "è½æ‹¼å­—";
    const item = x.mode==="A" ? `(ä¸é¡¯è‹±) â†’ ${x.zh}`
               : x.mode==="B" ? `${x.en} â†’ ${x.zh}`
               : x.mode==="D" ? `(è½) â†’ ${x.en} (${x.zh})`
               : `é…å°(å« ${x.en}/${x.zh})`;
    tb.innerHTML += `
      <tr>
        <td>${ts}</td>
        <td>${x.level}</td>
        <td>${x.attempt}</td>
        <td>${q}</td>
        <td>${escapeHTML(item)}</td>
        <td style="font-weight:900;color:${x.correct?'var(--green)':'var(--red)'}">${x.correct?"å°":"éŒ¯"}</td>
      </tr>
    `;
  });
  document.getElementById("stuDetail").classList.remove("hidden");
}

document.getElementById("closeDetailBtn").onclick=()=>document.getElementById("stuDetail").classList.add("hidden");

function exportCSV(){
  const logs = loadLogs();
  const header = ["æ™‚é–“","å­¸ç”Ÿ","é—œå¡","å›åˆ","é¡Œåº","é¡Œå‹","è‹±æ–‡","ä¸­æ–‡","æ˜¯å¦æ­£ç¢º","è€—æ™‚ms","extra"];
  const rows = logs.map(x=>[
    x.ts, x.student, x.level, x.attempt, x.qIndex, x.mode, x.en, x.zh, x.correct, x.ms, JSON.stringify(x.extra||{})
  ]);
  const csv = [header, ...rows].map(r=>r.map(cell=>{
    const s = String(cell??"");
    return `"${s.replace(/"/g,'""')}"`;
  }).join(",")).join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`nmpsg_export_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}
function exportJSON(){
  const payload = {
    exportedAt: nowISO(),
    state: loadState(),
    logs: loadLogs()
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`nmpsg_export_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}
function importJSON(file){
  const reader = new FileReader();
  reader.onload=()=>{
    try{
      const payload = JSON.parse(reader.result);
      if(!payload.state || !payload.logs) throw new Error("æ ¼å¼ä¸å°");
      // merge students
      const local = loadState();
      const incoming = payload.state;
      local.students = local.students || {};
      incoming.students = incoming.students || {};
      Object.keys(incoming.students).forEach(n=>{
        if(!local.students[n]) local.students[n]=incoming.students[n];
        else{
          // merge passed/attempt/best/lastSeen
          local.students[n].passed = Object.assign({}, local.students[n].passed||{}, incoming.students[n].passed||{});
          local.students[n].attempts = Object.assign({}, local.students[n].attempts||{}, incoming.students[n].attempts||{});
          local.students[n].best = Object.assign({}, local.students[n].best||{}, incoming.students[n].best||{});
          local.students[n].lastSeen = (incoming.students[n].lastSeen>local.students[n].lastSeen) ? incoming.students[n].lastSeen : local.students[n].lastSeen;
        }
      });
      saveState(local);

      // merge logs by simple concat (could dedupe by ts+student+level+attempt+qIndex)
      const logs = loadLogs();
      const inLogs = payload.logs || [];
      const key = (x)=> `${x.ts}|${x.student}|${x.level}|${x.attempt}|${x.qIndex}|${x.mode}|${x.correct}`;
      const set = new Set(logs.map(key));
      inLogs.forEach(x=>{
        const k=key(x);
        if(!set.has(k)){ logs.push(x); set.add(k); }
      });
      saveLogs(logs);

      toast("âœ… åŒ¯å…¥å®Œæˆï¼");
      buildTeacher();
    }catch(e){
      toast("âŒ åŒ¯å…¥å¤±æ•—ï¼šJSONæ ¼å¼ä¸æ­£ç¢º");
    }
  };
  reader.readAsText(file);
}

/* ===========================
   10) Header buttons / Tabs
   =========================== */
function refreshHeader(){
  const state = loadState();
  document.getElementById("who").textContent = state.currentStudent || "æœªç™»å…¥";
}
document.getElementById("switchBtn").onclick=()=>{
  show(viewLogin);
  document.getElementById("nameInput").value = "";
};
document.getElementById("teacherBtn").onclick=buildTeacher;

document.getElementById("tabMap").onclick=showMap;
document.getElementById("tabGame").onclick=()=>{
  const state=loadState();
  const stu=currentStudent(state);
  if(!stu){ show(viewLogin); return; }
  startGame(stu.lastLevel||1, true);
};
document.getElementById("tabTeacher").onclick=buildTeacher;

document.getElementById("backToMapBtn").onclick=()=>{ stopTimer(); showMap(); };
document.getElementById("resumeBtn").onclick=()=>{
  const state=loadState();
  const stu=currentStudent(state);
  if(!stu){ show(viewLogin); return; }
  startGame(stu.lastLevel||1, true);
};

document.getElementById("loginBtn").onclick=()=>{
  const name = document.getElementById("nameInput").value.trim();
  if(!name){ toast("è«‹è¼¸å…¥åå­—"); return; }
  const state=loadState();
  state.currentStudent = name;
  ensureStudent(state, name);
  saveState(state);
  refreshHeader();
  showMap();
};

document.getElementById("exportCsvBtn").onclick=exportCSV;
document.getElementById("exportJsonBtn").onclick=exportJSON;
document.getElementById("importJsonFile").onchange=(e)=>{
  const f=e.target.files?.[0];
  if(f) importJSON(f);
  e.target.value="";
};

document.getElementById("wipeBtn").onclick=()=>{
  if(confirm("ç¢ºå®šæ¸…ç©ºæœ¬æ©Ÿæ‰€æœ‰å­¸ç”Ÿ/ç´€éŒ„ï¼Ÿï¼ˆä¸å¯å¾©åŸï¼‰")){
    localStorage.removeItem(LS_STATE);
    localStorage.removeItem(LS_LOGS);
    toast("å·²æ¸…ç©º");
    refreshHeader();
    show(viewLogin);
  }
};

/* ===========================
   11) Boot
   =========================== */
refreshHeader();
(function boot(){
  const state=loadState();
  if(state.currentStudent){
    ensureStudent(state, state.currentStudent);
    saveState(state);
    showMap();
  }else{
    show(viewLogin);
  }
})();

</script>
</body>
</html>
