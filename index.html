<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>å—é–€åœ‹å°æ‹¼å­—æŒ‘æˆ°Go</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --ink:#111827; --muted:#6b7280;
    --blue:#2563eb; --green:#16a34a; --red:#dc2626; --line:#e5e7eb;
    --r:16px; --sh:0 10px 22px rgba(0,0,0,.10);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC",Segoe UI,Roboto,sans-serif}
  .top{position:sticky;top:0;z-index:9;background:rgba(246,247,251,.88);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
  .top .in{max-width:980px;margin:0 auto;padding:10px 14px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:950}
  .sp{flex:1}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-size:13px;color:var(--muted);font-weight:800}
  .wrap{max-width:980px;margin:0 auto;padding:14px 14px 90px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--sh);padding:14px}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted)}
  .btn{border:0;border-radius:14px;padding:12px 14px;font-weight:950;cursor:pointer}
  .btn.primary{background:var(--blue);color:#fff}
  .btn.ghost{background:#fff;border:1px solid var(--line)}
  .btn.small{padding:8px 10px;border-radius:12px;font-size:13px}
  .btn.danger{background:#fff;border:1px solid #fecaca;color:#b91c1c}
  .divider{height:1px;background:var(--line);margin:12px 0}
  .center{text-align:center}
  .hidden{display:none!important}

  /* Map */
  .legend{display:flex;gap:10px;justify-content:center;align-items:center;color:var(--muted);font-weight:900;font-size:13px;margin:8px 0 0}
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
  .dot.done{background:var(--green)} .dot.now{background:var(--blue)} .dot.lock{background:#cbd5e1}
  .map{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:16px;padding:14px}
  .node{
    width:82px;height:82px;border-radius:999px;margin:0 auto;
    display:flex;align-items:center;justify-content:center;
    background:#fff;border:1px solid var(--line);box-shadow:0 10px 20px rgba(0,0,0,.08);
    font-weight:950;font-size:18px;user-select:none;position:relative
  }
  .node.done{background:var(--green);color:#fff;border-color:rgba(255,255,255,.35)}
  .node.now{background:var(--blue);color:#fff;border-color:rgba(255,255,255,.35)}
  .node.lock{opacity:.33}
  .badge{position:absolute;right:-6px;bottom:-6px;background:#fff;border:1px solid var(--line);border-radius:999px;padding:4px 6px;font-size:12px;font-weight:950;color:var(--muted)}
  .node.done .badge,.node.now .badge{background:rgba(255,255,255,.95)}
  /* Game */
  .hud{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  .bar{height:12px;border-radius:999px;background:#e5e7eb;overflow:hidden;flex:1;min-width:220px}
  .bar>div{height:100%;width:0%;background:var(--green)}
  .timer{font-weight:950;color:var(--red)}
  .modeTag{border:1px solid #c7d2fe;background:#eef2ff;color:#3730a3;border-radius:999px;padding:6px 10px;font-weight:950}
  .qBig{font-size:36px;font-weight:950;margin:10px 0 4px}
  .help{margin:0 0 10px;color:var(--muted);font-weight:900}
  .opts{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .opt{
    border:1px solid var(--line);background:#fff;border-radius:16px;padding:14px;
    font-weight:950;font-size:18px;cursor:pointer;box-shadow:0 8px 16px rgba(0,0,0,.06)
  }
  .opt:active{transform:scale(.99)}
  .opt.correct{border-color:#86efac;background:#ecfdf5}
  .opt.wrong{border-color:#fecaca;background:#fef2f2}
  .hint{margin-top:10px;font-weight:950;font-size:18px}
  .ok{color:var(--green)} .bad{color:var(--red)}
  .input{width:100%;border:1px solid var(--line);border-radius:16px;padding:14px;font-size:18px;font-weight:950}
  .speedBox{margin-top:8px;text-align:center;font-size:13px;color:var(--muted);font-weight:900}
  .speedBox input{width:170px;vertical-align:middle}
  .match{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .tile{
    border:1px solid var(--line);background:#fff;border-radius:16px;padding:14px;
    font-weight:950;font-size:18px;cursor:pointer;box-shadow:0 8px 16px rgba(0,0,0,.06)
  }
  .tile.sel{outline:3px solid #93c5fd}
  .tile.gone{opacity:.15;pointer-events:none}
  /* Teacher */
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;font-size:13px}
  th{color:var(--muted)}
  .kpi{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  .box{border:1px solid var(--line);background:#fff;border-radius:16px;padding:12px}
  .num{font-weight:950;font-size:20px}
  .lbl{color:var(--muted);font-weight:900;font-size:12px}

  /* Bottom nav */
  .nav{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:center;padding:10px;z-index:10}
  .nav .tab{flex:1;max-width:240px}
  .nav .btn{width:100%}
</style>
</head>

<body>
<div class="top">
  <div class="in">
    <div class="brand">ğŸ« å—é–€åœ‹å°æ‹¼å­—æŒ‘æˆ°Go</div>
    <div class="sp"></div>
    <div class="pill">ğŸ‘§ğŸ‘¦ <span id="who">æœªç™»å…¥</span></div>
    <button class="btn small ghost" id="switchBtn">åˆ‡æ›/ç™»å…¥</button>
    <button class="btn small ghost" id="teacherBtn">ğŸ‘©â€ğŸ« è€å¸«å¾Œå°</button>
  </div>
</div>

<div class="wrap">

  <!-- LOGIN -->
  <section id="vLogin" class="grid">
    <div class="card">
      <div class="center">
        <div style="font-weight:950;font-size:22px">é–‹å§‹æŒ‘æˆ°ï¼</div>
        <div class="muted" style="font-weight:900;margin-top:6px">è¼¸å…¥åå­—å³å¯éŠç©ï¼ˆåŒä¸€å°å¯å¤šä½å­¸ç”Ÿåˆ‡æ›ï¼‰</div>
      </div>
      <div class="divider"></div>
      <input id="nameInput" class="input" placeholder="ä¾‹å¦‚ï¼šå°æ˜ / Emma" autocomplete="off">
      <button class="btn primary" id="loginBtn">âœ… é€²å…¥åœ°åœ–</button>
      <div class="muted" style="font-weight:900;font-size:13px;line-height:1.5">
        â€» ç´”å‰ç«¯ç‰ˆæœ¬ï¼šä¸åŒæ‰‹æ©Ÿä¸æœƒè‡ªå‹•åŒæ­¥ã€‚è€å¸«å¯ç”¨ã€ŒåŒ¯å‡º/åŒ¯å…¥ JSONã€å½™æ•´å¤šå°è³‡æ–™ã€‚
      </div>
    </div>
  </section>

  <!-- MAP -->
  <section id="vMap" class="grid hidden">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:950;font-size:18px">ğŸ—ºï¸ é—œå¡åœ°åœ–ï¼ˆ100é—œï¼‰</div>
          <div class="muted" style="font-weight:900;font-size:13px">æ¯é—œ 10 é¡Œï¼›A/B/C/D éš¨æ©Ÿï¼›é€šé—œè§£é–ä¸‹ä¸€é—œï¼›å·²é€šé—œå¯é‡ç©ã€‚</div>
        </div>
        <button class="btn ghost" id="resumeBtn">â–¶ï¸ çºŒç©æœ€å¾Œä¸€é—œ</button>
      </div>

      <div class="legend">
        <span class="dot done"></span>å·²é€šé—œ
        <span class="dot now"></span>å¯æŒ‘æˆ°
        <span class="dot lock"></span>æœªè§£é–
      </div>

      <div class="map" id="mapGrid"></div>
    </div>
  </section>

  <!-- GAME -->
  <section id="vGame" class="grid hidden">
    <div class="card">
      <div class="hud">
        <div class="row">
          <span class="pill">ğŸ¯ ç¬¬ <span id="gLevel">1</span> é—œ</span>
          <span class="pill">ğŸ” ç¬¬ <span id="gAttempt">1</span> æ¬¡</span>
          <span class="modeTag" id="gMode">A</span>
        </div>
        <div class="bar"><div id="barFill"></div></div>
        <div class="pill">â±ï¸ <span class="timer" id="gTimer">00:00</span></div>
      </div>

      <div class="divider"></div>
      <div id="gameArea"></div>

      <div class="divider"></div>
      <div class="row" style="justify-content:space-between">
        <button class="btn ghost" id="backToMapBtn">â¬…ï¸ å›åœ°åœ–</button>
        <button class="btn primary" id="nextBtn" disabled>â¡ï¸ ä¸‹ä¸€é¡Œ</button>
      </div>
    </div>
  </section>

  <!-- TEACHER -->
  <section id="vTeacher" class="grid hidden">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:950;font-size:18px">ğŸ‘©â€ğŸ« è€å¸«å¾Œå°</div>
          <div class="muted" style="font-weight:900;font-size:13px">æœ¬é è®€å–ã€Œé€™å°è£ç½®ã€è³‡æ–™ï¼›å¯åŒ¯å‡ºCSVã€åŒ¯å…¥/åŒ¯å‡ºJSONå½™æ•´å…¶ä»–æ‰‹æ©Ÿè³‡æ–™ã€‚</div>
        </div>
        <button class="btn danger" id="wipeBtn">æ¸…ç©ºæœ¬æ©Ÿè³‡æ–™</button>
      </div>

      <div class="divider"></div>

      <div class="kpi">
        <div class="box"><div class="num" id="kStudents">0</div><div class="lbl">å­¸ç”Ÿæ•¸ï¼ˆæœ¬æ©Ÿï¼‰</div></div>
        <div class="box"><div class="num" id="kLogs">0</div><div class="lbl">ä½œç­”ç´€éŒ„ç­†æ•¸</div></div>
        <div class="box"><div class="num" id="kPass">0</div><div class="lbl">é€šé—œç¸½æ•¸ï¼ˆç´¯è¨ˆï¼‰</div></div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn primary" id="exportCsvBtn">ğŸ“¤ åŒ¯å‡º Excelï¼ˆCSVï¼‰</button>
        <button class="btn ghost" id="exportJsonBtn">ğŸ“¦ åŒ¯å‡º JSONï¼ˆå½™æ•´ï¼‰</button>
        <label class="btn ghost" style="cursor:pointer">
          ğŸ“¥ åŒ¯å…¥ JSON
          <input type="file" id="importJsonFile" accept="application/json" style="display:none">
        </label>
      </div>

      <div class="divider"></div>

      <div class="row" style="justify-content:space-between">
        <div style="font-weight:950">å­¸ç”Ÿé€²åº¦ç¸½è¦½</div>
        <div class="muted" style="font-weight:900;font-size:13px">é»ã€ŒæŸ¥çœ‹ã€é¡¯ç¤ºè¿‘ 30 ç­†ç´€éŒ„</div>
      </div>

      <table>
        <thead><tr>
          <th>å­¸ç”Ÿ</th><th>å·²é€šé—œ</th><th>ä¼°è¨ˆæ­£ç¢ºç‡</th><th>æœ€å¾ŒéŠç©</th><th></th>
        </tr></thead>
        <tbody id="stuTable"></tbody>
      </table>

      <div class="divider"></div>

      <div id="stuDetail" class="hidden">
        <div class="row" style="justify-content:space-between">
          <div style="font-weight:950">ğŸ“Œ æ˜ç´°ï¼š<span id="stuName"></span></div>
          <button class="btn ghost small" id="closeDetailBtn">é—œé–‰</button>
        </div>
        <div class="divider"></div>
        <table>
          <thead><tr>
            <th>æ™‚é–“</th><th>é—œå¡</th><th>å›åˆ</th><th>é¡Œå‹</th><th>é¡Œç›®</th><th>çµæœ</th>
          </tr></thead>
          <tbody id="logTable"></tbody>
        </table>
      </div>

    </div>
  </section>

</div>

<div class="nav">
  <div class="tab"><button class="btn ghost" id="tabMap">ğŸ—ºï¸ åœ°åœ–</button></div>
  <div class="tab"><button class="btn ghost" id="tabGame">ğŸ® é—œå¡</button></div>
  <div class="tab"><button class="btn ghost" id="tabTeacher">ğŸ‘©â€ğŸ« è€å¸«</button></div>
</div>

<script>
/* =========================
   153 å­—å®Œæ•´é¡Œåº«
   ========================= */
const WORD_BANK = [
  {"en":"able","zh":"èƒ½å¤ "},{"en":"all","zh":"æ‰€æœ‰"},{"en":"after","zh":"åœ¨â€¦ä¹‹å¾Œ"},{"en":"and","zh":"å’Œ"},{"en":"any","zh":"ä»»ä½•"},
  {"en":"ant","zh":"èèŸ»"},{"en":"apple","zh":"è˜‹æœ"},{"en":"April","zh":"å››æœˆ"},{"en":"ask","zh":"å•"},{"en":"at","zh":"åœ¨"},
  {"en":"baby","zh":"å¬°å…’"},{"en":"back","zh":"èƒŒé¢ï¼›å›"},{"en":"ball","zh":"çƒ"},{"en":"banana","zh":"é¦™è•‰"},{"en":"baseball","zh":"æ£’çƒ"},
  {"en":"basket","zh":"ç±ƒå­"},{"en":"bat","zh":"çƒæ£’ï¼›è™è "},{"en":"be","zh":"æ˜¯"},{"en":"bear","zh":"ç†Š"},{"en":"bee","zh":"èœœèœ‚"},
  {"en":"bell","zh":"éˆ´"},{"en":"big","zh":"å¤§çš„"},{"en":"bird","zh":"é³¥"},{"en":"black","zh":"é»‘è‰²"},{"en":"blue","zh":"è—è‰²"},
  {"en":"boat","zh":"èˆ¹"},{"en":"book","zh":"æ›¸"},{"en":"boy","zh":"ç”·å­©"},{"en":"bread","zh":"éºµåŒ…"},{"en":"break","zh":"æ–·è£‚ï¼›æš«åœ"},
  {"en":"brother","zh":"å…„å¼Ÿ"},{"en":"cake","zh":"è›‹ç³•"},{"en":"cap","zh":"æ£’çƒå¸½"},{"en":"camp","zh":"ç‡Ÿåœ°ï¼›å¸³ç¯·"},{"en":"card","zh":"å¡ç‰‡"},
  {"en":"candy","zh":"ç³–æœ"},{"en":"care","zh":"é—œæ‡·ï¼›ç…§é¡§"},{"en":"catch","zh":"æŠ“"},{"en":"chair","zh":"æ¤…å­"},{"en":"chalk","zh":"ç²‰ç­†"},
  {"en":"check","zh":"æ‰“å‹¾ï¼›ç¢ºèª"},{"en":"cool","zh":"æ¶¼çˆ½çš„;é…·"},{"en":"child","zh":"å°å­©"},{"en":"circle","zh":"åœ“"},{"en":"coffee","zh":"å’–å•¡"},
  {"en":"cup","zh":"æ¯å­"},{"en":"cute","zh":"å¯æ„›çš„"},{"en":"dark","zh":"é»‘æš—çš„"},{"en":"dance","zh":"è·³èˆ"},{"en":"dear","zh":"è¦ªæ„›çš„"},
  {"en":"desk","zh":"æ¡Œå­"},{"en":"dog","zh":"ç‹—"},{"en":"doll","zh":"å¨ƒå¨ƒ"},{"en":"door","zh":"é–€"},{"en":"drink","zh":"å–"},
  {"en":"duck","zh":"é´¨å­"},{"en":"eat","zh":"åƒ"},{"en":"egg","zh":"è›‹"},{"en":"elephant","zh":"å¤§è±¡"},{"en":"end","zh":"çµæŸ"},
  {"en":"far","zh":"é çš„"},{"en":"fast","zh":"å¿«çš„"},{"en":"father","zh":"çˆ¸çˆ¸"},{"en":"fish","zh":"é­š"},{"en":"five","zh":"äº”"},
  {"en":"find","zh":"å°‹æ‰¾"},{"en":"first","zh":"ç¬¬ä¸€"},{"en":"fix","zh":"ä¿®ç†"},{"en":"flower","zh":"èŠ±"},{"en":"food","zh":"é£Ÿç‰©"},
  {"en":"forget","zh":"å¿˜è¨˜"},{"en":"fork","zh":"å‰å­"},{"en":"gas","zh":"ç“¦æ–¯"},{"en":"girl","zh":"å¥³å­©"},{"en":"game","zh":"éŠæˆ²"},
  {"en":"goat","zh":"å±±ç¾Š"},{"en":"green","zh":"ç¶ è‰²"},{"en":"garden","zh":"èŠ±åœ’"},{"en":"give","zh":"çµ¦äºˆ"},{"en":"go","zh":"å»"},
  {"en":"good","zh":"å¥½çš„"},{"en":"gray","zh":"ç°è‰²"},{"en":"great","zh":"å¾ˆæ£’çš„"},{"en":"hat","zh":"å¸½å­"},{"en":"ham","zh":"ç«è…¿"},
  {"en":"hand","zh":"æ‰‹"},{"en":"happy","zh":"å¿«æ¨‚çš„"},{"en":"hair","zh":"é ­é«®"},{"en":"hard","zh":"å›°é›£"},{"en":"hear","zh":"è½"},
  {"en":"heart","zh":"å¿ƒè‡Ÿ"},{"en":"heat","zh":"ç™¼ç†±"},{"en":"help","zh":"å¹«åŠ©"},{"en":"here","zh":"é€™è£¡"},{"en":"home","zh":"å®¶"},
  {"en":"hot","zh":"ç†±çš„"},{"en":"how","zh":"å¦‚ä½•"},{"en":"I","zh":"æˆ‘"},{"en":"ice","zh":"å†°"},{"en":"in","zh":"åœ¨â€¦è£¡"},
  {"en":"is","zh":"æ˜¯"},{"en":"jam","zh":"æœé†¬"},{"en":"jump","zh":"è·³"},{"en":"key","zh":"é‘°åŒ™"},{"en":"kid","zh":"å°å­©"},
  {"en":"kite","zh":"é¢¨ç®"},{"en":"lake","zh":"æ¹–"},{"en":"lamp","zh":"ç‡ˆ"},{"en":"left","zh":"å·¦é‚Š"},{"en":"leg","zh":"è…¿"},
  {"en":"like","zh":"å–œæ­¡"},{"en":"look","zh":"çœ‹"},{"en":"love","zh":"æ„›"},{"en":"mail","zh":"éƒµä»¶"},{"en":"marker","zh":"å½©è‰²ç­†"},
  {"en":"meat","zh":"è‚‰"},{"en":"milk","zh":"ç‰›å¥¶"},{"en":"moon","zh":"æœˆäº®"},{"en":"mother","zh":"åª½åª½"},{"en":"near","zh":"é è¿‘"},
  {"en":"neck","zh":"è„–å­"},{"en":"need","zh":"éœ€è¦"},{"en":"news","zh":"æ–°è"},{"en":"noon","zh":"ä¸­åˆ"},{"en":"nose","zh":"é¼»å­"},
  {"en":"oil","zh":"æ²¹"},{"en":"old","zh":"è€çš„ï¼›èˆŠçš„"},{"en":"only","zh":"å”¯ä¸€"},{"en":"open","zh":"æ‰“é–‹"},{"en":"orange","zh":"æ©˜å­"},
  {"en":"page","zh":"é "},{"en":"pan","zh":"å¹³åº•é‹"},{"en":"paper","zh":"ç´™"},{"en":"park","zh":"å…¬åœ’"},{"en":"pen","zh":"ç­†"},
  {"en":"pet","zh":"å¯µç‰©"},{"en":"pencil","zh":"é‰›ç­†"},{"en":"pizza","zh":"æ¯”è–©"},{"en":"pot","zh":"é‹å­"},{"en":"pillow","zh":"æ•é ­"},
  {"en":"queen","zh":"çš‡å"},{"en":"question","zh":"å•é¡Œ"},{"en":"quick","zh":"å¿«çš„"},{"en":"rain","zh":"é›¨"},{"en":"read","zh":"é–±è®€"},
  {"en":"red","zh":"ç´…è‰²"},{"en":"right","zh":"å³é‚Š"},{"en":"run","zh":"è·‘"},{"en":"sad","zh":"é›£éçš„"},{"en":"safe","zh":"å®‰å…¨çš„"},
  {"en":"school","zh":"å­¸æ ¡"},{"en":"sea","zh":"æµ·"},{"en":"see","zh":"çœ‹è¦‹"},{"en":"seven","zh":"ä¸ƒ"},{"en":"ship","zh":"èˆ¹"},
  {"en":"shoe","zh":"é‹å­"},{"en":"sing","zh":"å”±æ­Œ"},{"en":"sister","zh":"å§å¦¹"},{"en":"sleep","zh":"ç¡è¦º"},{"en":"small","zh":"å°çš„"},
  {"en":"snow","zh":"é›ª"},{"en":"sun","zh":"å¤ªé™½"},{"en":"swim","zh":"æ¸¸æ³³"},{"en":"table","zh":"æ¡Œå­"},{"en":"tea","zh":"èŒ¶"},
  {"en":"ten","zh":"å"},{"en":"tiger","zh":"è€è™"},{"en":"to","zh":"åˆ°"},{"en":"toy","zh":"ç©å…·"},{"en":"tree","zh":"æ¨¹"},
  {"en":"tub","zh":"æµ´ç¼¸"},{"en":"turtle","zh":"çƒé¾œ"},{"en":"up","zh":"ä¸Šé¢"},{"en":"yellow","zh":"é»ƒè‰²"}
];

/* =========================
   è¨­å®š
   ========================= */
const TOTAL_LEVELS = 100;
const QUESTIONS_PER_LEVEL = 10;
const MODES = ["A","B","C","D"];

const LS_STATE = "nmpsg_state_v3";
const LS_LOGS  = "nmpsg_logs_v3";

/* =========================
   å·¥å…·
   ========================= */
const $ = (id)=>document.getElementById(id);
const nowISO = ()=> new Date().toISOString();
const pad2 = (x)=> String(x).padStart(2,"0");
const mmss = (ms)=>{ const s=Math.floor(ms/1000); return `${pad2(Math.floor(s/60))}:${pad2(s%60)}`; };
const safeLower=(s)=>String(s||"").trim().toLowerCase();
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function toast(msg){ alert(msg); }
function esc(s){ return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

/* =========================
   ç‹€æ…‹/ç´€éŒ„
   ========================= */
function loadState(){
  const raw=localStorage.getItem(LS_STATE);
  if(raw){ try{return JSON.parse(raw);}catch(e){} }
  return { currentStudent:null, students:{} };
}
function saveState(s){ localStorage.setItem(LS_STATE, JSON.stringify(s)); }
function loadLogs(){
  const raw=localStorage.getItem(LS_LOGS);
  if(raw){ try{return JSON.parse(raw);}catch(e){} }
  return [];
}
function saveLogs(l){ localStorage.setItem(LS_LOGS, JSON.stringify(l)); }

function ensureStudent(state, name){
  if(!state.students[name]){
    state.students[name]={
      createdAt:nowISO(), lastSeen:nowISO(),
      passed:{}, attempts:{}, best:{}, lastLevel:1
    };
  }
  state.students[name].lastSeen=nowISO();
  return state.students[name];
}
function currentStudentObj(state){
  const n=state.currentStudent;
  if(!n) return null;
  return state.students[n]||null;
}
function maxUnlocked(stu){
  let unlocked=1;
  for(let i=1;i<=TOTAL_LEVELS;i++){
    if(stu.passed[i]) unlocked=Math.min(TOTAL_LEVELS, i+1);
  }
  return Math.min(TOTAL_LEVELS, unlocked);
}

/* =========================
   ç™¼éŸ³ï¼ˆæœ€æ¸…æ¥šç‰ˆ + å‰å°èª¿é€Ÿï¼‰
   ========================= */
let SPEECH_RATE = Number(localStorage.getItem("speechRate")) || 0.65;
function pickVoice(){
  const voices = speechSynthesis.getVoices();
  return (
    voices.find(v=>v.lang==="en-US" && v.name.includes("Samantha")) ||
    voices.find(v=>v.lang==="en-US" && /female|woman/i.test(v.name)) ||
    voices.find(v=>v.lang==="en-US") ||
    voices[0]
  );
}
function speakEN(word){
  const voice = pickVoice();
  const slow = new SpeechSynthesisUtterance(word);
  slow.voice=voice; slow.lang="en-US";
  slow.rate=SPEECH_RATE; slow.pitch=1.0; slow.volume=1.0;

  const normal = new SpeechSynthesisUtterance(word);
  normal.voice=voice; normal.lang="en-US";
  normal.rate=Math.min(SPEECH_RATE+0.2, 1.2);
  normal.pitch=1.0; normal.volume=1.0;

  speechSynthesis.cancel();
  speechSynthesis.speak(slow);
  speechSynthesis.speak(normal);
}

/* =========================
   é—œå¡ç”Ÿæˆï¼ˆæ¯é—œå›ºå®š10é¡Œã€åŒé—œä¸é‡è¤‡å­—ï¼‰
   ========================= */
function makeLevelQuestions(level, attempt){
  const picked = shuffle(WORD_BANK).slice(0, QUESTIONS_PER_LEVEL);
  const qs=[];
  for(let i=0;i<QUESTIONS_PER_LEVEL;i++){
    qs.push({idx:i+1, mode: MODES[Math.floor(Math.random()*MODES.length)], word: picked[i]});
  }
  return qs;
}

/* =========================
   Router
   ========================= */
const vLogin=$("vLogin"), vMap=$("vMap"), vGame=$("vGame"), vTeacher=$("vTeacher");
function show(view){
  [vLogin,vMap,vGame,vTeacher].forEach(v=>v.classList.add("hidden"));
  view.classList.remove("hidden");
}
function refreshHeader(){
  const state=loadState();
  $("who").textContent = state.currentStudent || "æœªç™»å…¥";
}

/* =========================
   åœ°åœ–
   ========================= */
function drawMap(){
  const state=loadState();
  const stu=currentStudentObj(state);
  if(!stu){ show(vLogin); return; }

  const unlocked=maxUnlocked(stu);
  const grid=$("mapGrid");
  grid.innerHTML="";

  for(let i=1;i<=TOTAL_LEVELS;i++){
    const node=document.createElement("div");
    node.className="node";
    const isDone=!!stu.passed[i];
    const isLock=i>unlocked;
    const isNow=(!isDone && !isLock);
    if(isDone) node.classList.add("done");
    else if(isNow) node.classList.add("now");
    else node.classList.add("lock");

    node.textContent=i;

    const a=stu.attempts[i]||0;
    const badge=document.createElement("div");
    badge.className="badge";
    badge.textContent=`x${a}`;
    if(!a) badge.style.display="none";
    node.appendChild(badge);

    node.onclick=()=>{
      if(isLock) return;
      startGame(i);
    };
    grid.appendChild(node);
  }
}
function showMap(){
  show(vMap);
  drawMap();
}

/* =========================
   éŠæˆ²å¼•æ“
   ========================= */
const gLevel=$("gLevel"), gAttempt=$("gAttempt"), gMode=$("gMode");
const gTimer=$("gTimer"), barFill=$("barFill"), gameArea=$("gameArea"), nextBtn=$("nextBtn");

let G = { level:1, attempt:1, qs:[], qIndex:0, score:0, startMs:0, tick:null, qStartMs:0, locked:false };

function startTimer(){
  G.startMs=performance.now();
  if(G.tick) clearInterval(G.tick);
  G.tick=setInterval(()=>{ gTimer.textContent=mmss(performance.now()-G.startMs); }, 250);
}
function stopTimer(){ if(G.tick) clearInterval(G.tick); G.tick=null; }
function setProgress(){
  const pct=Math.round((G.qIndex/QUESTIONS_PER_LEVEL)*100);
  barFill.style.width=pct+"%";
}
function logAnswer(entry){
  const logs=loadLogs();
  logs.push(entry);
  saveLogs(logs);
}

function modeName(m){
  if(m==="A") return "A è½â†’é¸ä¸­æ–‡ï¼ˆä¸é¡¯è‹±ï¼‰";
  if(m==="B") return "B çœ‹è‹±â†’é¸ä¸­æ–‡";
  if(m==="C") return "C è‹±ä¸­é…å°";
  if(m==="D") return "D è½â†’æ‹¼è‹±æ–‡";
  return m;
}

function startGame(level){
  const state=loadState();
  if(!state.currentStudent){ show(vLogin); return; }
  const stu=ensureStudent(state, state.currentStudent);

  const prev=stu.attempts[level]||0;
  stu.attempts[level]=prev+1;
  stu.lastLevel=level;
  saveState(state);

  G.level=level;
  G.attempt=stu.attempts[level];
  G.qs=makeLevelQuestions(level, G.attempt);
  G.qIndex=0;
  G.score=0;
  G.locked=false;

  gLevel.textContent=level;
  gAttempt.textContent=G.attempt;

  show(vGame);
  nextBtn.disabled=true;
  nextBtn.textContent="â¡ï¸ ä¸‹ä¸€é¡Œ";
  startTimer();
  renderQuestion();
}

function finishLevel(){
  stopTimer();
  const state=loadState();
  const stu=ensureStudent(state, state.currentStudent);
  const totalMs=Math.round(performance.now()-G.startMs);

  // best
  const prev=stu.best[G.level];
  if(!prev || G.score>prev.score || (G.score===prev.score && totalMs<prev.timeMs)){
    stu.best[G.level]={score:G.score,timeMs:totalMs};
  }

  const passed = (G.score>=7); // å¯è‡ªè¡Œèª¿æ•´é€šé—œé–€æª»
  if(passed){
    stu.passed[G.level]=true;
    stu.lastLevel=Math.min(TOTAL_LEVELS, G.level+1);
  }else{
    stu.lastLevel=G.level;
  }
  saveState(state);

  barFill.style.width="100%";
  const color=passed?"var(--green)":"var(--red)";
  gameArea.innerHTML=`
    <div class="center">
      <div style="font-weight:950;font-size:22px">ğŸ‰ ç¬¬ ${G.level} é—œå®Œæˆ</div>
      <div class="divider"></div>
      <div style="font-weight:950;font-size:18px">å¾—åˆ†ï¼š${G.score}/${QUESTIONS_PER_LEVEL}</div>
      <div class="muted" style="font-weight:900;margin-top:6px">æ™‚é–“ï¼š${mmss(totalMs)}</div>
      <div class="divider"></div>
      <div style="font-weight:950;color:${color}">${passed?"âœ… é€šé—œæˆåŠŸï¼å·²è§£é–ä¸‹ä¸€é—œ":"âŒ æœªé€šé—œï¼ˆå»ºè­°å†æŒ‘æˆ°ä¸€æ¬¡ï¼‰"}</div>
      <div class="muted" style="font-weight:900;margin-top:8px">æœ¬é—œå¯é‡ç©ï¼ˆç¬¬ N æ¬¡æœƒå¦å¤–è¨˜éŒ„ï¼‰</div>
      <div class="divider"></div>
      <div class="row" style="justify-content:center">
        <button class="btn ghost" id="retryBtn">ğŸ” é‡ç©æœ¬é—œ</button>
        <button class="btn primary" id="toMapBtn">ğŸ—ºï¸ å›åœ°åœ–</button>
      </div>
    </div>
  `;
  nextBtn.disabled=true;
  $("retryBtn").onclick=()=>startGame(G.level);
  $("toMapBtn").onclick=()=>showMap();
}

function next(){
  if(G.locked) return; // é˜²èª¤è§¸
  if(G.qIndex>=QUESTIONS_PER_LEVEL-1){
    finishLevel();
    return;
  }
  G.qIndex++;
  renderQuestion();
}

nextBtn.onclick=next;

function makeZhOptions(correctZh){
  const pool=shuffle(WORD_BANK.map(w=>w.zh).filter(z=>z!==correctZh));
  const opts=shuffle([correctZh,pool[0],pool[1],pool[2]]);
  return opts;
}

function answerFeedback(correct, correctText, chosenText){
  const state=loadState();
  const q=G.qs[G.qIndex];
  const elapsed=Math.round(performance.now()-G.qStartMs);

  if(correct) G.score++;

  logAnswer({
    ts: nowISO(),
    student: state.currentStudent,
    level: G.level,
    attempt: G.attempt,
    qIndex: q.idx,
    mode: q.mode,
    en: q.word.en,
    zh: q.word.zh,
    correct,
    ms: elapsed,
    extra: chosenText ? {chosen: chosenText} : null
  });

  const hint=document.createElement("div");
  hint.className="hint "+(correct?"ok":"bad");
  hint.innerHTML = correct ? "âœ… ç­”å°ï¼" : `âŒ éŒ¯äº†ï¼Œæ­£ç¢ºç­”æ¡ˆï¼š<span style="color:var(--ink)">${esc(correctText)}</span>`;
  gameArea.appendChild(hint);

  nextBtn.disabled=false;
  nextBtn.textContent = (G.qIndex===QUESTIONS_PER_LEVEL-1) ? "âœ… çµç®—æœ¬é—œ" : "â¡ï¸ ä¸‹ä¸€é¡Œ";
  G.locked=true;
  setTimeout(()=>{ G.locked=false; }, 250);
}

/* ----------- å››ç¨®é¡Œå‹æ¸²æŸ“ ----------- */
function renderQuestion(){
  setProgress();
  nextBtn.disabled=true;

  const q=G.qs[G.qIndex];
  gMode.textContent = modeName(q.mode);
  G.qStartMs=performance.now();

  if(q.mode==="A") renderA(q);
  if(q.mode==="B") renderB(q);
  if(q.mode==="C") renderC(q);
  if(q.mode==="D") renderD(q);
}

/* Aï¼šè½â†’é¸ä¸­æ–‡ï¼ˆä¸é¡¯ç¤ºè‹±æ–‡ï¼‰ */
function renderA(q){
  const opts=makeZhOptions(q.word.zh);
  gameArea.innerHTML=`
    <div class="center">
      <div class="qBig">ğŸ”Š</div>
      <p class="help">è½è‹±æ–‡å¾Œï¼Œé¸å‡ºæ­£ç¢ºä¸­æ–‡æ„æ€ï¼ˆä¸æœƒé¡¯ç¤ºè‹±æ–‡å–®å­—ï¼‰</p>
      <button class="btn primary" id="playBtn">ğŸ”Š æ’­æ”¾</button>
      <div class="speedBox">
        ğŸšï¸ ç™¼éŸ³é€Ÿåº¦
        <input type="range" id="speechRate" min="0.5" max="1.1" step="0.05">
        <span id="rateLabel"></span>
      </div>
      <div style="height:10px"></div>
      <div class="opts" id="opts"></div>
    </div>
  `;
  $("playBtn").onclick=()=>speakEN(q.word.en);
  wireSpeechRateUI();
  const box=$("opts");
  opts.forEach(z=>{
    const b=document.createElement("button");
    b.className="opt";
    b.textContent=z;
    b.onclick=()=>{
      [...box.children].forEach(x=>x.disabled=true);
      const correct=(z===q.word.zh);
      b.classList.add(correct?"correct":"wrong");
      // A æ¨¡å¼éŒ¯äº†ä¸é¡¯ç¤ºè‹±æ–‡åœ¨é¡Œé¢ï¼Œä½†æ­£ç¢ºç­”æ¡ˆå€å¯ç”¨ï¼ˆä½ åŒæ„é¡¯ç¤ºæ­£è§£å³å¯ï¼‰
      answerFeedback(correct, q.word.zh, z);
    };
    box.appendChild(b);
  });
}

/* Bï¼šçœ‹è‹±æ–‡â†’é¸ä¸­æ–‡ */
function renderB(q){
  const opts=makeZhOptions(q.word.zh);
  gameArea.innerHTML=`
    <div class="center">
      <div class="qBig">${esc(q.word.en)}</div>
      <p class="help">çœ‹è‹±æ–‡ï¼Œé¸å‡ºæ­£ç¢ºä¸­æ–‡æ„æ€</p>
      <div class="opts" id="opts"></div>
    </div>
  `;
  const box=$("opts");
  opts.forEach(z=>{
    const b=document.createElement("button");
    b.className="opt";
    b.textContent=z;
    b.onclick=()=>{
      [...box.children].forEach(x=>x.disabled=true);
      const correct=(z===q.word.zh);
      b.classList.add(correct?"correct":"wrong");
      answerFeedback(correct, `${q.word.en} = ${q.word.zh}`, z);
    };
    box.appendChild(b);
  });
}

/* Cï¼šé…å° 5 çµ„ï¼ˆå®Œæˆç®—æœ¬é¡Œï¼‰ */
function renderC(q){
  let pool=shuffle(WORD_BANK.filter(w=>w.en!==q.word.en));
  const five=[q.word, ...pool.slice(0,4)];
  const left=shuffle(five.map(w=>({txt:w.en,key:w.en,pair:w.zh,side:"L"})));
  const right=shuffle(five.map(w=>({txt:w.zh,key:w.zh,pair:w.en,side:"R"})));

  let sel=null, matched=0;
  gameArea.innerHTML=`
    <div class="center">
      <div style="font-weight:950;font-size:22px;margin-top:6px">ğŸ”— é…å°</div>
      <p class="help">æŠŠè‹±æ–‡å’Œä¸­æ–‡é…å°ï¼ˆå®Œæˆ 5 çµ„ç®—æœ¬é¡Œå®Œæˆï¼‰</p>
      <div class="muted" style="font-weight:900">é€²åº¦ï¼š<span id="mProg">0</span>/5</div>
      <div style="height:10px"></div>
      <div class="match" id="mg"></div>
    </div>
  `;
  const mg=$("mg");
  const mProg=$("mProg");

  function makeTile(obj){
    const t=document.createElement("button");
    t.className="tile";
    t.textContent=obj.txt;
    t.dataset.key=obj.key;
    t.dataset.pair=obj.pair;
    t.dataset.side=obj.side;
    t.onclick=()=>{
      if(t.classList.contains("gone")) return;
      if(!sel){
        sel=t; t.classList.add("sel"); return;
      }
      if(sel===t){ sel.classList.remove("sel"); sel=null; return; }
      if(sel.dataset.side===t.dataset.side){
        sel.classList.remove("sel");
        sel=t; t.classList.add("sel"); return;
      }
      const ok = (sel.dataset.pair===t.dataset.key) && (t.dataset.pair===sel.dataset.key);
      if(ok){
        sel.classList.remove("sel");
        sel.classList.add("gone");
        t.classList.add("gone");
        sel=null;
        matched++;
        mProg.textContent=matched;
        if(matched===5){
          // é€™é¡Œç®—ã€Œç­”å°ã€çµæŸï¼›ä½†é…å°éç¨‹ä¸å¦å¤–å¼·åˆ¶é¡¯ç¤ºè‹±æ–‡/ä¸­æ–‡
          answerFeedback(true, `é…å°å®Œæˆï¼ˆå« ${q.word.en} â†” ${q.word.zh}ï¼‰`, "paired");
        }
      }else{
        // é…éŒ¯ä¸çµæŸï¼Œåªè¨˜ä¸€ç­†éŒ¯èª¤logï¼Œä¸¦æç¤ºæ­£ç¢ºé…å°ï¼ˆç¬¦åˆä½ è¦éŒ¯äº†çµ¦æ­£è§£ï¼‰
        const state=loadState();
        logAnswer({
          ts: nowISO(), student: state.currentStudent,
          level: G.level, attempt: G.attempt, qIndex: q.idx,
          mode: "C", en: q.word.en, zh: q.word.zh, correct: false,
          ms: Math.round(performance.now()-G.qStartMs),
          extra: {mistake: `${sel.textContent} Ã— ${t.textContent}`, correctPair: `${q.word.en} â†” ${q.word.zh}`}
        });
        const a=sel, b=t;
        a.classList.remove("sel");
        a.classList.add("wrong"); b.classList.add("wrong");
        setTimeout(()=>{ a.classList.remove("wrong"); b.classList.remove("wrong"); }, 400);
        sel=null;
        // é¡¯ç¤ºä¸€æ¬¡æç¤ºï¼ˆä¸é–ä½ï¼‰
        const old=document.querySelector(".hint");
        if(old) old.remove();
        const h=document.createElement("div");
        h.className="hint bad";
        h.innerHTML=`âŒ éŒ¯äº†ï¼Œæ­£ç¢ºé…å°ï¼š<span style="color:var(--ink)">${esc(q.word.en)} â†” ${esc(q.word.zh)}</span>`;
        gameArea.appendChild(h);
      }
    };
    return t;
  }

  left.forEach(o=>mg.appendChild(makeTile(o)));
  right.forEach(o=>mg.appendChild(makeTile(o)));

  // é…å°é¡Œä¸éœ€è¦ next æ‰èƒ½çµæŸï¼šå®Œæˆå¾Œ answerFeedback() æœƒé–‹ nextBtn
}

/* Dï¼šè½â†’æ‹¼è‹±æ–‡ */
function renderD(q){
  gameArea.innerHTML=`
    <div class="center">
      <div class="qBig">ğŸ”Š</div>
      <p class="help">è½è‹±æ–‡ï¼Œæ‹¼å‡ºè‹±æ–‡å–®å­—</p>
      <button class="btn primary" id="playBtn">ğŸ”Š æ’­æ”¾</button>
      <div class="speedBox">
        ğŸšï¸ ç™¼éŸ³é€Ÿåº¦
        <input type="range" id="speechRate" min="0.5" max="1.1" step="0.05">
        <span id="rateLabel"></span>
      </div>
      <div style="height:10px"></div>
      <input id="spell" class="input" placeholder="è¼¸å…¥è‹±æ–‡..." autocomplete="off" autocapitalize="none">
      <div style="height:10px"></div>
      <button class="btn ghost" id="checkBtn">âœ… æª¢æŸ¥</button>
    </div>
  `;
  $("playBtn").onclick=()=>speakEN(q.word.en);
  wireSpeechRateUI();
  const inp=$("spell"); inp.focus();
  $("checkBtn").onclick=()=>{
    const typed=safeLower(inp.value);
    const ans=safeLower(q.word.en);
    const correct=(typed===ans);
    // D æ¨¡å¼éŒ¯äº†é¡¯ç¤ºæ­£ç¢ºæ‹¼å­—
    answerFeedback(correct, q.word.en, typed);
  };
}

/* å‰å°é€Ÿåº¦ sliderï¼ˆæ¯æ¬¡æ¸²æŸ“ A/D éƒ½æ¥ä¸Šï¼‰ */
function wireSpeechRateUI(){
  const rateInput=$("speechRate");
  const rateLabel=$("rateLabel");
  if(!rateInput || !rateLabel) return;

  rateInput.value = SPEECH_RATE;
  rateLabel.textContent = SPEECH_RATE.toFixed(2);

  rateInput.oninput=(e)=>{
    SPEECH_RATE = Number(e.target.value);
    localStorage.setItem("speechRate", SPEECH_RATE);
    rateLabel.textContent = SPEECH_RATE.toFixed(2);
  };

  // iOS æœ‰æ™‚å€™ voices è¦ç­‰ä¸€ä¸‹æ‰è¼‰å…¥ï¼šé€™è£¡è¼•è§¸ä¸€æ¬¡ä¹Ÿèƒ½åˆå§‹åŒ–
  if(typeof speechSynthesis!=="undefined"){
    speechSynthesis.getVoices();
  }
}

/* =========================
   è€å¸«å¾Œå°
   ========================= */
function buildTeacher(){
  show(vTeacher);
  const state=loadState();
  const logs=loadLogs();
  const names=Object.keys(state.students||{});

  $("kStudents").textContent=names.length;
  $("kLogs").textContent=logs.length;

  let passCount=0;
  names.forEach(n=>passCount+=Object.keys(state.students[n].passed||{}).length);
  $("kPass").textContent=passCount;

  const tb=$("stuTable");
  tb.innerHTML="";
  names.sort((a,b)=>(state.students[b].lastSeen||"").localeCompare(state.students[a].lastSeen||"")).forEach(n=>{
    const s=state.students[n];
    const passed=Object.keys(s.passed||{}).length;
    const last=(s.lastSeen||"").replace("T"," ").slice(0,16);

    // ä¼°è¨ˆæ­£ç¢ºç‡ï¼šåªç®— A/B/Dï¼ˆC æœ‰éç¨‹éŒ¯èª¤logï¼‰
    const l=logs.filter(x=>x.student===n);
    const abds=l.filter(x=>["A","B","D"].includes(x.mode));
    const acc=abds.length ? Math.round((abds.filter(x=>x.correct).length/abds.length)*100) : 0;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td style="font-weight:950">${esc(n)}</td>
      <td>${passed} / ${TOTAL_LEVELS}</td>
      <td>${acc}%</td>
      <td>${last||"-"}</td>
      <td><button class="btn small ghost">æŸ¥çœ‹</button></td>
    `;
    tr.querySelector("button").onclick=()=>openStudent(n);
    tb.appendChild(tr);
  });

  $("stuDetail").classList.add("hidden");
}

function openStudent(name){
  $("stuName").textContent=name;
  const logs=loadLogs().filter(x=>x.student===name).slice(-30).reverse();
  const tb=$("logTable");
  tb.innerHTML="";
  logs.forEach(x=>{
    const ts=(x.ts||"").replace("T"," ").slice(0,19);
    const m = x.mode==="A"?"A è½é¸ä¸­":x.mode==="B"?"B çœ‹è‹±é¸ä¸­":x.mode==="C"?"C é…å°":x.mode==="D"?"D è½æ‹¼å­—":x.mode;
    const item =
      x.mode==="A" ? `(è½) â†’ ${x.zh}` :
      x.mode==="B" ? `${x.en} â†’ ${x.zh}` :
      x.mode==="D" ? `(è½) â†’ ${x.en} (${x.zh})` :
      `é…å°ï¼ˆå« ${x.en} / ${x.zh}ï¼‰`;
    const ok = x.correct ? "å°" : "éŒ¯";
    const col = x.correct ? "var(--green)" : "var(--red)";
    tb.innerHTML += `
      <tr>
        <td>${esc(ts)}</td><td>${x.level}</td><td>${x.attempt}</td>
        <td>${esc(m)}</td><td>${esc(item)}</td>
        <td style="font-weight:950;color:${col}">${ok}</td>
      </tr>
    `;
  });
  $("stuDetail").classList.remove("hidden");
}

function exportCSV(){
  const logs=loadLogs();
  const header=["æ™‚é–“","å­¸ç”Ÿ","é—œå¡","å›åˆ","é¡Œåº","é¡Œå‹","è‹±æ–‡","ä¸­æ–‡","æ˜¯å¦æ­£ç¢º","è€—æ™‚ms","extra"];
  const rows=logs.map(x=>[x.ts,x.student,x.level,x.attempt,x.qIndex,x.mode,x.en,x.zh,x.correct,x.ms,JSON.stringify(x.extra||{})]);
  const csv=[header,...rows].map(r=>r.map(cell=>{
    const s=String(cell??"");
    return `"${s.replace(/"/g,'""')}"`;
  }).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`nmpsg_export_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

function exportJSON(){
  const payload={exportedAt:nowISO(), state:loadState(), logs:loadLogs()};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`nmpsg_export_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}

function importJSON(file){
  const r=new FileReader();
  r.onload=()=>{
    try{
      const payload=JSON.parse(r.result);
      if(!payload.state||!payload.logs) throw new Error("bad");
      const local=loadState();
      const incoming=payload.state;

      local.students=local.students||{};
      incoming.students=incoming.students||{};
      Object.keys(incoming.students).forEach(n=>{
        if(!local.students[n]) local.students[n]=incoming.students[n];
        else{
          const L=local.students[n], I=incoming.students[n];
          L.passed=Object.assign({},L.passed||{},I.passed||{});
          L.attempts=Object.assign({},L.attempts||{},I.attempts||{});
          L.best=Object.assign({},L.best||{},I.best||{});
          L.lastSeen = (I.lastSeen && (!L.lastSeen || I.lastSeen>L.lastSeen)) ? I.lastSeen : L.lastSeen;
          L.lastLevel = Math.max(L.lastLevel||1, I.lastLevel||1);
        }
      });
      saveState(local);

      // merge logs (simple dedupe)
      const logs=loadLogs();
      const key=(x)=>`${x.ts}|${x.student}|${x.level}|${x.attempt}|${x.qIndex}|${x.mode}|${x.correct}`;
      const set=new Set(logs.map(key));
      (payload.logs||[]).forEach(x=>{
        const k=key(x);
        if(!set.has(k)){ logs.push(x); set.add(k); }
      });
      saveLogs(logs);

      toast("âœ… åŒ¯å…¥å®Œæˆï¼");
      buildTeacher();
    }catch(e){
      toast("âŒ åŒ¯å…¥å¤±æ•—ï¼šJSONæ ¼å¼ä¸æ­£ç¢º");
    }
  };
  r.readAsText(file);
}

/* =========================
   äº‹ä»¶ç¶å®š
   ========================= */
$("switchBtn").onclick=()=>{ show(vLogin); $("nameInput").value=""; };
$("teacherBtn").onclick=buildTeacher;

$("tabMap").onclick=showMap;
$("tabGame").onclick=()=>{
  const state=loadState();
  const stu=currentStudentObj(state);
  if(!stu){ show(vLogin); return; }
  startGame(stu.lastLevel||1);
};
$("tabTeacher").onclick=buildTeacher;

$("backToMapBtn").onclick=showMap;

$("resumeBtn").onclick=()=>{
  const state=loadState();
  const stu=currentStudentObj(state);
  if(!stu){ show(vLogin); return; }
  startGame(stu.lastLevel||1);
};

$("loginBtn").onclick=()=>{
  const name=$("nameInput").value.trim();
  if(!name){ toast("è«‹è¼¸å…¥åå­—"); return; }
  const state=loadState();
  state.currentStudent=name;
  ensureStudent(state,name);
  saveState(state);
  refreshHeader();
  showMap();
};

$("exportCsvBtn").onclick=exportCSV;
$("exportJsonBtn").onclick=exportJSON;
$("importJsonFile").onchange=(e)=>{
  const f=e.target.files?.[0];
  if(f) importJSON(f);
  e.target.value="";
};

$("wipeBtn").onclick=()=>{
  if(confirm("ç¢ºå®šæ¸…ç©ºæœ¬æ©Ÿæ‰€æœ‰å­¸ç”Ÿ/ç´€éŒ„ï¼Ÿï¼ˆä¸å¯å¾©åŸï¼‰")){
    localStorage.removeItem(LS_STATE);
    localStorage.removeItem(LS_LOGS);
    toast("å·²æ¸…ç©º");
    refreshHeader();
    show(vLogin);
  }
};

$("closeDetailBtn").onclick=()=>$("stuDetail").classList.add("hidden");

/* =========================
   å•Ÿå‹•
   ========================= */
refreshHeader();
(function boot(){
  const state=loadState();
  if(state.currentStudent){
    ensureStudent(state, state.currentStudent);
    saveState(state);
    showMap();
  }else{
    show(vLogin);
  }
  // iOS voices preload
  if(typeof speechSynthesis!=="undefined"){
    speechSynthesis.getVoices();
    speechSynthesis.onvoiceschanged=()=>speechSynthesis.getVoices();
  }
})();
</script>
</body>
</html>
