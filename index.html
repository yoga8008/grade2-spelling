<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å—é–€åœ‹å°æ‹¼å­—æŒ‘æˆ° Go</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --ink:#111;
    --muted:#6b7280; --line:#e5e7eb;
    --green:#22c55e; --blue:#4f7cff; --gold:#facc15; --gray:#cbd5e1;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial}
  .wrap{max-width:560px;margin:0 auto;padding:18px}
  .card{background:var(--card);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
  h1{margin:6px 0 10px;font-size:22px;text-align:center}
  h2{margin:0 0 10px;font-size:18px}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .muted{color:var(--muted);font-size:13px}
  .btn{border:0;border-radius:14px;padding:12px 14px;font-size:16px;cursor:pointer}
  .btn:active{transform:scale(.99)}
  .btnBlue{background:var(--blue);color:#fff}
  .btnSoft{background:#eef2ff;color:#1f2a5a}
  .btnGray{background:#eef1f7;color:#111}
  .btnGhost{background:transparent;border:1px solid var(--line)}
  input{width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--line);font-size:16px}
  .hidden{display:none}

  /* map */
  .map{display:flex;flex-direction:column;align-items:center;padding:10px 0 4px}
  .node{
    width:74px;height:74px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    font-weight:800;font-size:18px;
    user-select:none;
  }
  .node.locked{background:var(--gray);color:#64748b}
  .node.current{background:var(--blue);color:#fff;cursor:pointer}
  .node.done{background:var(--gold);color:#1f2937;cursor:pointer}
  .pipe{width:8px;height:34px;background:#dbe3ff;border-radius:8px;margin:10px 0}
  .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--line);border-radius:999px;font-size:13px;color:#111;background:#fff}
  .pill b{font-size:13px}
  .iconBtn{width:auto;padding:10px 12px;border-radius:12px}

  /* game */
  .center{text-align:center}
  .bigWord{font-size:48px;font-weight:900;margin:10px 0 8px}
  .progress{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:6px 0 8px}
  .bar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden;flex:1}
  .bar > div{height:100%;background:var(--green);width:0%}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .opt{width:100%;text-align:center;padding:14px;border-radius:14px;border:0;background:#eef1f7;font-size:18px;cursor:pointer}
  .opt:hover{filter:brightness(.98)}
  .badge{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;background:#f1f5f9;border-radius:999px;font-size:13px}
  .toast{margin-top:10px;font-size:14px}
  .ok{color:#16a34a;font-weight:700}
  .no{color:#dc2626;font-weight:700}

  /* matching (C) */
  .matchWrap{margin-top:8px}
  .matchGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .tileCol{display:flex;flex-direction:column;gap:10px}
  .tile{
    padding:16px 10px;border-radius:14px;border:1px solid var(--line);
    text-align:center;font-size:18px;background:#fff;cursor:pointer;
  }
  .tile.sel{outline:3px solid #93c5fd}
  .tile.done{opacity:.35;pointer-events:none}
  .streak{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:10px}
  .timer{font-weight:800;color:#ef4444}

  /* spell (D) */
  .spellBox{margin-top:10px}
  .slots{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;margin:10px 0}
  .slot{
    width:34px;height:44px;border-radius:10px;border:2px solid #cbd5e1;
    display:flex;align-items:center;justify-content:center;
    font-weight:900;font-size:22px;background:#fff;
  }
  .kbd{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .kbtn{
    min-width:44px;padding:12px 10px;border-radius:12px;border:0;
    background:#eef1f7;font-size:18px;font-weight:800;cursor:pointer;
  }
  .kbtn.ctrl{background:#ffe4e6}
  .footerRow{display:flex;gap:10px}
  .footerRow .btn{flex:1}
</style>
</head>

<body>
<div class="wrap">

  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <h1>ğŸ« å—é–€åœ‹å°æ‹¼å­—æŒ‘æˆ° Go</h1>
    <p class="muted center" style="margin:0 0 10px;">è¼¸å…¥å­¸ç”Ÿå§“åé–‹å§‹ï¼ˆåŒä¸€å°è£ç½®å¯å¤šä½å­¸ç”Ÿï¼‰</p>
    <input id="nameInput" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜ / Momo" />
    <div class="footerRow" style="margin-top:10px;">
      <button class="btn btnBlue" onclick="login()">ğŸš€ é–‹å§‹</button>
      <button class="btn btnGhost" onclick="manageStudents()">ğŸ‘¥ ç®¡ç†</button>
    </div>
    <p class="muted" style="margin:10px 0 0;">
      ğŸ‘©â€ğŸ« è€å¸«åŒ¯å‡ºï¼šé€²åœ°åœ–å¾Œé»å³ä¸Šè§’ã€ŒğŸ‘©â€ğŸ«ã€å¯ä¸‹è¼‰ CSVï¼ˆExcel å¯é–‹ï¼‰ã€‚
    </p>
  </div>

  <!-- MAP -->
  <div class="card hidden" id="mapCard">
    <div class="topbar">
      <span class="pill">ğŸ‘¦ å­¸ç”Ÿï¼š<b id="studentLabel"></b></span>
      <div class="row" style="gap:8px;">
        <button class="btn btnSoft iconBtn" onclick="openTeacher()">ğŸ‘©â€ğŸ«</button>
        <button class="btn btnGhost iconBtn" onclick="switchStudent()">ğŸ” æ›å­¸ç”Ÿ</button>
      </div>
    </div>
    <div class="row" style="margin-bottom:10px;">
      <span class="badge">ğŸ—ºï¸ 100 é—œ</span>
      <span class="badge">ğŸ² A/B/C/D éš¨æ©Ÿé¡Œå‹</span>
    </div>
    <div class="muted" id="mapHint" style="margin-bottom:8px;">
      â­ å·²éé—œä»å¯é‡ç©ï¼ˆæ¯æ¬¡æœƒç®—ç¬¬ N æ¬¡æŒ‘æˆ°ï¼‰ã€‚
    </div>
    <div class="map" id="map"></div>
  </div>

  <!-- GAME -->
  <div class="card hidden" id="gameCard">
    <div class="progress">
      <span class="badge" id="levelBadge">ğŸ¯ ç¬¬ 1 é—œ</span>
      <span class="badge" id="attemptBadge">ğŸ” ç¬¬ 1 æ¬¡</span>
    </div>
    <div class="bar"><div id="barFill"></div></div>
    <div class="row" style="margin-top:10px;">
      <span class="muted" id="qInfo">ç¬¬ 1/10 é¡Œ</span>
      <span class="timer" id="timeInfo">â±ï¸ 0:00</span>
    </div>

    <div id="questionArea"></div>
    <div id="answerArea"></div>

    <div class="toast center" id="toast"></div>

    <div class="footerRow" style="margin-top:12px;">
      <button class="btn btnGhost" onclick="quitLevel()">â¬…ï¸ å›åœ°åœ–</button>
      <button class="btn btnBlue" onclick="next()">â¡ï¸ ä¸‹ä¸€é¡Œ</button>
    </div>
  </div>

  <!-- TEACHER -->
  <div class="card hidden" id="teacherCard">
    <div class="row" style="margin-bottom:10px;">
      <h2 style="margin:0;">ğŸ‘©â€ğŸ« è€å¸«å¾Œå°</h2>
      <button class="btn btnGhost iconBtn" onclick="closeTeacher()">âœ–ï¸</button>
    </div>

    <div class="row" style="gap:10px;flex-wrap:wrap;">
      <span class="badge">ğŸ“Š éŒ¯èª¤çµ±è¨ˆï¼ˆä¾å–®å­—ï¼‰</span>
      <span class="badge">ğŸ“ˆ å­¸ç”Ÿé€²åº¦ï¼ˆå·²è§£é–é—œå¡ï¼‰</span>
    </div>

    <div style="margin-top:12px;">
      <button class="btn btnBlue" style="width:100%;" onclick="exportCSV()">â¬‡ï¸ åŒ¯å‡º CSVï¼ˆExcelï¼‰</button>
      <button class="btn btnSoft" style="width:100%;margin-top:8px;" onclick="exportSummaryCSV()">â¬‡ï¸ åŒ¯å‡ºã€Œæ‘˜è¦ã€CSVï¼ˆæ¯é—œæˆç¸¾ï¼‰</button>
    </div>

    <div class="muted" style="margin-top:12px;line-height:1.5">
      âœ… åŒ¯å‡ºå…§å®¹åŒ…å«ï¼šå­¸ç”Ÿã€é—œå¡ã€æŒ‘æˆ°æ¬¡æ•¸ã€é¡Œå‹(A/B/C/D)ã€å–®å­—ã€æ­£èª¤ã€ä½œç­”ã€æ™‚é–“æˆ³ã€‚<br>
      âš ï¸ é€™æ˜¯ã€ŒåŒä¸€å°è£ç½®ã€çš„è³‡æ–™ã€‚å¦‚æœå­¸ç”Ÿåœ¨åˆ¥å°æ‰‹æ©Ÿç©ï¼Œè³‡æ–™æœƒåœ¨ä»–é‚£å°æ‰‹æ©Ÿä¸Šã€‚
    </div>

    <div id="teacherStats" style="margin-top:12px;"></div>
  </div>

</div>

<script>
/* =========================
   153 å­—ï¼ˆå¾ä½  PDF è§£æï¼‰
   ========================= */
const WORDS = [
  {n:1,en:"able",zh:"èƒ½å¤ "},
  {n:2,en:"all",zh:"æ‰€æœ‰"},
  {n:3,en:"after",zh:"åœ¨â€¦ä¹‹å¾Œ"},
  {n:4,en:"and",zh:"å’Œ"},
  {n:5,en:"any",zh:"ä»»ä½•"},
  {n:6,en:"ant",zh:"èèŸ»"},
  {n:7,en:"apple",zh:"è˜‹æœ"},
  {n:8,en:"April",zh:"å››æœˆ"},
  {n:9,en:"ask",zh:"å•"},
  {n:10,en:"book",zh:"æ›¸"},
  {n:11,en:"ball",zh:"çƒ"},
  {n:12,en:"basket",zh:"ç±ƒå­"},
  {n:13,en:"banana",zh:"é¦™è•‰"},
  {n:14,en:"bank",zh:"éŠ€è¡Œ"},
  {n:15,en:"bath",zh:"æ´—æ¾¡"},
  {n:16,en:"bat",zh:"çƒæ£’;è™è "},
  {n:17,en:"beach",zh:"æµ·ç˜"},
  {n:18,en:"become",zh:"æˆç‚º"},
  {n:19,en:"bed",zh:"åºŠ"},
  {n:20,en:"bee",zh:"èœœèœ‚"},
  {n:21,en:"bite",zh:"å’¬"},
  {n:22,en:"bicycle",zh:"è…³è¸è»Š"},
  {n:23,en:"big",zh:"å¤§çš„"},
  {n:24,en:"blueberry",zh:"è—è“"},
  {n:25,en:"blue",zh:"è—è‰²"},
  {n:26,en:"boat",zh:"èˆ¹"},
  {n:27,en:"body",zh:"èº«é«”"},
  {n:28,en:"box",zh:"ç›’å­"},
  {n:29,en:"boy",zh:"ç”·å­©"},
  {n:30,en:"bread",zh:"éºµåŒ…"},
  {n:31,en:"brown",zh:"æ£•è‰²"},
  {n:32,en:"bus",zh:"å…¬è»Š"},
  {n:33,en:"busy",zh:"å¿™ç¢Œçš„"},
  {n:34,en:"cake",zh:"è›‹ç³•"},
  {n:35,en:"candy",zh:"ç³–æœ"},
  {n:36,en:"cat",zh:"è²“"},
  {n:37,en:"chair",zh:"æ¤…å­"},
  {n:38,en:"cheese",zh:"èµ·å¸"},
  {n:39,en:"chicken",zh:"é›"},
  {n:40,en:"chin",zh:"ä¸‹å·´"},
  {n:41,en:"check",zh:"æ‰“å‹¾ï¼›ç¢ºèª"},
  {n:42,en:"cool",zh:"æ¶¼çˆ½çš„;é…·"},
  {n:43,en:"child",zh:"å°å­©"},
  {n:44,en:"circle",zh:"åœ“"},
  {n:45,en:"coffee",zh:"å’–å•¡"},
  {n:46,en:"cup",zh:"æ¯å­"},
  {n:47,en:"cute",zh:"å¯æ„›çš„"},
  {n:48,en:"dark",zh:"é»‘æš—çš„"},
  {n:49,en:"dance",zh:"è·³èˆ"},
  {n:50,en:"dear",zh:"è¦ªæ„›çš„"},
  {n:51,en:"desk",zh:"æ¡Œå­"},
  {n:52,en:"doctor",zh:"é†«ç”Ÿ"},
  {n:53,en:"dirty",zh:"é«’çš„"},
  {n:54,en:"doll",zh:"å¨ƒå¨ƒ"},
  {n:55,en:"dinner",zh:"æ™šé¤"},
  {n:56,en:"duck",zh:"é´¨å­"},
  {n:57,en:"early",zh:"æ—©çš„"},
  {n:58,en:"ear",zh:"è€³æœµ"},
  {n:59,en:"egg",zh:"è›‹"},
  {n:60,en:"elf",zh:"ç²¾éˆ"},
  {n:61,en:"elephant",zh:"å¤§è±¡"},
  {n:62,en:"eraser",zh:"æ©¡çš®æ“¦"},
  {n:63,en:"family",zh:"å®¶åº­"},
  {n:64,en:"fat",zh:"èƒ–çš„"},
  {n:65,en:"feet",zh:"è…³(è¤‡æ•¸)"},
  {n:66,en:"father",zh:"çˆ¸çˆ¸"},
  {n:67,en:"fine",zh:"å¥½çš„ï¼›å¥åº·"},
  {n:68,en:"fish",zh:"é­š"},
  {n:69,en:"five",zh:"äº”"},
  {n:70,en:"flower",zh:"èŠ±"},
  {n:71,en:"food",zh:"é£Ÿç‰©"},
  {n:72,en:"fox",zh:"ç‹ç‹¸"},
  {n:73,en:"friend",zh:"æœ‹å‹"},
  {n:74,en:"fun",zh:"å¥½ç©"},
  {n:75,en:"four",zh:"å››"},
  {n:76,en:"girl",zh:"å¥³å­©"},
  {n:77,en:"go",zh:"å»"},
  {n:78,en:"good",zh:"å¥½çš„"},
  {n:79,en:"green",zh:"ç¶ è‰²"},
  {n:80,en:"goat",zh:"å±±ç¾Š"},
  {n:81,en:"garden",zh:"èŠ±åœ’"},
  {n:82,en:"give",zh:"çµ¦äºˆ"},
  {n:83,en:"ham",zh:"ç«è…¿"},
  {n:84,en:"hand",zh:"æ‰‹"},
  {n:85,en:"happy",zh:"å¿«æ¨‚çš„"},
  {n:86,en:"hair",zh:"é ­é«®"},
  {n:87,en:"hard",zh:"å›°é›£"},
  {n:88,en:"hear",zh:"è½"},
  {n:89,en:"heart",zh:"å¿ƒè‡Ÿ"},
  {n:90,en:"heat",zh:"ç™¼ç†±"},
  {n:91,en:"help",zh:"å¹«åŠ©"},
  {n:92,en:"in",zh:"åœ¨â€¦è£¡é¢"},
  {n:93,en:"ice",zh:"å†°"},
  {n:94,en:"igloo",zh:"å†°å±‹"},
  {n:95,en:"jam",zh:"æœé†¬"},
  {n:96,en:"jacket",zh:"å¤¾å…‹"},
  {n:97,en:"job",zh:"å·¥ä½œ"},
  {n:98,en:"jump",zh:"è·³"},
  {n:99,en:"kiss",zh:"è¦ªå»"},
  {n:100,en:"kite",zh:"é¢¨ç®"},
  {n:101,en:"key",zh:"é‘°åŒ™"},
  {n:102,en:"knee",zh:"è†è“‹"},
  {n:103,en:"lips",zh:"å˜´å”‡"},
  {n:104,en:"leg",zh:"è…¿"},
  {n:105,en:"like",zh:"å–œæ­¡"},
  {n:106,en:"lion",zh:"ç…å­"},
  {n:107,en:"leg",zh:"è…¿"},
  {n:108,en:"mail",zh:"éƒµä»¶"},
  {n:109,en:"mother",zh:"åª½åª½"},
  {n:110,en:"moon",zh:"æœˆäº®"},
  {n:111,en:"mouse",zh:"è€é¼ "},
  {n:112,en:"name",zh:"åå­—"},
  {n:113,en:"new",zh:"æ–°çš„"},
  {n:114,en:"nine",zh:"ä¹"},
  {n:115,en:"nose",zh:"é¼»å­"},
  {n:116,en:"nut",zh:"å …æœ"},
  {n:117,en:"open",zh:"æ‰“é–‹"},
  {n:118,en:"orange",zh:"æ©˜å­"},
  {n:119,en:"one",zh:"ä¸€"},
  {n:120,en:"pants",zh:"è¤²å­"},
  {n:121,en:"pen",zh:"ç­†"},
  {n:122,en:"old",zh:"è€çš„ï¼›èˆŠçš„"},
  {n:123,en:"only",zh:"å”¯ä¸€"},
  {n:124,en:"pet",zh:"å¯µç‰©"},
  {n:125,en:"pencil",zh:"é‰›ç­†"},
  {n:126,en:"pizza",zh:"æ¯”è–©"},
  {n:127,en:"pot",zh:"é‹å­"},
  {n:128,en:"pillow",zh:"æ•é ­"},
  {n:129,en:"queen",zh:"çš‡å"},
  {n:130,en:"question",zh:"å•é¡Œ"},
  {n:131,en:"quick",zh:"å¿«çš„"},
  {n:132,en:"rat",zh:"é¼ "},
  {n:133,en:"rain",zh:"é›¨"},
  {n:134,en:"red",zh:"ç´…è‰²"},
  {n:135,en:"robot",zh:"æ©Ÿå™¨äºº"},
  {n:136,en:"ruler",zh:"å°º"},
  {n:137,en:"sand",zh:"æ²™"},
  {n:138,en:"same",zh:"ç›¸åŒ"},
  {n:139,en:"send",zh:"é€"},
  {n:140,en:"sew",zh:"ç¸«è£œ"},
  {n:141,en:"sing",zh:"å”±æ­Œ"},
  {n:142,en:"sister",zh:"å§å¦¹"},
  {n:143,en:"seven",zh:"7"},
  {n:144,en:"table",zh:"æ¡Œå­"},
  {n:145,en:"talk",zh:"èªªè©±"},
  {n:146,en:"thank",zh:"æ„Ÿè¬"},
  {n:147,en:"three",zh:"3"},
  {n:148,en:"teacher",zh:"è€å¸«"},
  {n:149,en:"tree",zh:"æ¨¹"},
  {n:150,en:"tub",zh:"æµ´ç¼¸"},
  {n:151,en:"turtle",zh:"çƒé¾œ"},
  {n:152,en:"up",zh:"ä¸Šé¢"},
  {n:153,en:"yellow",zh:"é»ƒè‰²"}
];

const TOTAL_LEVELS = 100;
const Q_PER_LEVEL = 10;

/* =========================
   Storage schema
   =========================
   key: nmgo_students -> ["ç‹å°æ˜","Momo"...]
   key: nmgo_{name} -> {
      unlocked: number, // highest unlocked (start 1)
      completed: { [level]: true }, // finished at least once
      levelAttempts: { [level]: number }, // how many times played
      levelBest: { [level]: {bestScore, bestTimeSec} },
      logs: [ {ts, student, level, attemptNo, qIndex, mode, wordN, en, zh, correct, answer, ms} ]
   }
*/
let student = "";
let state = null;

let curLevel = 1;
let curAttemptNo = 1;
let qIndex = 0;
let correctCount = 0;
let levelStartMs = 0;
let tickTimer = null;

// current question payload
let curMode = "A"; // A/B/C/D
let curWord = null;

// for C matching
let matchDone = 0;
let matchPick = null; // {type, id, value}
let matchPairs = []; // [{en,zh}]
let matchTiles = {left:[], right:[]}; // each tile {id, value, pairId, done}

// for D spelling
let spellTarget = "";
let spellChars = [];
let spellInput = [];

function $(id){return document.getElementById(id);}

function loadStudents(){
  try{ return JSON.parse(localStorage.getItem("nmgo_students")||"[]"); }
  catch{ return []; }
}
function saveStudents(arr){
  localStorage.setItem("nmgo_students", JSON.stringify(arr));
}
function loadState(name){
  const raw = localStorage.getItem("nmgo_"+name);
  if(raw){
    try{return JSON.parse(raw);}catch{}
  }
  return {unlocked:1, completed:{}, levelAttempts:{}, levelBest:{}, logs:[]};
}
function saveState(){
  localStorage.setItem("nmgo_"+student, JSON.stringify(state));
}

function login(){
  const name = $("nameInput").value.trim();
  if(!name) return alert("è«‹è¼¸å…¥å­¸ç”Ÿå§“å");
  student = name;
  let list = loadStudents();
  if(!list.includes(student)){
    list.unshift(student);
    saveStudents(list);
  }
  state = loadState(student);

  $("loginCard").classList.add("hidden");
  $("mapCard").classList.remove("hidden");
  $("studentLabel").textContent = student;
  renderMap();
}

function manageStudents(){
  const list = loadStudents();
  if(list.length===0){ alert("ç›®å‰æ²’æœ‰å·²å„²å­˜çš„å­¸ç”Ÿã€‚å…ˆè¼¸å…¥å§“åé–‹å§‹ä¸€æ¬¡å°±æœƒå‡ºç¾åœ¨æ¸…å–®ã€‚"); return; }
  const msg = "å·²å„²å­˜å­¸ç”Ÿï¼š\n" + list.map((n,i)=>`${i+1}. ${n}`).join("\n") + "\n\nè¼¸å…¥è¦åˆªé™¤çš„å­¸ç”Ÿç·¨è™Ÿï¼ˆä¾‹å¦‚ 2ï¼‰ï¼Œæˆ–æŒ‰å–æ¶ˆã€‚";
  const pick = prompt(msg);
  if(!pick) return;
  const idx = parseInt(pick,10);
  if(!idx || idx<1 || idx>list.length) return alert("ç·¨è™Ÿä¸æ­£ç¢º");
  const name = list[idx-1];
  if(!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${name}ã€åœ¨é€™å°è£ç½®çš„ç´€éŒ„ï¼Ÿ`)) return;
  localStorage.removeItem("nmgo_"+name);
  list.splice(idx-1,1);
  saveStudents(list);
  alert("å·²åˆªé™¤ã€‚");
}

function switchStudent(){
  stopTick();
  student=""; state=null;
  $("mapCard").classList.add("hidden");
  $("gameCard").classList.add("hidden");
  $("teacherCard").classList.add("hidden");
  $("loginCard").classList.remove("hidden");
  $("nameInput").value="";
}

function openTeacher(){
  $("teacherCard").classList.remove("hidden");
  renderTeacherStats();
}
function closeTeacher(){
  $("teacherCard").classList.add("hidden");
}

function renderMap(){
  const map = $("map");
  map.innerHTML = "";
  const unlocked = Math.max(1, state.unlocked||1);

  for(let i=1;i<=TOTAL_LEVELS;i++){
    const node = document.createElement("div");
    node.className = "node";
    const done = !!state.completed?.[i];

    if(i < unlocked){
      node.classList.add("done");
      node.textContent = "â­";
      node.title = `ç¬¬ ${i} é—œï¼ˆå·²éé—œï¼Œå¯é‡ç©ï¼‰`;
      node.onclick = ()=>startLevel(i);
    }else if(i === unlocked){
      node.classList.add("current");
      node.textContent = i;
      node.title = `ç¬¬ ${i} é—œï¼ˆå¯æŒ‘æˆ°ï¼‰`;
      node.onclick = ()=>startLevel(i);
    }else{
      node.classList.add("locked");
      node.textContent = "ğŸ”’";
      node.title = `ç¬¬ ${i} é—œï¼ˆå°šæœªè§£é–ï¼‰`;
    }

    map.appendChild(node);
    if(i < TOTAL_LEVELS){
      const pipe = document.createElement("div");
      pipe.className = "pipe";
      map.appendChild(pipe);
    }
  }
}

function startLevel(level){
  stopTick();

  curLevel = level;
  qIndex = 0;
  correctCount = 0;
  levelStartMs = Date.now();

  // attempt number for this level
  const prev = state.levelAttempts?.[curLevel] || 0;
  curAttemptNo = prev + 1;
  state.levelAttempts[curLevel] = curAttemptNo;
  saveState();

  $("mapCard").classList.add("hidden");
  $("teacherCard").classList.add("hidden");
  $("gameCard").classList.remove("hidden");
  $("toast").textContent = "";

  $("levelBadge").textContent = `ğŸ¯ ç¬¬ ${curLevel} é—œ`;
  $("attemptBadge").textContent = `ğŸ” ç¬¬ ${curAttemptNo} æ¬¡`;

  startTick();
  renderQuestion();
  updateUI();
}

function quitLevel(){
  stopTick();
  $("gameCard").classList.add("hidden");
  $("mapCard").classList.remove("hidden");
  renderMap();
}

function startTick(){
  const start = Date.now();
  tickTimer = setInterval(()=>{
    const ms = Date.now()-start;
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const r = s%60;
    $("timeInfo").textContent = `â±ï¸ ${m}:${String(r).padStart(2,"0")}`;
  }, 250);
}
function stopTick(){
  if(tickTimer){ clearInterval(tickTimer); tickTimer=null; }
}

/* =========================
   Question selection
   ========================= */
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function pickWord(level, q){
  // deterministic-ish but still varied across levels
  // base index + jitter
  const base = (level-1)*Q_PER_LEVEL + q;
  const idx = (base + randInt(0, WORDS.length-1)) % WORDS.length;
  return WORDS[idx];
}
function pickMode(){
  // A/B/C/D equally likely
  const modes = ["A","B","C","D"];
  return modes[randInt(0,3)];
}

function renderQuestion(){
  curMode = pickMode();
  curWord = pickWord(curLevel, qIndex);

  // reset mode-specific
  matchDone = 0; matchPick = null; matchPairs=[]; matchTiles={left:[],right:[]};
  spellTarget=""; spellChars=[]; spellInput=[];

  $("toast").textContent = "";

  if(curMode==="A") renderA();
  if(curMode==="B") renderB();
  if(curMode==="C") renderC();
  if(curMode==="D") renderD();
}

function updateUI(){
  $("qInfo").textContent = `ç¬¬ ${qIndex+1}/${Q_PER_LEVEL} é¡Œ`;
  $("barFill").style.width = `${Math.round((qIndex/Q_PER_LEVEL)*100)}%`;
}

/* =========================
   TTS
   ========================= */
function speak(text){
  try{
    if(!("speechSynthesis" in window)) return alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³ã€‚");
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.rate = 0.9;
    window.speechSynthesis.speak(u);
  }catch(e){
    alert("èªéŸ³æ’­æ”¾å¤±æ•—ï¼Œå¯èƒ½éœ€è¦æ”¹ç”¨ Safariã€‚");
  }
}

/* =========================
   Logging
   ========================= */
function logAnswer({correct, answer, ms, mode, word}){
  const rec = {
    ts: new Date().toISOString(),
    student,
    level: curLevel,
    attemptNo: curAttemptNo,
    qIndex: qIndex+1,
    mode,
    wordN: word.n,
    en: word.en,
    zh: word.zh,
    correct: !!correct,
    answer: answer ?? "",
    ms: ms ?? 0
  };
  state.logs.push(rec);
  saveState();
}

/* =========================
   Mode A: Listen -> choose Chinese (NO English shown)
   ========================= */
function renderA(){
  $("questionArea").innerHTML = `
    <div class="center">
      <div class="badge">ğŸ…°ï¸ è½ â†’ é¸ä¸­æ–‡ï¼ˆä¸é¡¯ç¤ºè‹±æ–‡ï¼‰</div>
      <div style="margin-top:10px;">
        <button class="btn btnBlue" onclick="speak('${escapeJS(curWord.en)}')">ğŸ”Š æ’­æ”¾</button>
      </div>
      <div class="muted" style="margin-top:8px;">è½è‹±æ–‡å¾Œï¼Œé¸å‡ºæ­£ç¢ºä¸­æ–‡æ„æ€</div>
    </div>
  `;

  const opts = makeZhOptions(curWord, 4);
  $("answerArea").innerHTML = `
    <div class="grid">
      ${opts.map(z=>`<button class="opt" onclick="answerChoice('A','${escapeJS(z)}')">${escapeHTML(z)}</button>`).join("")}
    </div>
  `;
}

/* =========================
   Mode B: See English -> choose Chinese
   ========================= */
function renderB(){
  $("questionArea").innerHTML = `
    <div class="center">
      <div class="badge">ğŸ…±ï¸ çœ‹è‹±æ–‡ â†’ é¸ä¸­æ–‡</div>
      <div class="bigWord">${escapeHTML(curWord.en)}</div>
      <button class="btn btnSoft" onclick="speak('${escapeJS(curWord.en)}')">ğŸ”Š è½è½çœ‹</button>
    </div>
  `;

  const opts = makeZhOptions(curWord, 4);
  $("answerArea").innerHTML = `
    <div class="grid">
      ${opts.map(z=>`<button class="opt" onclick="answerChoice('B','${escapeJS(z)}')">${escapeHTML(z)}</button>`).join("")}
    </div>
  `;
}

/* =========================
   Mode C: Matching (like your screenshot)
   One "question" = 5 pairs to match
   ========================= */
function renderC(){
  // Build 5 pairs including target + 4 random others
  const pool = shuffle(WORDS.filter(w=>w.en!==curWord.en));
  matchPairs = [{en:curWord.en, zh:curWord.zh}];
  for(let i=0;i<4;i++) matchPairs.push({en:pool[i].en, zh:pool[i].zh});
  matchPairs = shuffle(matchPairs);

  // Create tiles
  matchTiles.left = matchPairs.map((p,i)=>({id:"L"+i, value:p.zh, pairId:i, done:false}));
  matchTiles.right= matchPairs.map((p,i)=>({id:"R"+i, value:p.en, pairId:i, done:false}));
  matchTiles.left = shuffle(matchTiles.left);
  matchTiles.right= shuffle(matchTiles.right);

  $("questionArea").innerHTML = `
    <div class="center">
      <div class="badge">ğŸ…² è‹±æ–‡ â†” ä¸­æ–‡é…å°</div>
      <div class="muted" style="margin-top:6px;">åƒ Duolingoï¼šé»ä¸€å€‹ä¸­æ–‡ï¼Œå†é»å°æ‡‰è‹±æ–‡</div>
    </div>
    <div class="streak">
      <span class="badge">âœ… å·²é…å°ï¼š<b id="matchCount">0/5</b></span>
      <span class="badge">ğŸ’¥ é€£æ“Šï¼š<b id="streak">0</b></span>
    </div>
  `;

  $("answerArea").innerHTML = `
    <div class="matchWrap">
      <div class="matchGrid">
        <div class="tileCol" id="leftCol"></div>
        <div class="tileCol" id="rightCol"></div>
      </div>
    </div>
  `;
  renderMatchTiles();
}

let streak=0;
function renderMatchTiles(){
  const left = $("leftCol");
  const right= $("rightCol");
  left.innerHTML = "";
  right.innerHTML= "";

  matchTiles.left.forEach(t=>{
    const d=document.createElement("div");
    d.className = "tile"+(t.done?" done":"")+(matchPick?.id===t.id?" sel":"");
    d.textContent = t.value;
    d.onclick = ()=>pickTile("L", t.id);
    left.appendChild(d);
  });
  matchTiles.right.forEach(t=>{
    const d=document.createElement("div");
    d.className = "tile"+(t.done?" done":"")+(matchPick?.id===t.id?" sel":"");
    d.textContent = t.value;
    d.onclick = ()=>pickTile("R", t.id);
    right.appendChild(d);
  });

  $("matchCount").textContent = `${matchDone}/5`;
  $("streak").textContent = String(streak);
}

function findTile(side, id){
  const arr = side==="L" ? matchTiles.left : matchTiles.right;
  return arr.find(t=>t.id===id);
}

function pickTile(side, id){
  const tile = findTile(side, id);
  if(!tile || tile.done) return;

  // first pick
  if(!matchPick){
    matchPick = {side, id, pairId: tile.pairId};
    renderMatchTiles();
    return;
  }

  // same side => replace selection
  if(matchPick.side===side){
    matchPick = {side, id, pairId: tile.pairId};
    renderMatchTiles();
    return;
  }

  // second pick => check pair
  const tile2 = tile;
  const tile1 = findTile(matchPick.side, matchPick.id);
  if(!tile1) { matchPick=null; renderMatchTiles(); return; }

  if(tile1.pairId === tile2.pairId){
    // matched
    tile1.done = true; tile2.done = true;
    matchDone++;
    streak++;
    $("toast").innerHTML = `<span class="ok">âœ… é…å°æˆåŠŸï¼</span>`;
    if(matchDone>=5){
      // question solved => count correct
      correctCount++;
      logAnswer({correct:true, answer:"match:completed", ms: Date.now()-levelStartMs, mode:"C", word:curWord});
      $("toast").innerHTML = `<span class="ok">ğŸ‰ æœ¬é¡Œå®Œæˆï¼æŒ‰ã€Œä¸‹ä¸€é¡Œã€</span>`;
    }
  }else{
    streak=0;
    $("toast").innerHTML = `<span class="no">âŒ ä¸å°ï¼Œå†è©¦ä¸€æ¬¡</span>`;
    // log as wrong attempt but don't finish question
    logAnswer({correct:false, answer:`match:wrong(${tile1.value} <> ${tile2.value})`, ms: Date.now()-levelStartMs, mode:"C", word:curWord});
  }

  matchPick=null;
  renderMatchTiles();
}

/* =========================
   Mode D: Listen -> spell English
   ========================= */
function renderD(){
  spellTarget = (curWord.en||"").toLowerCase();
  spellInput = [];
  const letters = spellTarget.replace(/[^a-z]/g,"").split("");
  const extras = "abcdefghijklmnopqrstuvwxyz".split("");
  const pool = letters.slice();

  // add distractors up to 10~14 keys
  while(pool.length < Math.min(14, Math.max(10, letters.length+4))){
    const c = extras[randInt(0,25)];
    if(pool.filter(x=>x===c).length < 2) pool.push(c);
  }
  spellChars = shuffle(pool);

  $("questionArea").innerHTML = `
    <div class="center">
      <div class="badge">ğŸ…³ è½ â†’ æ‹¼è‹±æ–‡å–®å­—</div>
      <div style="margin-top:10px;">
        <button class="btn btnBlue" onclick="speak('${escapeJS(curWord.en)}')">ğŸ”Š æ’­æ”¾</button>
        <button class="btn btnSoft" onclick="clearSpell()">ğŸ§¹ æ¸…ç©º</button>
      </div>
      <div class="muted" style="margin-top:8px;">è½å®Œå¾Œï¼Œç”¨ä¸‹æ–¹å­—æ¯æ‹¼å‡ºè‹±æ–‡</div>
    </div>
  `;

  $("answerArea").innerHTML = `
    <div class="spellBox">
      <div class="slots" id="slots"></div>
      <div class="kbd" id="kbd"></div>
      <div class="footerRow" style="margin-top:10px;">
        <button class="btn btnGray" onclick="backspace()">âŒ« é€€æ ¼</button>
        <button class="btn btnBlue" onclick="submitSpell()">âœ… é€å‡º</button>
      </div>
    </div>
  `;

  renderSpell();
}

function renderSpell(){
  const slots = $("slots");
  slots.innerHTML="";
  const cleanTarget = spellTarget.replace(/[^a-z]/g,"");
  for(let i=0;i<cleanTarget.length;i++){
    const d=document.createElement("div");
    d.className="slot";
    d.textContent = (spellInput[i]||"").toUpperCase();
    slots.appendChild(d);
  }
  const kbd = $("kbd");
  kbd.innerHTML="";
  spellChars.forEach(ch=>{
    const b=document.createElement("button");
    b.className="kbtn";
    b.textContent = ch.toUpperCase();
    b.onclick = ()=>addChar(ch);
    kbd.appendChild(b);
  });
}

function addChar(ch){
  const cleanTarget = spellTarget.replace(/[^a-z]/g,"");
  if(spellInput.length >= cleanTarget.length) return;
  spellInput.push(ch);
  renderSpell();
}
function backspace(){
  spellInput.pop();
  renderSpell();
}
function clearSpell(){
  spellInput=[];
  renderSpell();
}
function submitSpell(){
  const cleanTarget = spellTarget.replace(/[^a-z]/g,"");
  const ans = (spellInput.join("")||"").toLowerCase();
  const ok = ans === cleanTarget;

  if(ok){
    correctCount++;
    $("toast").innerHTML = `<span class="ok">âœ… æ‹¼å°äº†ï¼</span>`;
  }else{
    $("toast").innerHTML = `<span class="no">âŒ å†è©¦è©¦ï¼ˆä½ æ‹¼çš„æ˜¯ï¼š${escapeHTML(ans.toUpperCase())}ï¼‰</span>`;
  }

  logAnswer({correct: ok, answer: ans, ms: Date.now()-levelStartMs, mode:"D", word:curWord});
}

/* =========================
   Answering for A/B
   ========================= */
function makeZhOptions(word, k){
  const pool = shuffle(WORDS.filter(w=>w.zh!==word.zh)).slice(0,k-1).map(w=>w.zh);
  const opts = shuffle([word.zh, ...pool]);
  return opts;
}

function answerChoice(mode, zh){
  const start = Date.now();
  const ok = (zh === curWord.zh);

  if(ok){
    correctCount++;
    $("toast").innerHTML = `<span class="ok">âœ… æ­£ç¢ºï¼</span>`;
  }else{
    $("toast").innerHTML = `<span class="no">âŒ éŒ¯äº†</span>`;
  }

  logAnswer({correct: ok, answer: zh, ms: Date.now()-start, mode, word:curWord});
}

/* =========================
   Next question / level finish
   ========================= */
function next(){
  // In mode C, only allow next when matching completed OR user chooses to skip
  if(curMode==="C" && matchDone < 5){
    $("toast").innerHTML = `<span class="no">é…å°å°šæœªå®Œæˆï¼ˆ${matchDone}/5ï¼‰</span>`;
    return;
  }

  qIndex++;
  updateUI();

  if(qIndex >= Q_PER_LEVEL){
    finishLevel();
    return;
  }

  renderQuestion();
  updateUI();
}

function finishLevel(){
  stopTick();
  $("barFill").style.width = "100%";

  const timeSec = Math.floor((Date.now()-levelStartMs)/1000);
  const score = correctCount;

  // mark completed at least once
  if(!state.completed[curLevel]){
    state.completed[curLevel] = true;

    // unlock next if this was the current unlocked level
    if(state.unlocked === curLevel){
      state.unlocked = Math.min(TOTAL_LEVELS, curLevel+1);
    }
  }

  // best
  const best = state.levelBest[curLevel];
  if(!best || score > best.bestScore || (score===best.bestScore && timeSec < best.bestTimeSec)){
    state.levelBest[curLevel] = {bestScore:score, bestTimeSec:timeSec};
  }

  // summary log
  state.logs.push({
    ts:new Date().toISOString(),
    student,
    level:curLevel,
    attemptNo:curAttemptNo,
    qIndex:"SUMMARY",
    mode:"SUMMARY",
    wordN:"",
    en:"",
    zh:"",
    correct:`${score}/${Q_PER_LEVEL}`,
    answer:`timeSec=${timeSec}`,
    ms: timeSec*1000
  });

  saveState();

  $("toast").innerHTML = `
    <div class="ok">ğŸ‰ ç¬¬ ${curLevel} é—œå®Œæˆï¼</div>
    <div class="muted">å¾—åˆ†ï¼š${score}/${Q_PER_LEVEL}ã€€æ™‚é–“ï¼š${formatTime(timeSec)}</div>
    <div class="muted">â­ æœ¬é—œä»å¯é‡ç©ï¼ˆç¬¬ N æ¬¡æŒ‘æˆ°æœƒå¦å¤–è¨˜éŒ„ï¼‰</div>
  `;
}

function formatTime(sec){
  const m = Math.floor(sec/60), r=sec%60;
  return `${m}:${String(r).padStart(2,"0")}`;
}

/* =========================
   Teacher export & stats
   ========================= */
function renderTeacherStats(){
  const students = loadStudents();
  if(students.length===0){
    $("teacherStats").innerHTML = `<div class="muted">ç›®å‰æ²’æœ‰è³‡æ–™ã€‚</div>`;
    return;
  }

  // Progress
  const prog = students.map(s=>{
    const st = loadState(s);
    return {student:s, unlocked:st.unlocked||1, completed:Object.keys(st.completed||{}).length};
  }).sort((a,b)=>b.unlocked-a.unlocked);

  // Wrong counts by word
  const wrong = new Map();
  const total = new Map();
  students.forEach(s=>{
    const st = loadState(s);
    (st.logs||[]).forEach(r=>{
      if(r.mode==="SUMMARY") return;
      if(!r.en) return;
      const key = `${r.en}ï½œ${r.zh}`;
      total.set(key, (total.get(key)||0)+1);
      if(r.correct===false) wrong.set(key, (wrong.get(key)||0)+1);
    });
  });

  const wrongTop = [...wrong.entries()]
    .map(([k,v])=>({k,v,t:total.get(k)||v}))
    .sort((a,b)=>b.v-a.v)
    .slice(0,12);

  $("teacherStats").innerHTML = `
    <div style="margin-top:10px;">
      <h2>ğŸ“ˆ å­¸ç”Ÿé€²åº¦</h2>
      <div class="muted">${prog.map(p=>`â€¢ ${escapeHTML(p.student)}ï¼šå·²è§£é–åˆ°ç¬¬ ${p.unlocked} é—œï¼ˆå·²å®Œæˆ ${p.completed} é—œï¼‰`).join("<br>")}</div>
    </div>
    <div style="margin-top:14px;">
      <h2>ğŸ“Š å¸¸éŒ¯å–®å­—ï¼ˆTop 12ï¼‰</h2>
      <div class="muted">
        ${wrongTop.length? wrongTop.map(x=>`â€¢ ${escapeHTML(x.k)}ï¼šéŒ¯ ${x.v} / å‡ºç¾ ${x.t}`).join("<br>") : "ç›®å‰æ²’æœ‰éŒ¯èª¤ç´€éŒ„"}
      </div>
    </div>
  `;
}

function exportCSV(){
  const students = loadStudents();
  let rows = [];
  const header = ["student","level","attemptNo","qIndex","mode","wordN","en","zh","correct","answer","ts","ms"].join(",");
  rows.push(header);

  students.forEach(s=>{
    const st = loadState(s);
    (st.logs||[]).forEach(r=>{
      const line = [
        csvSafe(r.student||s),
        csvSafe(r.level),
        csvSafe(r.attemptNo),
        csvSafe(r.qIndex),
        csvSafe(r.mode),
        csvSafe(r.wordN),
        csvSafe(r.en),
        csvSafe(r.zh),
        csvSafe(r.correct),
        csvSafe(r.answer),
        csvSafe(r.ts),
        csvSafe(r.ms)
      ].join(",");
      rows.push(line);
    });
  });

  downloadText(rows.join("\n"), "nmgo_export_all.csv");
}

function exportSummaryCSV(){
  const students = loadStudents();
  let rows = [];
  const header = ["student","level","attemptNo","score","timeSec","ts"].join(",");
  rows.push(header);

  students.forEach(s=>{
    const st = loadState(s);
    (st.logs||[]).forEach(r=>{
      if(r.mode!=="SUMMARY") return;
      const score = String(r.correct||"");
      const timeSec = String(r.answer||"").replace("timeSec=","");
      rows.push([
        csvSafe(r.student||s),
        csvSafe(r.level),
        csvSafe(r.attemptNo),
        csvSafe(score),
        csvSafe(timeSec),
        csvSafe(r.ts)
      ].join(","));
    });
  });

  downloadText(rows.join("\n"), "nmgo_export_summary.csv");
}

function downloadText(text, filename){
  const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* =========================
   Helpers: escaping
   ========================= */
function csvSafe(v){
  const s = String(v ?? "");
  // quote if contains comma/quote/newline
  if(/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}
function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}
function escapeJS(s){
  return String(s).replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/\n/g,"\\n").replace(/\r/g,"");
}

/* =========================
   Init: show login
   ========================= */
(function init(){
  // nothing else
})();
</script>
</body>
</html>
