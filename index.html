<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ¦Š å—é–€åœ‹å°è‹±æ–‡å–®å­—æŒ‘æˆ°ï½œ100é—œÃ—10å­—ï¼ˆä¸å£èªªï¼‰</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --text:#111; --muted:#666;
    --primary:#4f7cff; --secondary:#e9ecf3; --choice:#f0f3ff;
    --danger:#ff4d4f; --ok:#2ecc71;
  }
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);margin:0;padding:18px;color:var(--text);}
  .card{background:var(--card);max-width:520px;margin:0 auto;border-radius:16px;padding:18px;box-shadow:0 10px 25px rgba(0,0,0,.08);text-align:center;}
  h1{font-size:20px;margin:0 0 10px;}
  .topline{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:10px 0 14px;flex-wrap:wrap;}
  .pill{background:var(--secondary);padding:8px 10px;border-radius:999px;font-size:13px;color:#333;}
  .stars{font-size:14px;color:#333;}
  .word{font-size:34px;font-weight:800;margin:10px 0 6px;letter-spacing:.5px;}
  .sub{font-size:14px;color:var(--muted);margin:6px 0 10px;}
  .btn{width:100%;padding:12px 12px;margin:6px 0;border:none;border-radius:12px;font-size:16px;cursor:pointer;}
  .primary{background:var(--primary);color:#fff;}
  .secondary{background:var(--secondary);}
  .choice{background:var(--choice);}
  .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px;}
  .chip{padding:10px 12px;border-radius:12px;border:none;background:var(--secondary);cursor:pointer;font-size:16px;min-width:46px;}
  .chip:active{transform:scale(.98);}
  .tinyrow{display:flex;gap:8px;justify-content:center;margin-top:8px;flex-wrap:wrap;}
  .tinybtn{padding:10px 12px;border-radius:12px;border:none;background:var(--secondary);cursor:pointer;font-size:14px;}
  .hint{font-size:13px;color:var(--muted);margin-top:8px;}
  .msg{margin-top:8px;font-size:14px;}
  .ok{color:var(--ok);font-weight:700;}
  .bad{color:var(--danger);font-weight:700;}
  .divider{height:1px;background:#eee;margin:12px 0;}
  .left{text-align:left;}
  .table{width:100%;border-collapse:collapse;font-size:13px;margin-top:8px;}
  .table th,.table td{border-bottom:1px solid #eee;padding:8px 6px;text-align:left;}
  .k{color:#333;font-weight:700;}
  .muted{color:var(--muted);}
  .linkbtn{background:transparent;border:none;color:var(--primary);cursor:pointer;padding:0;font-size:14px;}
</style>
</head>
<body>
<div class="card">
  <h1>ğŸ¦Š æ‹¼å­—å°ç‹ç‹¸ï¼ˆä¸å£èªªï¼‰</h1>

  <div class="topline">
    <div class="pill" id="levelInfo">ğŸ¯ ç¬¬ 1 é—œï¼ˆ1/10ï¼‰</div>
    <div class="pill stars" id="starInfo">â­ 0</div>
    <button class="linkbtn" onclick="openTeacher()">ğŸ‘©â€ğŸ« è€å¸«å¾Œå°</button>
  </div>

  <div id="stage"></div>
</div>

<script>
/* ========= 153 å–®å­—ï¼ˆæ²¿ç”¨ä½ å…ˆå‰æ¸…å–®ï¼‰ ========= */
const WORDS = [
  {en:"able",zh:"èƒ½å¤ "},{en:"all",zh:"æ‰€æœ‰"},{en:"after",zh:"åœ¨â€¦ä¹‹å¾Œ"},
  {en:"and",zh:"å’Œ"},{en:"any",zh:"ä»»ä½•"},{en:"ant",zh:"èèŸ»"},
  {en:"apple",zh:"è˜‹æœ"},{en:"April",zh:"å››æœˆ"},{en:"ask",zh:"å•"},
  {en:"book",zh:"æ›¸"},{en:"ball",zh:"çƒ"},{en:"basket",zh:"ç±ƒå­"},
  {en:"banana",zh:"é¦™è•‰"},{en:"bank",zh:"éŠ€è¡Œ"},{en:"bath",zh:"æ´—æ¾¡"},
  {en:"bat",zh:"çƒæ£’;è™è "},{en:"beach",zh:"æµ·ç˜"},{en:"become",zh:"æˆç‚º"},
  {en:"bed",zh:"åºŠ"},{en:"bee",zh:"èœœèœ‚"},{en:"bite",zh:"å’¬"},
  {en:"bicycle",zh:"è…³è¸è»Š"},{en:"bird",zh:"é³¥"},
  {en:"black",zh:"é»‘è‰²"},{en:"blue",zh:"è—è‰²"},
  {en:"boat",zh:"èˆ¹"},{en:"box",zh:"ç›’å­"},
  {en:"boy",zh:"ç”·å­©"},{en:"bread",zh:"éºµåŒ…"},
  {en:"break",zh:"æ–·è£‚ï¼›æš«åœ"},{en:"brother",zh:"å…„å¼Ÿ"},
  {en:"cake",zh:"è›‹ç³•"},{en:"cap",zh:"æ£’çƒå¸½"},
  {en:"camp",zh:"ç‡Ÿåœ°ï¼›å¸³ç¯·"},{en:"card",zh:"å¡ç‰‡"},
  {en:"candy",zh:"ç³–æœ"},{en:"care",zh:"é—œæ‡·ï¼›ç…§é¡§"},
  {en:"catch",zh:"æŠ“"},{en:"chair",zh:"æ¤…å­"},
  {en:"chalk",zh:"ç²‰ç­†"},{en:"check",zh:"æ‰“å‹¾ï¼›ç¢ºèª"},
  {en:"cool",zh:"æ¶¼çˆ½çš„;é…·"},{en:"child",zh:"å°å­©"},
  {en:"circle",zh:"åœ“"},{en:"coffee",zh:"å’–å•¡"},
  {en:"cup",zh:"æ¯å­"},{en:"cute",zh:"å¯æ„›çš„"},
  {en:"dark",zh:"é»‘æš—çš„"},{en:"dance",zh:"è·³èˆ"},
  {en:"dear",zh:"è¦ªæ„›çš„"},{en:"desk",zh:"æ¡Œå­"},
  {en:"doctor",zh:"é†«ç”Ÿ"},{en:"dirty",zh:"é«’çš„"},
  {en:"doll",zh:"å¨ƒå¨ƒ"},{en:"dinner",zh:"æ™šé¤"},
  {en:"duck",zh:"é´¨å­"},{en:"early",zh:"æ—©çš„"},
  {en:"ear",zh:"è€³æœµ"},{en:"egg",zh:"è›‹"},
  {en:"elf",zh:"ç²¾éˆ"},{en:"elephant",zh:"å¤§è±¡"},
  {en:"eraser",zh:"æ©¡çš®æ“¦"},{en:"fact",zh:"äº‹å¯¦"},
  {en:"famous",zh:"æœ‰åçš„"},{en:"fast",zh:"å¿«é€Ÿ"},
  {en:"father",zh:"çˆ¸çˆ¸"},{en:"fin",zh:"é­šé°­"},
  {en:"feel",zh:"æ„Ÿè¦º"},{en:"find",zh:"å°‹æ‰¾"},
  {en:"first",zh:"ç¬¬ä¸€"},{en:"fix",zh:"ä¿®ç†"},
  {en:"flower",zh:"èŠ±"},{en:"food",zh:"é£Ÿç‰©"},
  {en:"forget",zh:"å¿˜è¨˜"},{en:"fork",zh:"å‰å­"},
  {en:"gas",zh:"ç“¦æ–¯"},{en:"girl",zh:"å¥³å­©"},
  {en:"game",zh:"éŠæˆ²"},{en:"goat",zh:"å±±ç¾Š"},
  {en:"green",zh:"ç¶ è‰²"},{en:"garden",zh:"èŠ±åœ’"},
  {en:"give",zh:"çµ¦äºˆ"},{en:"hat",zh:"å¸½å­"},
  {en:"ham",zh:"ç«è…¿"},{en:"hand",zh:"æ‰‹"},
  {en:"happy",zh:"å¿«æ¨‚çš„"},{en:"hair",zh:"é ­é«®"},
  {en:"hard",zh:"å›°é›£"},{en:"hear",zh:"è½"},
  {en:"heart",zh:"å¿ƒè‡Ÿ"},{en:"heat",zh:"ç™¼ç†±"},
  {en:"help",zh:"å¹«åŠ©"},{en:"in",zh:"åœ¨â€¦è£¡é¢"},
  {en:"ice",zh:"å†°"},{en:"igloo",zh:"å†°å±‹"},
  {en:"jam",zh:"æœé†¬"},{en:"jacket",zh:"å¤¾å…‹"},
  {en:"job",zh:"å·¥ä½œ"},{en:"jump",zh:"è·³"},
  {en:"kiss",zh:"è¦ªå»"},{en:"kite",zh:"é¢¨ç®"},
  {en:"key",zh:"é‘°åŒ™"},{en:"knee",zh:"è†è“‹"},
  {en:"lips",zh:"å˜´å”‡"},{en:"land",zh:"åœŸåœ°"},
  {en:"lamp",zh:"ç‡ˆ"},{en:"lazy",zh:"æ‡¶æƒ°"},
  {en:"leg",zh:"è…¿"},{en:"mask",zh:"é¢å…·"},
  {en:"map",zh:"åœ°åœ–"},{en:"mail",zh:"éƒµä»¶"},
  {en:"marker",zh:"å½©è‰²ç­†"},{en:"meat",zh:"è‚‰"},
  {en:"moon",zh:"æœˆäº®"},{en:"mother",zh:"åª½åª½"},
  {en:"near",zh:"é è¿‘"},{en:"neck",zh:"è„–å­"},
  {en:"need",zh:"éœ€è¦"},{en:"news",zh:"æ–°è"},
  {en:"noon",zh:"ä¸­åˆ"},{en:"nose",zh:"é¼»å­"},
  {en:"oil",zh:"æ²¹"},{en:"old",zh:"è€çš„ï¼›èˆŠçš„"},
  {en:"only",zh:"å”¯ä¸€"},{en:"page",zh:"é æ•¸"},
  {en:"pet",zh:"å¯µç‰©"},{en:"pencil",zh:"é‰›ç­†"},
  {en:"pizza",zh:"æ¯”è–©"},{en:"pot",zh:"é‹å­"},
  {en:"pillow",zh:"æ•é ­"},{en:"queen",zh:"çš‡å"},
  {en:"question",zh:"å•é¡Œ"},{en:"quick",zh:"å¿«çš„"},
  {en:"rat",zh:"é¼ "},{en:"rain",zh:"é›¨"},
  {en:"red",zh:"ç´…è‰²"},{en:"robot",zh:"æ©Ÿå™¨äºº"},
  {en:"ruler",zh:"å°º"},{en:"sand",zh:"æ²™"},
  {en:"same",zh:"ç›¸åŒ"},{en:"send",zh:"é€"},
  {en:"sew",zh:"ç¸«è£œ"},{en:"sing",zh:"å”±æ­Œ"},
  {en:"sister",zh:"å§å¦¹"},{en:"seven",zh:"7"},
  {en:"table",zh:"æ¡Œå­"},{en:"talk",zh:"èªªè©±"},
  {en:"thank",zh:"æ„Ÿè¬"},{en:"three",zh:"3"},
  {en:"teacher",zh:"è€å¸«"},{en:"tree",zh:"æ¨¹"},
  {en:"tub",zh:"æµ´ç¼¸"},{en:"turtle",zh:"çƒé¾œ"},
  {en:"up",zh:"ä¸Šé¢"},{en:"yellow",zh:"é»ƒè‰²"}
];

/* ========= éŠæˆ²è¨­å®š ========= */
const PER_LEVEL = 10;
const TOTAL_LEVELS = 100;

/* ========= storage keys ========= */
const K_PROGRESS = "fox_progress_v2";
const K_STATS    = "fox_stats_v2";

/* ========= åˆå§‹åŒ–ç‹€æ…‹ =========
progress: level(1..100), q(1..10), stage('listen'|'choice'|'spell'|'summary'),
current: {en,zh}, listened, typed, triesStage {choice,spell}, starsThisLevel, wrongThisLevel[]
stats:
  wordStats[en]={listen:0,choice:0,spell:0,seen:0,correct:0}
  history[level]={stars, wrong:[{en,at:'choice'|'spell'}], doneAtISO}
*/
const DEFAULT = {
  progress:{
    level:1, q:1, stage:"listen",
    current:null, listened:false,
    typed:"",
    tries:{choice:0,spell:0},
    starsThisLevel:0,
    wrongThisLevel:[],
    // é˜²æ­¢åŒä¸€é¡Œä¸€ç›´æŠ½åˆ°åŒå­—ï¼ˆå°å­©æœƒè¦ºå¾—bugï¼‰
    recent:[]
  },
  stats:{
    wordStats:{},
    history:{}
  }
};

function loadAll(){
  try{
    const rawP = localStorage.getItem(K_PROGRESS);
    const rawS = localStorage.getItem(K_STATS);
    const p = rawP ? JSON.parse(rawP) : DEFAULT.progress;
    const s = rawS ? JSON.parse(rawS) : DEFAULT.stats;
    // merge
    return {
      progress:{...DEFAULT.progress, ...p},
      stats:{...DEFAULT.stats, ...s}
    };
  }catch(e){
    return JSON.parse(JSON.stringify(DEFAULT));
  }
}
let state = loadAll();

function saveAll(){
  localStorage.setItem(K_PROGRESS, JSON.stringify(state.progress));
  localStorage.setItem(K_STATS, JSON.stringify(state.stats));
}

/* ========= helpers ========= */
const stageEl = document.getElementById("stage");
const levelInfoEl = document.getElementById("levelInfo");
const starInfoEl = document.getElementById("starInfo");

function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }

function starString(n){
  const m = clamp(n,0,10);
  return "â­".repeat(m) + "â˜†".repeat(10-m);
}

function ensureWordStat(en){
  const ws = state.stats.wordStats;
  if(!ws[en]) ws[en]={listen:0,choice:0,spell:0,seen:0,correct:0};
  return ws[en];
}

function speak(text){
  // iOS: ç¬¬ä¸€æ¬¡æœ€å¥½ç”±ä½¿ç”¨è€…é»æ“Šè§¸ç™¼ï¼ˆæˆ‘å€‘å°±æ˜¯æŒ‰ã€Œè½ã€ï¼‰
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ========= é¡Œç›®æŠ½é¸ï¼ˆæ–°å­—70% + éŒ¯é¡Œå›é‹30%ï¼‰ =========
- â€œæ–°å­—â€ï¼šseenè¼ƒå°‘çš„å­—ï¼ˆseen==0å„ªå…ˆï¼‰
- â€œå›é‹â€ï¼šéŒ¯èª¤æ¬¡æ•¸é«˜çš„å­—ï¼ˆchoice+spellè¶Šé«˜æ¬Šé‡è¶Šå¤§ï¼‰
- recent é¿å…é€£æŠ½åŒå­—
*/
function pickWord(){
  const ws = state.stats.wordStats;
  const recent = state.progress.recent || [];
  // å»ºç«‹è©•åˆ†
  const items = WORDS.map(w=>{
    const st = ws[w.en] || {listen:0,choice:0,spell:0,seen:0,correct:0};
    const err = (st.choice||0) + (st.spell||0);
    const seen = st.seen||0;
    const isRecent = recent.includes(w.en);
    return {w, err, seen, isRecent};
  });

  const wantReview = Math.random() < 0.30; // 30%å›é‹
  let pool;

  if(wantReview){
    // å›é‹æ± ï¼šæœ‰éŒ¯èª¤çš„å„ªå…ˆï¼›éƒ½æ²’éŒ¯å°±é€€å›æ–°å­—æ± 
    pool = items.filter(x=>x.err>0 && !x.isRecent);
    if(pool.length===0) pool = items.filter(x=>!x.isRecent);
    // æ¬Šé‡ï¼šéŒ¯è¶Šå¤šè¶Šå¸¸å‡ºï¼ˆerr+1ï¼‰
    return weightedPick(pool, x => (x.err+1) * 3);
  }else{
    // æ–°å­—æ± ï¼šseenæœ€å°‘çš„å„ªå…ˆ
    pool = items.filter(x=>!x.isRecent);
    // æ¬Šé‡ï¼šseenè¶Šå°‘è¶Šå¤§ï¼ˆ1/(seen+1)ï¼‰
    return weightedPick(pool, x => 5/(x.seen+1));
  }
}

function weightedPick(pool, weightFn){
  let total = 0;
  const weights = pool.map(x=>{
    const w = Math.max(0.0001, weightFn(x));
    total += w;
    return w;
  });
  let r = Math.random()*total;
  for(let i=0;i<pool.length;i++){
    r -= weights[i];
    if(r<=0) return pool[i].w;
  }
  return pool[pool.length-1].w;
}

/* ========= UI render ========= */
function renderTop(){
  const p = state.progress;
  levelInfoEl.textContent = `ğŸ¯ ç¬¬ ${p.level} é—œï¼ˆ${p.q}/${PER_LEVEL}ï¼‰`;
  starInfoEl.textContent = `${starString(p.starsThisLevel)}  (${p.starsThisLevel}/10)`;
}

function setMessage(html){
  const el = document.getElementById("msg");
  if(el) el.innerHTML = html;
}

function startNewQuestion(){
  const p = state.progress;
  const w = pickWord();
  p.current = {en:w.en, zh:w.zh};
  p.stage = "listen";
  p.listened = false;
  p.typed = "";
  p.tries = {choice:0, spell:0};

  // recent queue
  p.recent = Array.isArray(p.recent) ? p.recent : [];
  p.recent.unshift(w.en);
  p.recent = p.recent.slice(0,5);

  const st = ensureWordStat(w.en);
  st.seen += 1;
  saveAll();
  render();
}

function goStage(nextStage){
  state.progress.stage = nextStage;
  saveAll();
  render();
}

function nextQuestion(){
  const p = state.progress;
  if(p.q >= PER_LEVEL){
    // level done
    finishLevel();
  }else{
    p.q += 1;
    saveAll();
    startNewQuestion();
  }
}

function finishLevel(){
  const p = state.progress;
  const level = p.level;

  state.stats.history[level] = {
    stars: p.starsThisLevel,
    wrong: p.wrongThisLevel,
    doneAtISO: new Date().toISOString()
  };

  p.stage = "summary";
  saveAll();
  render();
}

function nextLevel(){
  const p = state.progress;
  if(p.level >= TOTAL_LEVELS){
    // å…¨éƒ¨é—œå¡å®Œæˆï¼ˆä»å¯ç¹¼çºŒç·´ï¼‰
    p.level = TOTAL_LEVELS;
  }else{
    p.level += 1;
  }
  p.q = 1;
  p.starsThisLevel = 0;
  p.wrongThisLevel = [];
  saveAll();
  startNewQuestion();
}

/* ========= Game screens ========= */
function render(){
  renderTop();
  const p = state.progress;
  const cur = p.current;

  // åˆæ¬¡é€²ä¾†æ²’æœ‰é¡Œç›® â†’ å…ˆé–‹ç¬¬ä¸€é¡Œ
  if(!cur && p.stage!=="summary"){
    startNewQuestion();
    return;
  }

  if(p.stage === "listen"){
    stageEl.innerHTML = `
      <div class="word">${cur.en}</div>
      <button class="btn secondary" onclick="onListen()">ğŸ”Š è½ï¼ˆé»é€™è£¡ï¼‰</button>
      <button class="btn primary" onclick="toChoice()" ${p.listened ? "" : "disabled"} style="${p.listened? "" : "opacity:.45;cursor:not-allowed;"}">ä¸‹ä¸€æ­¥ï¼šé¸ä¸­æ–‡</button>
      <div class="sub">è¦å‰‡ï¼šè¦å…ˆæŒ‰ã€Œè½ã€æ‰æœƒè§£é–ä¸‹ä¸€æ­¥</div>
      <div id="msg" class="msg"></div>
    `;
    setMessage(p.listened ? `<span class="ok">âœ” å·²è½éäº†ï¼</span> å¯ä»¥é€²ä¸‹ä¸€æ­¥` : `<span class="muted">å…ˆæŒ‰ä¸€æ¬¡ã€ŒğŸ”Š è½ã€</span>`);
    return;
  }

  if(p.stage === "choice"){
    const correct = cur.zh;
    const distractors = pickDistractors(correct, 3);
    const options = shuffle([correct, ...distractors]).slice(0,3);

    stageEl.innerHTML = `
      <div class="word">${cur.en}</div>
      <div class="sub">é€™å€‹å–®å­—æ˜¯ä»€éº¼æ„æ€ï¼Ÿ</div>
      ${options.map(o=>`<button class="btn choice" onclick="onChoice('${escapeHtml(o)}')">${escapeHtml(o)}</button>`).join("")}
      <div class="tinyrow">
        <button class="tinybtn" onclick="reListen()">ğŸ”Š å†è½ä¸€æ¬¡</button>
        <button class="tinybtn" onclick="backToListen()">â¬… å›åˆ°ã€Œè½ã€</button>
      </div>
      <div id="msg" class="msg"></div>
    `;
    setMessage(`<span class="muted">æç¤ºï¼šå…ˆæƒ³ç•«é¢/æƒ…å¢ƒï¼Œå†é¸</span>`);
    return;
  }

  if(p.stage === "spell"){
    const en = cur.en;
    const letters = makeLetterBank(en);
    const typedDisplay = p.typed || "_".repeat(en.length);

    stageEl.innerHTML = `
      <div class="word">${typedDisplay}</div>
      <div class="sub">è«‹æ‹¼å‡ºå‰›å‰›è½åˆ°çš„å–®å­—</div>

      <div class="row">
        ${letters.map(ch=>`<button class="chip" onclick="addLetter('${escapeHtml(ch)}')">${escapeHtml(ch)}</button>`).join("")}
      </div>

      <div class="tinyrow">
        <button class="tinybtn" onclick="backspace()">âŒ« é€€æ ¼</button>
        <button class="tinybtn" onclick="clearTyped()">ğŸ§¹ æ¸…ç©º</button>
        <button class="tinybtn" onclick="reListen()">ğŸ”Š å†è½ä¸€æ¬¡</button>
      </div>

      <button class="btn primary" onclick="checkSpell()">ç¢ºèª</button>
      <div class="hint">æç¤ºï¼šç¬¬ä¸€å€‹å­—æ¯æ˜¯ <b>${escapeHtml(en[0])}</b></div>
      <div id="msg" class="msg"></div>
    `;
    setMessage(`<span class="muted">æ‹¼å°å°±éé—œï¼</span>`);
    return;
  }

  if(p.stage === "summary"){
    const hist = state.stats.history[p.level] || {stars:p.starsThisLevel, wrong:p.wrongThisLevel};
    const wrong = hist.wrong || [];
    const wrongList = wrong.length
      ? `<div class="left"><div class="k">âŒ æœ¬é—œéŒ¯é¡Œ</div>${wrong.map(x=>`<div class="muted">- ${escapeHtml(x.en)}ï¼ˆ${x.at==="choice"?"é¸ä¸­æ–‡":"æ‹¼å­—"}ï¼‰</div>`).join("")}</div>`
      : `<div class="ok">æœ¬é—œå…¨å°ï¼</div>`;

    stageEl.innerHTML = `
      <h2 style="margin:6px 0 10px;">ğŸ‰ ç¬¬ ${p.level} é—œå®Œæˆï¼</h2>
      <div class="pill" style="display:inline-block;">â­ æ­£ç¢º ${hist.stars}/10</div>
      <div class="divider"></div>
      ${wrongList}
      <div class="divider"></div>
      <button class="btn primary" onclick="nextLevel()">â¡ ä¸‹ä¸€é—œ</button>
      <button class="btn secondary" onclick="openTeacher()">ğŸ‘©â€ğŸ« çœ‹è€å¸«å¾Œå°</button>
    `;
    return;
  }
}

/* ========= actions ========= */
function onListen(){
  const p = state.progress;
  const cur = p.current;
  // è¨˜ä¸€æ¬¡ listen éŒ¯èª¤ä¸ç®—ï¼Œé€™é‚Šåªç•¶ã€Œæœ‰æŒ‰éè½ã€
  p.listened = true;
  saveAll();
  speak(cur.en);
  render();
}

function toChoice(){
  if(!state.progress.listened) return;
  goStage("choice");
}

function backToListen(){
  goStage("listen");
}

function reListen(){
  const cur = state.progress.current;
  speak(cur.en);
}

function pickDistractors(correctZh, n){
  const pool = WORDS.map(w=>w.zh).filter(z=>z!==correctZh);
  // å»é‡
  const uniq = [...new Set(pool)];
  return shuffle(uniq).slice(0,n);
}

function onChoice(optZh){
  const p = state.progress;
  const cur = p.current;
  const ws = ensureWordStat(cur.en);
  p.tries.choice += 1;

  if(optZh === cur.zh){
    // first-try æ‰çµ¦æ˜Ÿ
    if(p.tries.choice === 1) p.starsThisLevel += 1;
    ws.correct += 1;
    saveAll();
    goStage("spell");
  }else{
    ws.choice += 1;
    // æœ¬é—œéŒ¯é¡Œè¨˜éŒ„ï¼ˆé¿å…é‡è¤‡å¡åŒä¸€å­—åŒä¸€éšæ®µï¼‰
    addWrongOnce(cur.en, "choice");
    saveAll();
    setMessage(`<span class="bad">ä¸å°å–”ï½</span> å†æƒ³æƒ³ï¼ˆå¯æŒ‰ ğŸ”Š å†è½ä¸€æ¬¡ï¼‰`);
  }
}

function makeLetterBank(en){
  // åŸºæœ¬ï¼šå…¨å­—æ¯ + 2 å€‹å¹²æ“¾å­—æ¯ï¼ˆå¾å¸¸è¦‹å­—æ¯å–ï¼‰
  const extras = "aeiourstnlpm".split("");
  const add = [];
  while(add.length < 2){
    const c = extras[Math.floor(Math.random()*extras.length)];
    if(!en.includes(c)) add.push(c);
  }
  return shuffle(en.split("").concat(add)).slice(0, en.length+2);
}

function addLetter(ch){
  const p = state.progress;
  const en = p.current.en;
  if(p.typed.length >= en.length) return;
  p.typed += ch;
  saveAll();
  render();
}

function backspace(){
  const p = state.progress;
  p.typed = p.typed.slice(0,-1);
  saveAll();
  render();
}
function clearTyped(){
  state.progress.typed = "";
  saveAll();
  render();
}

function checkSpell(){
  const p = state.progress;
  const cur = p.current;
  const ws = ensureWordStat(cur.en);
  p.tries.spell += 1;

  if(p.typed.toLowerCase() === cur.en.toLowerCase()){
    // first-try æ‰åŠ æ˜Ÿï¼ˆæ‹¼å­—æ˜Ÿï¼‰
    if(p.tries.spell === 1) p.starsThisLevel += 1;
    ws.correct += 1;
    saveAll();
    setMessage(`<span class="ok">âœ” æ‹¼å°äº†ï¼</span>`);
    // ç¨å¾®å»¶é²è®“å°å­©çœ‹åˆ°æˆåŠŸ
    setTimeout(()=>nextQuestion(), 450);
  }else{
    ws.spell += 1;
    addWrongOnce(cur.en, "spell");
    saveAll();
    setMessage(`<span class="bad">å·®ä¸€é»ï½</span> å†è©¦ä¸€æ¬¡ï¼ˆå¯å…ˆæŒ‰ ğŸ”Š å†è½ä¸€æ¬¡ï¼‰`);
  }
}

function addWrongOnce(en, at){
  const p = state.progress;
  p.wrongThisLevel = Array.isArray(p.wrongThisLevel) ? p.wrongThisLevel : [];
  if(!p.wrongThisLevel.some(x=>x.en===en && x.at===at)){
    p.wrongThisLevel.push({en, at});
  }
}

/* ========= teacher dashboard ========= */
function openTeacher(){
  const ws = state.stats.wordStats || {};
  const entries = Object.keys(ws).map(en=>{
    const s = ws[en];
    return {en, listen:s.listen||0, choice:s.choice||0, spell:s.spell||0, seen:s.seen||0, correct:s.correct||0, err:(s.choice||0)+(s.spell||0)};
  }).sort((a,b)=>b.err-a.err || b.seen-a.seen);

  const doneLevels = Object.keys(state.stats.history||{}).length;
  const p = state.progress;

  const top10 = entries.filter(x=>x.err>0).slice(0,10);

  stageEl.innerHTML = `
    <div class="left">
      <h2 style="margin:6px 0 8px;">ğŸ‘©â€ğŸ« è€å¸«å¾Œå°</h2>
      <div class="pill">é€²åº¦ï¼šç¬¬ ${p.level} é—œï¼ˆ${p.q}/${PER_LEVEL}ï¼‰</div>
      <div class="pill" style="margin-left:6px;">å·²å®Œæˆé—œå¡ï¼š${doneLevels}/${TOTAL_LEVELS}</div>

      <div class="divider"></div>

      <div class="k">ğŸ“Œ æœ€å¸¸éŒ¯ Top 10</div>
      ${top10.length ? `
        <table class="table">
          <thead><tr><th>å–®å­—</th><th>é¸éŒ¯</th><th>æ‹¼éŒ¯</th><th>ç¸½éŒ¯</th></tr></thead>
          <tbody>
            ${top10.map(x=>`<tr><td class="k">${escapeHtml(x.en)}</td><td>${x.choice}</td><td>${x.spell}</td><td><b>${x.err}</b></td></tr>`).join("")}
          </tbody>
        </table>
      ` : `<div class="muted">ç›®å‰æ²’æœ‰éŒ¯èª¤ç´€éŒ„ã€‚</div>`}

      <div class="divider"></div>

      <div class="k">ğŸ“Š å…¨éƒ¨å–®å­—çµ±è¨ˆï¼ˆä¾éŒ¯èª¤æ’åºï¼‰</div>
      <table class="table">
        <thead><tr><th>å–®å­—</th><th>çœ‹é</th><th>é¸éŒ¯</th><th>æ‹¼éŒ¯</th><th>ç¸½éŒ¯</th></tr></thead>
        <tbody>
          ${entries.slice(0,50).map(x=>`
            <tr>
              <td class="k">${escapeHtml(x.en)}</td>
              <td>${x.seen}</td>
              <td>${x.choice}</td>
              <td>${x.spell}</td>
              <td><b>${x.err}</b></td>
            </tr>
          `).join("")}
        </tbody>
      </table>

      <div class="divider"></div>

      <button class="btn secondary" onclick="render()">â¬… å›åˆ°éŠæˆ²</button>
      <button class="btn secondary" onclick="resetAll()">ğŸ§¹ æ¸…é™¤é€²åº¦/çµ±è¨ˆï¼ˆé‡æ–°é–‹å§‹ï¼‰</button>
    </div>
  `;
}

function resetAll(){
  if(!confirm("ç¢ºå®šè¦æ¸…é™¤é€²åº¦èˆ‡çµ±è¨ˆå—ï¼Ÿï¼ˆæœƒå…¨éƒ¨é‡ä¾†ï¼‰")) return;
  localStorage.removeItem(K_PROGRESS);
  localStorage.removeItem(K_STATS);
  state = loadAll();
  render();
}

/* ========= misc ========= */
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function shuffle(arr){
  const a = [...arr];
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* ========= start ========= */
render();
</script>
</body>
</html>
