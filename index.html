<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <title>å—é–€åœ‹å°æ‹¼å­—æŒ‘æˆ° Go</title>
  <style>
    :root{
      --bg1:#f7fbff; --bg2:#eef4ff;
      --card:#ffffffcc; --card2:#fff;
      --text:#0f172a; --muted:#64748b;
      --primary:#2563eb; --primary2:#1d4ed8;
      --good:#16a34a; --bad:#ef4444; --warn:#f59e0b;
      --shadow: 0 14px 34px rgba(2,6,23,.10);
      --radius: 22px;
      --chip:#e7efff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 18% 10%, #ffffff, transparent 62%),
        radial-gradient(900px 600px at 92% 28%, #dbeafe, transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1050px;margin:0 auto;padding:16px 14px 42px;}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin:6px 0 12px;
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:46px;height:46px;border-radius:16px;
      background: linear-gradient(135deg, #60a5fa, #22c55e);
      display:grid;place-items:center;color:#fff;
      box-shadow: var(--shadow);
      font-size:22px;
    }
    .title{line-height:1.1}
    .title h1{margin:0;font-size:20px;}
    .title p{margin:3px 0 0;color:var(--muted);font-size:12px;font-weight:800}
    .topbtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    button{
      border:0;border-radius:14px;
      padding:10px 12px;
      background:#fff;color:var(--text);
      box-shadow: 0 12px 26px rgba(2,6,23,.08);
      cursor:pointer;font-weight:900;
    }
    button.primary{background: linear-gradient(180deg, var(--primary), var(--primary2)); color:#fff;}
    button.ghost{background:#ffffffbb}
    button.small{padding:8px 10px;border-radius:12px}
    button:disabled{opacity:.45; cursor:not-allowed}

    .grid{display:grid; gap:12px;}
    @media(min-width:900px){ .grid.cols2{grid-template-columns: 1.1fr .9fr;} }

    .card{
      background: var(--card);
      border:1px solid rgba(15,23,42,.06);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding:16px;
      backdrop-filter: blur(8px);
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:#fff;border:1px solid rgba(15,23,42,.08);
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
      font-weight:900;
    }
    .chip{
      background: var(--chip);
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(37,99,235,.14);
      font-weight:1000;
      display:inline-flex;gap:8px;align-items:center;
    }
    .chip b{font-weight:1000}
    .input{
      width:min(360px, 92vw);
      padding:12px;border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      font-size:16px; outline:none;
      font-weight:800;
    }

    .kpi{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;}
    @media(max-width:900px){ .kpi{grid-template-columns: repeat(2, 1fr);} }
    .k{
      background:#fff;border:1px solid rgba(15,23,42,.08);
      border-radius:18px;padding:10px;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
    }
    .k .v{font-size:18px;font-weight:1000}
    .k .l{font-size:12px;color:var(--muted);font-weight:900}

    .progressbar{
      height:10px;width:100%;
      background: rgba(15,23,42,.08);
      border-radius:999px;overflow:hidden;
    }
    .progressbar > div{
      height:100%; width:0%;
      background: linear-gradient(90deg, #22c55e, #60a5fa);
      border-radius:999px;
      transition: width .25s ease;
    }

    /* badges */
    .badges{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .badge{
      background:#fff;
      border:1px solid rgba(15,23,42,.08);
      border-radius:18px;
      padding:10px 12px;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
      display:flex; gap:10px; align-items:center;
      min-width: 220px;
    }
    .badge .ico{font-size:22px}
    .badge .t{font-weight:1000}
    .badge .d{font-size:12px;color:var(--muted);font-weight:900;margin-top:2px}
    .badge.lock{opacity:.45; filter:grayscale(.35)}
    .badge.unlocked{outline:4px solid rgba(34,197,94,.18)}

    /* map */
    .map{
      position:relative;
      overflow:hidden;
      border-radius: var(--radius);
      border:1px solid rgba(15,23,42,.06);
      background: linear-gradient(180deg, #ffffffcc, #f8fbffcc);
      box-shadow: var(--shadow);
      min-height: 540px;
    }
    .mapInner{
      height: 540px;
      overflow:auto;
      padding:16px 14px 26px;
      scroll-behavior:smooth;
    }
    .path{
      position:relative;
      width:100%;
      min-height: 1700px;
      padding-bottom: 40px;
    }
    .node{
      position:absolute;
      width:74px; height:74px;
      border-radius: 24px;
      display:grid; place-items:center;
      font-weight:1000;
      user-select:none;
      border:1px solid rgba(15,23,42,.10);
      box-shadow: 0 14px 24px rgba(2,6,23,.10);
      background:#fff;
    }
    .node .n{font-size:13px}
    .node .i{font-size:21px; line-height:1}
    .node.locked{opacity:.42; filter:grayscale(.35)}
    .node.passed{
      background: linear-gradient(180deg, #dcfce7, #bbf7d0);
      border-color: rgba(22,163,74,.25);
    }
    .node.current{outline:4px solid rgba(37,99,235,.20)}
    .node:active{transform: translateY(1px)}

    /* game */
    #screenGame{display:none}
    .gameHeader{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;
    }
    .modeTag{
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      padding:8px 12px; border-radius:999px; background:#fff;
      border:1px solid rgba(15,23,42,.08); font-weight:1000;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
    }
    .barRow{display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; margin-top:10px}
    .range{width:min(260px, 86vw)}
    .bigTitle{
      text-align:center;
      font-size:26px;
      font-weight:1000;
      margin:12px 0 6px;
    }
    .sub{
      text-align:center;
      color:var(--muted);
      font-weight:900;
      margin:0 0 12px;
    }
    .choices{display:grid; gap:10px}
    @media(min-width:620px){ .choices.grid2{grid-template-columns:1fr 1fr;} }
    .choice{
      background:#fff;
      border:1px solid rgba(15,23,42,.08);
      padding:14px 14px;
      border-radius: 18px;
      font-size:20px; font-weight:1000;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
      cursor:pointer;
      text-align:center;
      user-select:none;
    }
    .choice:hover{transform: translateY(-1px)}
    .choice.correct{border-color: rgba(22,163,74,.35); background: #dcfce7;}
    .choice.wrong{border-color: rgba(239,68,68,.35); background: #fee2e2;}

    .status{
      text-align:center;
      font-weight:1000;
      margin-top:8px;
      min-height: 26px;
    }
    .status.good{color:var(--good)}
    .status.bad{color:var(--bad)}
    .reveal{
      margin-top:6px;
      text-align:center;
      font-weight:1000;
      color:var(--muted);
      min-height:22px;
    }
    .footerBtns{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:14px;}

    /* matching mini */
    .matchWrap{display:grid; gap:10px; margin-top:10px}
    .matchGrid{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .tile{
      background:#fff;
      border:1px solid rgba(15,23,42,.08);
      border-radius:18px;
      padding:14px 12px;
      font-weight:1000;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
      cursor:pointer;
      min-height:54px;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      user-select:none;
    }
    .tile.sel{outline:4px solid rgba(37,99,235,.20)}
    .tile.done{opacity:.42}
    .tile.ok{background:#dcfce7; border-color: rgba(22,163,74,.35)}
    .tile.no{background:#fee2e2; border-color: rgba(239,68,68,.35)}

    /* spell */
    .spellBox{
      background:#fff;
      border:1px solid rgba(15,23,42,.08);
      border-radius:18px;
      padding:12px;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
    }
    .spellInput{
      width:min(360px, 92vw);
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      font-size:18px;
      font-weight:900;
      outline:none;
    }

    /* modal teacher */
    .modal{
      position:fixed; inset:0;
      display:none; place-items:center;
      background: rgba(2,6,23,.55);
      padding:16px;
      z-index: 60;
    }
    .modal .panel{
      width:min(1000px, 96vw);
      max-height: 86vh;
      overflow:auto;
      background:#fff;
      border-radius: 22px;
      box-shadow: 0 28px 70px rgba(2,6,23,.25);
      padding:16px;
    }
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{border-bottom:1px solid rgba(15,23,42,.08); padding:8px; text-align:left; vertical-align:top}
    th{background:#f8fafc}
    .right{text-align:right}
    .note{font-size:12px; color:var(--muted); font-weight:800; line-height:1.5}

    /* FX canvas */
    #fx{position:fixed; inset:0; pointer-events:none; z-index: 50;}
  </style>
</head>

<body>
<canvas id="fx"></canvas>

<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">ğŸ«</div>
      <div class="title">
        <h1>å—é–€åœ‹å°æ‹¼å­—æŒ‘æˆ° Go</h1>
        <p>å®Œæ•´153å–®å­—ï½œ100é—œåœ°åœ–ï½œæ¯é—œ10é¡Œï½œé¡Œå‹å¯é¸ A/B/C/D/å…¨é¸ï½œå¾½ç« ï¼†é€£çºŒç­”å°å‹•ç•«</p>
      </div>
    </div>
    <div class="topbtns">
      <button class="small ghost" id="btnFullscreen">ğŸ–¥ï¸ å…¨è¢å¹•</button>
      <button class="small" id="btnMap">ğŸ—ºï¸ åœ°åœ–</button>
      <button class="small" id="btnTeacher">ğŸ‘©â€ğŸ« è€å¸«å¾Œå°</button>
    </div>
  </header>

  <div id="screenMap" class="grid cols2">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="pill">ğŸ‘¦ å­¸ç”Ÿç™»å…¥</span>
          <span class="chip">ç›®å‰ï¼š<b id="curStudent">æœªç™»å…¥</b></span>
        </div>
        <div class="row">
          <button class="small" id="btnSwitch">ğŸ” åˆ‡æ›</button>
          <button class="small primary" id="btnStartNext">â–¶ï¸ é–‹å§‹ä¸‹ä¸€é—œ</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <input class="input" id="studentInput" placeholder="è¼¸å…¥å­¸ç”Ÿå§“åï¼ˆä¾‹ï¼šå°æ˜ï¼‰" />
        <button class="primary" id="btnLogin">ç™»å…¥</button>
      </div>

      <div class="card" style="margin-top:12px; background:#fff">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="row">
              <span class="pill">ğŸ¯ é€²åº¦</span>
              <span class="chip">å·²é€šé—œï¼š<b id="passedCount">0</b>/100</span>
              <span class="chip">ä¸‹ä¸€é—œï¼š<b id="nextLevel">1</b></span>
            </div>
            <div class="note" style="margin-top:8px">
              é€šé—œé–€æª»ï¼š<b id="passRule">8/10</b>ï¼ˆå¯é‡ç©ï¼Œå–æœ€ä½³åˆ†æ•¸ï¼‰
            </div>
          </div>
          <div style="min-width:260px">
            <div class="pill">ğŸ§© é¡Œå‹é¸æ“‡</div>
            <div class="row" style="margin-top:8px; gap:8px">
              <label class="chip"><input type="radio" name="modePick" value="ALL" checked> å…¨é¸</label>
              <label class="chip"><input type="radio" name="modePick" value="A"> A</label>
              <label class="chip"><input type="radio" name="modePick" value="B"> B</label>
              <label class="chip"><input type="radio" name="modePick" value="C"> C</label>
              <label class="chip"><input type="radio" name="modePick" value="D"> D</label>
            </div>
            <div class="note" style="margin-top:6px">
              å…¨é¸ï¼šæ¯é—œ10é¡ŒæœƒåŒ…å« A/B/C/Dï¼Œä¸”å››ç¨®ä¸€å®šéƒ½æœƒå‡ºç¾ã€‚
            </div>
          </div>
        </div>
        <div style="margin-top:10px" class="progressbar"><div id="overallBar"></div></div>
      </div>

      <div class="card" style="margin-top:12px; background:#fff">
        <div class="row" style="justify-content:space-between; align-items:center">
          <span class="pill">ğŸ… å¾½ç« </span>
          <span class="chip">å·²è§£é–ï¼š<b id="badgeCount">0</b>/4</span>
        </div>
        <div class="badges" id="badges"></div>
      </div>

      <div class="note" style="margin-top:10px">
        âœ… åŒä¸€å°è£ç½®å¯è¨˜éŒ„å¤šä½å­¸ç”Ÿã€‚<br>
        âš ï¸ GitHub Pages æ˜¯éœæ…‹ç¶²ç«™ï¼šä¸åŒæ‰‹æ©Ÿçš„è³‡æ–™ä¸æœƒè‡ªå‹•é›†ä¸­ï¼ˆéœ€è¦ç”¨è€å¸«å¾Œå°åŒ¯å‡ºCSV/JSONå½™æ•´ï¼‰ã€‚
      </div>
    </div>

    <div class="map">
      <div class="mapInner" id="mapInner">
        <div class="path" id="path"></div>
      </div>
    </div>
  </div>

  <div id="screenGame">
    <div class="card">
      <div class="gameHeader">
        <div class="row">
          <span class="pill">ğŸ¯ ç¬¬ <b id="gLevel">1</b> é—œ</span>
          <span class="chip">ç¬¬ <b id="gQ">1</b>/10 é¡Œ</span>
          <span class="chip">â­ <b id="gScore">0</b>/10</span>
          <span class="chip">ğŸ”¥ é€£çºŒç­”å° <b id="gStreak">0</b></span>
          <span class="chip">â±ï¸ <b id="gTime">0:00</b></span>
        </div>
        <div class="row">
          <span class="modeTag" id="gModeTag">A</span>
          <button class="small" id="btnPrevQ">â¬…ï¸ ä¸Šä¸€é¡Œ</button>
          <button class="small" id="btnBackMap">ğŸ—ºï¸ å›åœ°åœ–</button>
        </div>
      </div>

      <div class="barRow">
        <button id="btnSpeak" class="primary">ğŸ”Š æ’­æ”¾</button>
        <span class="pill">ğŸ¢â¡ï¸ğŸ‡ ç™¼éŸ³é€Ÿåº¦</span>
        <input id="rate" class="range" type="range" min="0.7" max="1.2" step="0.05" value="0.95">
        <span class="chip">x<b id="rateVal">0.95</b></span>
        <button class="small" id="btnVoice">ğŸ™ï¸ é‡æ–°é¸èªéŸ³</button>
      </div>

      <div id="gameBody" style="margin-top:14px"></div>
      <div class="status" id="status"></div>
      <div class="reveal" id="reveal"></div>

      <div class="footerBtns">
        <button id="btnNext" class="primary">â¡ï¸ ä¸‹ä¸€é¡Œ</button>
        <button id="btnRetry" class="ghost">ğŸ” é‡ç©æœ¬é—œ</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="teacherModal">
  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <span class="pill">ğŸ‘©â€ğŸ« è€å¸«å¾Œå°</span>
        <span class="chip">è£ç½®å…§å­¸ç”Ÿæ•¸ï¼š<b id="stuCount">0</b></span>
      </div>
      <div class="row">
        <button class="small" id="btnCloseTeacher">âœ–ï¸ é—œé–‰</button>
      </div>
    </div>

    <div class="note" style="margin:10px 0">
      âœ… åŒ¯å‡º CSVï¼šExcel ç›´æ¥é–‹ã€‚<br>
      âœ… åŒ¯å‡º JSONï¼šå½™æ•´ç”¨ï¼ˆæŠŠä¸åŒæ‰‹æ©Ÿçš„ JSON åŒ¯å…¥è€å¸«é€™å°å³å¯åˆä½µï¼‰ã€‚<br>
      âš ï¸ GitHub Pages éœæ…‹ç¶²ç«™ä¸æœƒè‡ªå‹•è·¨æ‰‹æ©ŸåŒæ­¥è³‡æ–™ã€‚
    </div>

    <div class="row" style="margin:10px 0; justify-content:space-between">
      <div class="row">
        <button class="small primary" id="btnExportCSV">â¬‡ï¸ åŒ¯å‡º CSV</button>
        <button class="small" id="btnExportJSON">â¬‡ï¸ åŒ¯å‡º JSON</button>
        <button class="small" id="btnImportJSON">â¬†ï¸ åŒ¯å…¥ JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none">
      </div>
      <div class="row">
        <button class="small" id="btnResetAll">ğŸ§¹ æ¸…ç©ºæœ¬è£ç½®è³‡æ–™</button>
      </div>
    </div>

    <h3 style="margin:12px 0 6px">ğŸ“Š å­¸ç”Ÿé€²åº¦ä¸€è¦½</h3>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>å­¸ç”Ÿ</th>
            <th class="right">å·²é€šé—œ</th>
            <th class="right">ä¸‹ä¸€é—œ</th>
            <th class="right">ç¸½æŒ‘æˆ°æ¬¡æ•¸</th>
            <th>æœ€è¿‘ä¸€æ¬¡</th>
          </tr>
        </thead>
        <tbody id="tblStudents"></tbody>
      </table>
    </div>

    <h3 style="margin:14px 0 6px">âŒ éŒ¯é¡Œçµ±è¨ˆï¼ˆTop 30ï¼‰</h3>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr><th>å–®å­—</th><th>ä¸­æ–‡</th><th class="right">éŒ¯èª¤æ¬¡æ•¸</th></tr>
        </thead>
        <tbody id="tblWrong"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* =======================
   153å®Œæ•´å–®å­—é¡Œåº«ï¼ˆè‹±â†’ä¸­ï¼‰
   ======================= */
const WORDS = [{"id": 1, "en": "able", "zh": "èƒ½å¤ "}, {"id": 2, "en": "all", "zh": "æ‰€æœ‰"}, {"id": 3, "en": "after", "zh": "åœ¨â€¦ä¹‹å¾Œ"}, {"id": 4, "en": "and", "zh": "å’Œ"}, {"id": 5, "en": "any", "zh": "ä»»ä½•"}, {"id": 6, "en": "ant", "zh": "èèŸ»"}, {"id": 7, "en": "apple", "zh": "è˜‹æœ"}, {"id": 8, "en": "April", "zh": "å››æœˆ"}, {"id": 9, "en": "ask", "zh": "å•"}, {"id": 10, "en": "book", "zh": "æ›¸"}, {"id": 11, "en": "baby", "zh": "å¬°å…’"}, {"id": 12, "en": "back", "zh": "èƒŒéƒ¨"}, {"id": 13, "en": "bad", "zh": "å£çš„"}, {"id": 14, "en": "ball", "zh": "çƒ"}, {"id": 15, "en": "band", "zh": "æ¨‚éšŠ"}, {"id": 16, "en": "bar", "zh": "é…’å§"}, {"id": 17, "en": "bat", "zh": "è™è ;çƒæ£’"}, {"id": 18, "en": "beach", "zh": "æµ·ç˜"}, {"id": 19, "en": "bear", "zh": "ç†Š"}, {"id": 20, "en": "bee", "zh": "èœœèœ‚"}, {"id": 21, "en": "bite", "zh": "å’¬"}, {"id": 22, "en": "bicycle", "zh": "è…³è¸è»Š"}, {"id": 23, "en": "big", "zh": "å¤§çš„"}, {"id": 24, "en": "bird", "zh": "é³¥"}, {"id": 25, "en": "blue", "zh": "è—è‰²"}, {"id": 26, "en": "boat", "zh": "èˆ¹"}, {"id": 27, "en": "box", "zh": "ç›’å­"}, {"id": 28, "en": "boy", "zh": "ç”·å­©"}, {"id": 29, "en": "bread", "zh": "éºµåŒ…"}, {"id": 30, "en": "break", "zh": "æ‰“ç ´;ä¼‘æ¯"}, {"id": 31, "en": "bus", "zh": "å…¬è»Š"}, {"id": 32, "en": "but", "zh": "ä½†æ˜¯"}, {"id": 33, "en": "butter", "zh": "å¥¶æ²¹"}, {"id": 34, "en": "cake", "zh": "è›‹ç³•"}, {"id": 35, "en": "call", "zh": "æ‰“é›»è©±"}, {"id": 36, "en": "cap", "zh": "å¸½å­"}, {"id": 37, "en": "cat", "zh": "è²“"}, {"id": 38, "en": "chair", "zh": "æ¤…å­"}, {"id": 39, "en": "chicken", "zh": "é›"}, {"id": 40, "en": "Chinese", "zh": "ä¸­æ–‡;ä¸­åœ‹äºº"}, {"id": 41, "en": "chopsticks", "zh": "ç­·å­"}, {"id": 42, "en": "cool", "zh": "æ¶¼çˆ½çš„;é…·"}, {"id": 43, "en": "cow", "zh": "ç‰›"}, {"id": 44, "en": "cute", "zh": "å¯æ„›çš„"}, {"id": 45, "en": "dad", "zh": "çˆ¸çˆ¸"}, {"id": 46, "en": "day", "zh": "å¤©"}, {"id": 47, "en": "desk", "zh": "æ›¸æ¡Œ"}, {"id": 48, "en": "did", "zh": "åš(éå»å¼)"}, {"id": 49, "en": "do", "zh": "åš"}, {"id": 50, "en": "doctor", "zh": "é†«ç”Ÿ"}, {"id": 51, "en": "dog", "zh": "ç‹—"}, {"id": 52, "en": "doll", "zh": "å¨ƒå¨ƒ"}, {"id": 53, "en": "door", "zh": "é–€"}, {"id": 54, "en": "down", "zh": "å‘ä¸‹"}, {"id": 55, "en": "drink", "zh": "å–"}, {"id": 56, "en": "duck", "zh": "é´¨å­"}, {"id": 57, "en": "egg", "zh": "è›‹"}, {"id": 58, "en": "eight", "zh": "8"}, {"id": 59, "en": "eleven", "zh": "11"}, {"id": 60, "en": "English", "zh": "è‹±æ–‡"}, {"id": 61, "en": "erase", "zh": "æ“¦æ‰"}, {"id": 62, "en": "eraser", "zh": "æ©¡çš®æ“¦"}, {"id": 63, "en": "fact", "zh": "äº‹å¯¦"}, {"id": 64, "en": "fall", "zh": "ç§‹å¤©;è·Œå€’"}, {"id": 65, "en": "fan", "zh": "é›»æ‰‡;ç²‰çµ²"}, {"id": 66, "en": "father", "zh": "çˆ¸çˆ¸"}, {"id": 67, "en": "fin", "zh": "é­šé°­"}, {"id": 68, "en": "five", "zh": "5"}, {"id": 69, "en": "flower", "zh": "èŠ±"}, {"id": 70, "en": "four", "zh": "4"}, {"id": 71, "en": "friend", "zh": "æœ‹å‹"}, {"id": 72, "en": "from", "zh": "å¾â€¦ä¾†"}, {"id": 73, "en": "fun", "zh": "æœ‰è¶£çš„"}, {"id": 74, "en": "game", "zh": "éŠæˆ²"}, {"id": 75, "en": "girl", "zh": "å¥³å­©"}, {"id": 76, "en": "go", "zh": "å»"}, {"id": 77, "en": "good", "zh": "å¥½çš„"}, {"id": 78, "en": "green", "zh": "ç¶ è‰²"}, {"id": 79, "en": "hat", "zh": "å¸½å­"}, {"id": 80, "en": "have", "zh": "æœ‰"}, {"id": 81, "en": "he", "zh": "ä»–"}, {"id": 82, "en": "help", "zh": "å¹«åŠ©"}, {"id": 83, "en": "hot", "zh": "ç†±çš„"}, {"id": 84, "en": "how", "zh": "å¦‚ä½•"}, {"id": 85, "en": "I", "zh": "æˆ‘"}, {"id": 86, "en": "in", "zh": "åœ¨â€¦è£¡"}, {"id": 87, "en": "is", "zh": "æ˜¯"}, {"id": 88, "en": "it", "zh": "å®ƒ"}, {"id": 89, "en": "jacket", "zh": "å¤–å¥—"}, {"id": 90, "en": "January", "zh": "ä¸€æœˆ"}, {"id": 91, "en": "jump", "zh": "è·³"}, {"id": 92, "en": "kid", "zh": "å°å­©"}, {"id": 93, "en": "kite", "zh": "é¢¨ç®"}, {"id": 94, "en": "lake", "zh": "æ¹–"}, {"id": 95, "en": "leg", "zh": "è…¿"}, {"id": 96, "en": "let", "zh": "è®“"}, {"id": 97, "en": "like", "zh": "å–œæ­¡;åƒ"}, {"id": 98, "en": "lion", "zh": "ç…å­"}, {"id": 99, "en": "lips", "zh": "å˜´å”‡"}, {"id": 100, "en": "look", "zh": "çœ‹"}, {"id": 101, "en": "love", "zh": "æ„›"}, {"id": 102, "en": "man", "zh": "ç”·äºº"}, {"id": 103, "en": "mask", "zh": "é¢å…·"}, {"id": 104, "en": "me", "zh": "æˆ‘(å—æ ¼)"}, {"id": 105, "en": "milk", "zh": "ç‰›å¥¶"}, {"id": 106, "en": "mom", "zh": "åª½åª½"}, {"id": 107, "en": "moon", "zh": "æœˆäº®"}, {"id": 108, "en": "my", "zh": "æˆ‘çš„"}, {"id": 109, "en": "new", "zh": "æ–°çš„"}, {"id": 110, "en": "nine", "zh": "9"}, {"id": 111, "en": "nose", "zh": "é¼»å­"}, {"id": 112, "en": "not", "zh": "ä¸"}, {"id": 113, "en": "now", "zh": "ç¾åœ¨"}, {"id": 114, "en": "October", "zh": "åæœˆ"}, {"id": 115, "en": "of", "zh": "â€¦çš„"}, {"id": 116, "en": "on", "zh": "åœ¨â€¦ä¸Š"}, {"id": 117, "en": "one", "zh": "1"}, {"id": 118, "en": "open", "zh": "æ‰“é–‹"}, {"id": 119, "en": "orange", "zh": "æ©˜å­;æ©˜è‰²"}, {"id": 120, "en": "page", "zh": "é æ•¸"}, {"id": 121, "en": "pen", "zh": "ç­†"}, {"id": 122, "en": "pet", "zh": "å¯µç‰©"}, {"id": 123, "en": "pig", "zh": "è±¬"}, {"id": 124, "en": "play", "zh": "ç©"}, {"id": 125, "en": "please", "zh": "è«‹"}, {"id": 126, "en": "rain", "zh": "é›¨"}, {"id": 127, "en": "read", "zh": "è®€"}, {"id": 128, "en": "red", "zh": "ç´…è‰²"}, {"id": 129, "en": "run", "zh": "è·‘"}, {"id": 130, "en": "sad", "zh": "é›£éçš„"}, {"id": 131, "en": "say", "zh": "èªª"}, {"id": 132, "en": "school", "zh": "å­¸æ ¡"}, {"id": 133, "en": "sea", "zh": "æµ·"}, {"id": 134, "en": "see", "zh": "çœ‹è¦‹"}, {"id": 135, "en": "seven", "zh": "7"}, {"id": 136, "en": "she", "zh": "å¥¹"}, {"id": 137, "en": "six", "zh": "6"}, {"id": 138, "en": "sun", "zh": "å¤ªé™½"}, {"id": 139, "en": "table", "zh": "æ¡Œå­"}, {"id": 140, "en": "talk", "zh": "èªªè©±"}, {"id": 141, "en": "teacher", "zh": "è€å¸«"}, {"id": 142, "en": "ten", "zh": "10"}, {"id": 143, "en": "three", "zh": "3"}, {"id": 144, "en": "tiger", "zh": "è€è™"}, {"id": 145, "en": "time", "zh": "æ™‚é–“"}, {"id": 146, "en": "to", "zh": "åˆ°;å»"}, {"id": 147, "en": "two", "zh": "2"}, {"id": 148, "en": "tub", "zh": "æµ´ç¼¸"}, {"id": 149, "en": "turtle", "zh": "çƒé¾œ"}, {"id": 150, "en": "tree", "zh": "æ¨¹"}, {"id": 151, "en": "up", "zh": "ä¸Šé¢"}, {"id": 152, "en": "water", "zh": "æ°´"}, {"id": 153, "en": "yellow", "zh": "é»ƒè‰²"}];

const LEVELS = 100;
const Q_PER_LEVEL = 10;
const PASS_SCORE = 8; // é€šé—œé–€æª»
const LS_KEY = "nmps_spelling_go_final_v1";

let state = loadState();
let curStudent = state.curStudent || "";

let inLevel = 1;
let qIndex = 0;
let score = 0;
let streak = 0;

let questions = []; // [{mode, word(s), ...}]
let startTs = 0;
let timerId = null;
let canNext = false;

let bestVoice = null;

const TEACHER_PASS = "nmps";

/* ========= DOM ========= */
const $ = (id)=>document.getElementById(id);

const screenMap = $("screenMap");
const screenGame = $("screenGame");

const curStudentEl = $("curStudent");
const passedCountEl = $("passedCount");
const nextLevelEl = $("nextLevel");
const overallBar = $("overallBar");
const mapInner = $("mapInner");
const pathEl = $("path");

const badgesEl = $("badges");
const badgeCountEl = $("badgeCount");

const studentInput = $("studentInput");
const passRule = $("passRule");

const btnLogin = $("btnLogin");
const btnSwitch = $("btnSwitch");
const btnStartNext = $("btnStartNext");
const btnMap = $("btnMap");
const btnTeacher = $("btnTeacher");
const btnFullscreen = $("btnFullscreen");

const btnBackMap = $("btnBackMap");
const btnPrevQ = $("btnPrevQ");
const btnNext = $("btnNext");
const btnRetry = $("btnRetry");

const btnSpeak = $("btnSpeak");
const btnVoice = $("btnVoice");

const rate = $("rate");
const rateVal = $("rateVal");

const gLevel = $("gLevel");
const gQ = $("gQ");
const gScore = $("gScore");
const gStreak = $("gStreak");
const gTime = $("gTime");
const gModeTag = $("gModeTag");
const gameBody = $("gameBody");
const statusEl = $("status");
const revealEl = $("reveal");

/* teacher */
const teacherModal = $("teacherModal");
const btnCloseTeacher = $("btnCloseTeacher");
const btnExportCSV = $("btnExportCSV");
const btnExportJSON = $("btnExportJSON");
const btnImportJSON = $("btnImportJSON");
const importFile = $("importFile");
const btnResetAll = $("btnResetAll");
const tblStudents = $("tblStudents");
const tblWrong = $("tblWrong");
const stuCountEl = $("stuCount");

/* FX */
const fx = $("fx");
const fxCtx = fx.getContext("2d");

/* ========= init ========= */
function init(){
  passRule.textContent = `${PASS_SCORE}/10`;

  // canvas
  resizeFx();
  window.addEventListener("resize", resizeFx);

  // events
  btnLogin.onclick = doLogin;
  btnSwitch.onclick = ()=>{ state.curStudent=""; curStudent=""; saveState(); renderAll(); toast("å·²ç™»å‡º"); };
  btnStartNext.onclick = startNextLevel;
  btnMap.onclick = ()=> showMap();
  btnBackMap.onclick = ()=> showMap();
  btnPrevQ.onclick = prevQuestion;
  btnNext.onclick = nextQuestion;
  btnRetry.onclick = ()=> startLevel(inLevel, true);

  btnSpeak.onclick = ()=> speakCurrent();
  btnVoice.onclick = ()=> pickBestVoice(true);

  btnTeacher.onclick = openTeacher;
  btnCloseTeacher.onclick = ()=> teacherModal.style.display="none";
  btnExportCSV.onclick = exportCSV;
  btnExportJSON.onclick = exportJSON;
  btnImportJSON.onclick = ()=> importFile.click();
  importFile.onchange = importJSON;
  btnResetAll.onclick = resetAll;

  btnFullscreen.onclick = requestFull;

  rate.oninput = ()=>{
    rateVal.textContent = Number(rate.value).toFixed(2);
    state.settings.rate = Number(rate.value);
    saveState();
  };

  // load settings
  if(!state.settings) state.settings = {};
  if(!state.settings.rate) state.settings.rate = 0.95;
  rate.value = state.settings.rate;
  rateVal.textContent = Number(rate.value).toFixed(2);

  // speech voices
  speechSynthesis.onvoiceschanged = ()=> pickBestVoice(false);
  pickBestVoice(false);

  // map nodes
  renderMap();
  renderAll();

  // keyboard
  document.addEventListener("keydown", (e)=>{
    if(screenGame.style.display==="block"){
      if(e.key==="ArrowRight") nextQuestion();
      if(e.key==="ArrowLeft") prevQuestion();
      if(e.key===" ") { e.preventDefault(); speakCurrent(); }
    }
  });
}
init();

/* ========= state/storage ========= */
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return {students:{}, curStudent:"", settings:{rate:0.95}};
    const obj = JSON.parse(raw);
    if(!obj.students) obj.students = {};
    if(!obj.settings) obj.settings = {rate:0.95};
    return obj;
  }catch{
    return {students:{}, curStudent:"", settings:{rate:0.95}};
  }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function ensureStudent(name){
  if(!state.students[name]){
    state.students[name] = {
      createdAt: Date.now(),
      levels: {},    // level -> {bestScore, bestTimeMs, attempts, passed, firstPassConfettiDone}
      wrong: {},     // wordId -> count
      events: {},    // e.g. {streak5:true, streak10:true} globally or per student
      plays: 0,
      lastAt: 0
    };
  }
  if(!state.students[name].events) state.students[name].events = {};
  return state.students[name];
}
function getStu(){
  if(!curStudent) return null;
  return ensureStudent(curStudent);
}

/* ========= login ========= */
function doLogin(){
  const name = (studentInput.value||"").trim();
  if(!name){ toast("è«‹è¼¸å…¥å§“å"); return; }
  curStudent = name;
  state.curStudent = name;
  ensureStudent(name);
  saveState();
  studentInput.value = "";
  renderAll();
  toast(`ç™»å…¥æˆåŠŸï¼š${name}`);
}

/* ========= badges ========= */
const BADGES = [
  {key:"b1", need:1,   icon:"ğŸ¥‰", title:"æ–°æ‰‹å¾½ç« ", desc:"é€šé—œ 1 é—œ"},
  {key:"b2", need:10,  icon:"ğŸ¥ˆ", title:"å­¸ç¿’å°é”äºº", desc:"é€šé—œ 10 é—œ"},
  {key:"b3", need:50,  icon:"ğŸ¥‡", title:"æ‹¼å­—é«˜æ‰‹", desc:"é€šé—œ 50 é—œ"},
  {key:"b4", need:100, icon:"ğŸ†", title:"å—é–€æ‹¼å­—ç‹", desc:"é€šé—œ 100 é—œ"},
];
function renderBadges(passedCount){
  badgesEl.innerHTML = "";
  let unlocked = 0;
  BADGES.forEach(b=>{
    const ok = passedCount >= b.need;
    if(ok) unlocked++;
    const div = document.createElement("div");
    div.className = "badge " + (ok ? "unlocked" : "lock");
    div.innerHTML = `
      <div class="ico">${b.icon}</div>
      <div>
        <div class="t">${b.title}</div>
        <div class="d">${b.desc}</div>
      </div>
    `;
    badgesEl.appendChild(div);
  });
  badgeCountEl.textContent = unlocked;
}

/* ========= map ========= */
function renderMap(){
  pathEl.innerHTML = "";
  const topPadding = 30;
  const gapY = 140;
  const totalH = topPadding + gapY*(LEVELS-1) + 140;
  pathEl.style.minHeight = totalH+"px";

  for(let i=1;i<=LEVELS;i++){
    const node = document.createElement("div");
    node.className = "node";
    node.dataset.level = i;

    const base = ((i-1)%2===0) ? 0.25 : 0.75;
    const jitter = (randSeed(i)*0.12)-0.06;
    const x = clamp(base + jitter, 0.14, 0.86);
    const y = topPadding + gapY*(i-1);

    node.style.left = `calc(${(x*100).toFixed(2)}% - 37px)`;
    node.style.top = `${y}px`;

    const icon = (i%10===0) ? "ğŸ†" : (i%5===0) ? "ğŸ" : (i%3===0) ? "â­" : "ğŸ¯";
    node.innerHTML = `<div class="i">${icon}</div><div class="n">ç¬¬${i}é—œ</div>`;
    node.onclick = ()=> startLevel(i, false);

    pathEl.appendChild(node);
  }
}

/* ========= mode pick ========= */
function getModePick(){
  const el = document.querySelector('input[name="modePick"]:checked');
  return el ? el.value : "ALL";
}
function modeLabelShort(m){
  if(m==="A") return "A è½â†’é¸ä¸­";
  if(m==="B") return "B çœ‹è‹±â†’é¸ä¸­";
  if(m==="C") return "C é…å°";
  if(m==="D") return "D è½â†’æ‹¼è‹±";
  return "ALL";
}
function modeLabelLong(m){
  if(m==="A") return "A è½ â†’ é¸ä¸­æ–‡ï¼ˆä¸é¡¯ç¤ºè‹±æ–‡ï¼‰";
  if(m==="B") return "B çœ‹è‹±æ–‡ â†’ é¸ä¸­æ–‡";
  if(m==="C") return "C è‹±æ–‡ â†” ä¸­æ–‡é…å°";
  if(m==="D") return "D è½ â†’ æ‹¼è‹±æ–‡å–®å­—";
  return "å…¨é¸";
}

/* ========= render home/map state ========= */
function renderAll(){
  curStudentEl.textContent = curStudent || "æœªç™»å…¥";
  btnStartNext.disabled = !curStudent;

  const stu = getStu();
  let passedCount = 0;
  let nextLv = 1;

  if(stu){
    for(let i=1;i<=LEVELS;i++){
      if(stu.levels[i]?.passed) passedCount++;
    }
    nextLv = 1;
    for(let i=1;i<=LEVELS;i++){
      if(!stu.levels[i]?.passed){ nextLv=i; break; }
      nextLv = Math.min(LEVELS, i+1);
    }
  }

  passedCountEl.textContent = passedCount;
  nextLevelEl.textContent = nextLv;
  overallBar.style.width = `${Math.round((passedCount/LEVELS)*100)}%`;
  renderBadges(passedCount);

  // update nodes
  const nodes = [...pathEl.querySelectorAll(".node")];
  nodes.forEach(n=>{
    const lv = Number(n.dataset.level);
    n.classList.remove("locked","passed","current");
    let locked = true;
    let passed = false;
    if(!stu){
      locked = (lv!==1);
    }else{
      passed = !!stu.levels[lv]?.passed;
      locked = (lv>1 && !stu.levels[lv-1]?.passed && !passed);
      if(lv===1) locked = false;
    }
    if(locked) n.classList.add("locked");
    if(passed) n.classList.add("passed");
    if(stu && lv===nextLv) n.classList.add("current");
  });

  scrollToCurrent();
}
function scrollToCurrent(){
  const stu = getStu();
  if(!stu) return;
  let nextLv = 1;
  for(let i=1;i<=LEVELS;i++){
    if(!stu.levels[i]?.passed){ nextLv=i; break; }
    nextLv = Math.min(LEVELS, i+1);
  }
  const node = pathEl.querySelector(`.node[data-level="${nextLv}"]`);
  if(node){
    const y = node.offsetTop - 160;
    mapInner.scrollTo({top: Math.max(0,y), behavior:"smooth"});
  }
}

/* ========= navigation ========= */
function showMap(){
  stopTimer();
  screenGame.style.display = "none";
  screenMap.style.display = "grid";
  renderAll();
}
function showGame(){
  screenMap.style.display = "none";
  screenGame.style.display = "block";
}

/* ========= start level ========= */
function startNextLevel(){
  if(!curStudent){ toast("è«‹å…ˆç™»å…¥"); return; }
  const stu = getStu();
  let nextLv = 1;
  for(let i=1;i<=LEVELS;i++){
    if(!stu.levels[i]?.passed){ nextLv=i; break; }
    nextLv = Math.min(LEVELS, i+1);
  }
  startLevel(nextLv, false);
}

function startLevel(level, forceReplay){
  const stu = getStu();
  if(!stu){ toast("è«‹å…ˆç™»å…¥"); return; }

  // lock check
  if(level>1 && !stu.levels[level-1]?.passed && !stu.levels[level]?.passed){
    toast("ğŸ”’ å…ˆé€šéä¸Šä¸€é—œ");
    return;
  }

  inLevel = level;
  qIndex = 0;
  score = 0;
  streak = 0;

  // record attempt
  if(!stu.levels[level]) stu.levels[level] = {bestScore:0, bestTimeMs:0, attempts:0, passed:false, firstPassConfettiDone:false};
  stu.levels[level].attempts = (stu.levels[level].attempts||0) + 1;
  stu.plays = (stu.plays||0) + 1;
  stu.lastAt = Date.now();
  saveState();

  // build 10 questions based on selected type
  const pick = getModePick(); // A/B/C/D/ALL
  questions = buildQuestions(pick);

  startTs = Date.now();
  canNext = false;

  showGame();
  renderQuestion();
  startTimer();
}

/* ========= question building ========= */
function buildQuestions(pick){
  // unique words within a level (avoid duplicates)
  const pickedWords = pickUnique(WORDS, Q_PER_LEVEL);

  // create 10 modes
  let modes = [];
  if(pick === "ALL"){
    // guarantee each A/B/C/D appears at least once in 10
    const base = ["A","B","C","D"];
    modes = base.slice();
    while(modes.length < Q_PER_LEVEL){
      modes.push(base[Math.floor(Math.random()*base.length)]);
    }
    shuffle(modes);
  }else{
    modes = Array(Q_PER_LEVEL).fill(pick);
  }

  // Build question objects; for C we make a mini-matching with 3 pairs (counts as 1 question)
  const qs = [];
  let cursor = 0;
  for(let i=0;i<Q_PER_LEVEL;i++){
    const m = modes[i];
    if(m === "C"){
      // take 3 words if available, else fallback to 2
      const pairs = [];
      for(let k=0;k<3;k++){
        const w = pickedWords[cursor % pickedWords.length];
        pairs.push(w);
        cursor++;
      }
      qs.push({mode:"C", pairs});
    }else{
      const w = pickedWords[cursor % pickedWords.length];
      cursor++;
      qs.push({mode:m, word:w});
    }
  }
  return qs;
}

/* ========= render question ========= */
function renderQuestion(){
  statusEl.textContent = "";
  statusEl.className = "status";
  revealEl.textContent = "";
  btnNext.disabled = true;
  canNext = false;

  gLevel.textContent = inLevel;
  gQ.textContent = qIndex + 1;
  gScore.textContent = score;
  gStreak.textContent = streak;

  btnPrevQ.disabled = (qIndex===0);

  const q = questions[qIndex];
  gModeTag.textContent = modeLabelShort(q.mode);
  gameBody.innerHTML = "";

  if(q.mode==="A") renderA(q);
  if(q.mode==="B") renderB(q);
  if(q.mode==="C") renderC(q);
  if(q.mode==="D") renderD(q);

  // auto speak for A/D
  if(q.mode==="A" || q.mode==="D"){
    setTimeout(()=> speak(q.word.en), 250);
  }
}

/* ========= mode A: listen -> choose zh (no english on screen) ========= */
function renderA(q){
  const w = q.word;
  const title = document.createElement("div");
  title.className = "bigTitle";
  title.textContent = "ğŸ”Š è½éŸ³é¸ä¸­æ–‡";
  const sub = document.createElement("div");
  sub.className = "sub";
  sub.textContent = "æŒ‰æ’­æ”¾è½è‹±æ–‡ï¼Œé¸å‡ºæ­£ç¢ºä¸­æ–‡ï¼ˆä¸æœƒé¡¯ç¤ºè‹±æ–‡ï¼‰";
  gameBody.appendChild(title);
  gameBody.appendChild(sub);

  const correct = w.zh;
  const opts = [correct, ...pickDistractorsZh(w.id, 3)];
  shuffle(opts);

  const box = document.createElement("div");
  box.className = "choices grid2";
  opts.forEach(txt=>{
    const c = document.createElement("div");
    c.className = "choice";
    c.textContent = txt;
    c.onclick = ()=> {
      if(canNext) return;
      const ok = (txt===correct);
      markAndFinalizeChoice(box, c, ok, w);
    };
    box.appendChild(c);
  });
  gameBody.appendChild(box);
}

/* ========= mode B: show english -> choose zh ========= */
function renderB(q){
  const w = q.word;
  const title = document.createElement("div");
  title.className = "bigTitle";
  title.textContent = w.en;
  const sub = document.createElement("div");
  sub.className = "sub";
  sub.textContent = "é¸å‡ºæ­£ç¢ºä¸­æ–‡æ„æ€";
  gameBody.appendChild(title);
  gameBody.appendChild(sub);

  const correct = w.zh;
  const opts = [correct, ...pickDistractorsZh(w.id, 3)];
  shuffle(opts);

  const box = document.createElement("div");
  box.className = "choices grid2";
  opts.forEach(txt=>{
    const c = document.createElement("div");
    c.className = "choice";
    c.textContent = txt;
    c.onclick = ()=> {
      if(canNext) return;
      const ok = (txt===correct);
      markAndFinalizeChoice(box, c, ok, w);
    };
    box.appendChild(c);
  });
  gameBody.appendChild(box);
}

/* ========= mode C: mini matching (3 pairs) counts as 1 question ========= */
function renderC(q){
  const pairs = q.pairs; // 3 words
  const title = document.createElement("div");
  title.className = "bigTitle";
  title.textContent = "ğŸ§© è‹±ä¸­é…å°";
  const sub = document.createElement("div");
  sub.className = "sub";
  sub.textContent = "é»è‹±æ–‡ï¼Œå†é»å°æ‡‰ä¸­æ–‡ï¼ˆå®Œæˆ 3 çµ„é…å°ç®—ç­”å°ï¼‰";
  gameBody.appendChild(title);
  gameBody.appendChild(sub);

  const left = pairs.map(w=>({type:"en", id:w.id, text:w.en, w}));
  const right = pairs.map(w=>({type:"zh", id:w.id, text:w.zh, w}));

  shuffle(left); shuffle(right);
  const grid = document.createElement("div");
  grid.className = "matchGrid";

  let selected = null;
  let matched = new Set();
  let wrongTouches = 0;

  function clickTile(tile, item){
    if(tile.classList.contains("done")) return;
    if(!selected){
      selected = {tile, item};
      tile.classList.add("sel");
      return;
    }
    if(selected.tile === tile) return;

    const ok = (selected.item.id === item.id) && (selected.item.type !== item.type);
    selected.tile.classList.remove("sel");
    tile.classList.remove("sel");

    if(ok){
      selected.tile.classList.add("ok","done");
      tile.classList.add("ok","done");
      matched.add(item.id);
      selected = null;

      if(matched.size === pairs.length){
        // correct if wrongTouches == 0, else still correct? Here: allow but count as wrong if any mismatch.
        const finalOk = (wrongTouches === 0);
        finalizeAnswer(finalOk, pairs[0], {customReveal: finalOk ? "" : "æ­£è§£ï¼šä¸‰çµ„éƒ½è¦é…å°æ­£ç¢º"}); // pairs[0] just for wrong stat bucketing
      }
    }else{
      wrongTouches++;
      selected.tile.classList.add("no");
      tile.classList.add("no");
      setTimeout(()=>{ selected?.tile?.classList.remove("no"); tile.classList.remove("no"); }, 320);

      // record wrong for both if have word
      const stu = getStu();
      if(stu){
        bumpWrong(stu, selected.item.w?.id);
        bumpWrong(stu, item.w?.id);
        saveState();
      }

      selected = null;
    }
  }

  const allTiles = [];
  left.forEach(item=>allTiles.push(item));
  right.forEach(item=>allTiles.push(item));
  // Interleave to look nicer
  const mixed = shuffle(allTiles);

  mixed.forEach(item=>{
    const t = document.createElement("div");
    t.className = "tile";
    t.textContent = item.text;
    t.onclick = ()=> clickTile(t, item);
    grid.appendChild(t);
  });

  const wrap = document.createElement("div");
  wrap.className = "matchWrap";
  wrap.appendChild(grid);
  gameBody.appendChild(wrap);
}

/* ========= mode D: listen -> spell english ========= */
function renderD(q){
  const w = q.word;
  const title = document.createElement("div");
  title.className = "bigTitle";
  title.textContent = "ğŸ§ è½éŸ³æ‹¼è‹±æ–‡";
  const sub = document.createElement("div");
  sub.className = "sub";
  sub.textContent = "æŒ‰æ’­æ”¾è½è‹±æ–‡ï¼Œè¼¸å…¥è‹±æ–‡å–®å­—ï¼ˆä¸åˆ†å¤§å°å¯«ï¼‰";
  gameBody.appendChild(title);
  gameBody.appendChild(sub);

  const box = document.createElement("div");
  box.className = "spellBox";
  box.innerHTML = `
    <div class="row" style="justify-content:center">
      <span class="chip">ä¸­æ–‡æç¤ºï¼š<b>${escapeHtml(w.zh)}</b></span>
      <span class="chip">å­—æ¯æ•¸ï¼š<b>${String(w.en).length}</b></span>
    </div>
    <div class="row" style="justify-content:center; margin-top:10px">
      <input id="spellInput" class="spellInput" placeholder="è¼¸å…¥è‹±æ–‡â€¦" autocomplete="off" autocapitalize="none" />
      <button class="primary small" id="spellSubmit">é€å‡º</button>
    </div>
  `;
  gameBody.appendChild(box);

  const input = document.getElementById("spellInput");
  const submit = document.getElementById("spellSubmit");
  input.focus();

  const doCheck = ()=>{
    if(canNext) return;
    const ans = (input.value||"").trim().toLowerCase();
    const ok = ans === String(w.en).toLowerCase();
    finalizeAnswer(ok, w, {customReveal: ok ? "" : `æ­£è§£ï¼š${w.en} ï¼ ${w.zh}`});
    submit.disabled = true;
    input.disabled = true;
  };

  submit.onclick = doCheck;
  input.addEventListener("keydown", (e)=>{
    if(e.key==="Enter") doCheck();
  });
}

/* ========= answer helpers ========= */
function markAndFinalizeChoice(container, chosenEl, ok, word){
  // lock all
  [...container.children].forEach(el=>el.style.pointerEvents="none");
  if(ok){
    chosenEl.classList.add("correct");
  }else{
    chosenEl.classList.add("wrong");
    // highlight correct
    [...container.children].forEach(el=>{
      if(el.textContent === word.zh) el.classList.add("correct");
    });
  }
  finalizeAnswer(ok, word);
}

function finalizeAnswer(ok, word, meta={}){
  const stu = getStu();
  if(stu && !ok){
    bumpWrong(stu, word.id);
    saveState();
  }

  if(ok){
    score += 1;
    streak += 1;
    statusEl.className = "status good";
    statusEl.textContent = "âœ… ç­”å°ï¼";
    revealEl.textContent = meta.customReveal || "";
  }else{
    streak = 0;
    statusEl.className = "status bad";
    statusEl.textContent = "âŒ éŒ¯äº†";
    revealEl.textContent = meta.customReveal || `æ­£è§£ï¼š${word.en} ï¼ ${word.zh}`;
  }
  gScore.textContent = score;
  gStreak.textContent = streak;

  // streak animations (5 & 10) - play only once per student overall
  if(stu){
    if(streak >= 5 && !stu.events.streak5){
      stu.events.streak5 = true;
      saveState();
      streakBurst(5);
    }
    if(streak >= 10 && !stu.events.streak10){
      stu.events.streak10 = true;
      saveState();
      streakBurst(10);
    }
  }

  btnNext.disabled = false;
  canNext = true;
}

/* ========= navigation between questions ========= */
function prevQuestion(){
  if(qIndex<=0) return;
  qIndex--;
  renderQuestion();
}
function nextQuestion(){
  if(!canNext){ toast("å…ˆä½œç­”å†ä¸‹ä¸€é¡Œ"); return; }
  if(qIndex < Q_PER_LEVEL-1){
    qIndex++;
    renderQuestion();
  }else{
    endLevel();
  }
}

/* ========= end level ========= */
function endLevel(){
  stopTimer();
  const ms = Date.now() - startTs;
  const stu = getStu();
  const lv = inLevel;

  const rec = stu.levels[lv] || {bestScore:0, bestTimeMs:0, attempts:0, passed:false, firstPassConfettiDone:false};

  // best score/time
  if(score > (rec.bestScore||0) || (score === (rec.bestScore||0) && (rec.bestTimeMs===0 || ms < rec.bestTimeMs))){
    rec.bestScore = score;
    rec.bestTimeMs = ms;
  }

  const passedNow = score >= PASS_SCORE;
  let firstPass = false;
  if(passedNow && !rec.passed){
    rec.passed = true;
    firstPass = true;
  }

  // confetti only first pass once
  if(firstPass && !rec.firstPassConfettiDone){
    rec.firstPassConfettiDone = true;
    confetti();
  }

  stu.levels[lv] = rec;
  saveState();

  const minutes = Math.floor(ms/60000);
  const seconds = Math.floor((ms%60000)/1000);
  const timeStr = `${minutes}:${String(seconds).padStart(2,"0")}`;

  gameBody.innerHTML = `
    <div class="bigTitle" style="font-size:28px;margin-top:6px">${passedNow ? "ğŸ‰ é€šé—œæˆåŠŸï¼" : "å†è©¦ä¸€æ¬¡å°±æ›´å¼·ï¼"}</div>
    <div class="sub">ç¬¬ ${lv} é—œå®Œæˆï½œå¾—åˆ† <b>${score}/10</b>ï½œæ™‚é–“ <b>${timeStr}</b>ï½œé–€æª» <b>${PASS_SCORE}/10</b></div>
    <div class="footerBtns">
      <button class="ghost" onclick="showMap()">ğŸ—ºï¸ å›åœ°åœ–</button>
      <button class="primary" onclick="startLevel(${lv}, true)">ğŸ” é‡ç©æœ¬é—œ</button>
      <button class="primary" onclick="startLevel(${Math.min(LEVELS, lv+1)}, false)">â¡ï¸ ä¸‹ä¸€é—œ</button>
    </div>
    <div class="note" style="text-align:center;margin-top:10px">
      â­ å¾½ç« æœƒéš¨é€šé—œé—œæ•¸è§£é–ã€‚ğŸ”¥ é€£çºŒç­”å° 5/10 é¡Œæœƒè§¸ç™¼å‹•ç•«ï¼ˆæ¯ä½å­¸ç”Ÿç¬¬ä¸€æ¬¡é”æˆæ‰æœƒæ’­ï¼‰ã€‚
    </div>
  `;

  statusEl.textContent = "";
  revealEl.textContent = "";
  btnNext.disabled = true;
  btnPrevQ.disabled = true;
  canNext = false;

  // update header stats
  gQ.textContent = 10;
  gScore.textContent = score;
  gStreak.textContent = streak;
}

/* ========= speech ========= */
function pickBestVoice(forceToast){
  const voices = speechSynthesis.getVoices() || [];
  if(!voices.length){
    if(forceToast) toast("èªéŸ³å°šæœªè¼‰å…¥ï¼Œç¨å¾Œå†æŒ‰ä¸€æ¬¡");
    return;
  }
  const prefer = voices
    .filter(v => (v.lang||"").toLowerCase().startsWith("en"))
    .sort((a,b)=> scoreVoice(b) - scoreVoice(a));
  bestVoice = prefer[0] || voices[0];
  if(forceToast){
    toast(`å·²é¸ç”¨èªéŸ³ï¼š${bestVoice.name}ï¼ˆ${bestVoice.lang}ï¼‰`);
  }

  function scoreVoice(v){
    let s = 0;
    const lang = (v.lang||"").toLowerCase();
    const name = (v.name||"").toLowerCase();
    if(lang.startsWith("en-us")) s += 35;
    if(name.includes("google")) s += 45;
    if(name.includes("samantha")) s += 35;
    if(name.includes("enhanced")) s += 20;
    if(name.includes("premium")) s += 20;
    if(name.includes("natural")) s += 20;
    if(v.localService===false) s += 5;
    return s;
  }
}
function speak(text){
  if(!text) return;
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(String(text));
    u.lang = (bestVoice && bestVoice.lang) ? bestVoice.lang : "en-US";
    if(bestVoice) u.voice = bestVoice;
    u.rate = Number(rate.value || 0.95);
    u.pitch = 1.0;
    u.volume = 1.0;
    speechSynthesis.speak(u);
  }catch(e){
    toast("æ­¤è£ç½®ä¸æ”¯æ´ç™¼éŸ³");
  }
}
function speakCurrent(){
  const q = questions[qIndex];
  if(!q) return;
  // never speak question number; only speak the word
  if(q.mode==="A" || q.mode==="D" || q.mode==="B"){
    speak(q.word.en);
  }else{
    // C: speak nothing by default
    toast("é…å°é¡Œä¸éœ€æ’­æ”¾");
  }
}

/* ========= timer ========= */
function startTimer(){
  stopTimer();
  timerId = setInterval(()=>{
    const ms = Date.now() - startTs;
    const m = Math.floor(ms/60000);
    const s = Math.floor((ms%60000)/1000);
    gTime.textContent = `${m}:${String(s).padStart(2,"0")}`;
  }, 250);
}
function stopTimer(){
  if(timerId){ clearInterval(timerId); timerId=null; }
}

/* ========= teacher backend ========= */
function openTeacher(){
  const pass = prompt("è¼¸å…¥è€å¸«å¯†ç¢¼ï¼š");
  if(pass !== TEACHER_PASS){
    toast("å¯†ç¢¼éŒ¯èª¤");
    return;
  }
  renderTeacher();
  teacherModal.style.display = "grid";
}
function renderTeacher(){
  const names = Object.keys(state.students||{});
  stuCountEl.textContent = names.length;

  // student table
  tblStudents.innerHTML = "";
  names.sort((a,b)=>a.localeCompare(b,"zh-Hant")).forEach(name=>{
    const s = state.students[name];
    let passed = 0;
    let nextLv = 1;
    for(let i=1;i<=LEVELS;i++){
      if(s.levels?.[i]?.passed) passed++;
    }
    for(let i=1;i<=LEVELS;i++){
      if(!s.levels?.[i]?.passed){ nextLv=i; break; }
      nextLv = Math.min(LEVELS, i+1);
    }
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${escapeHtml(name)}</b></td>
      <td class="right">${passed}</td>
      <td class="right">${nextLv}</td>
      <td class="right">${s.plays||0}</td>
      <td>${s.lastAt ? new Date(s.lastAt).toLocaleString() : "-"}</td>
    `;
    tblStudents.appendChild(tr);
  });

  // wrong top 30
  const wrongAgg = {};
  names.forEach(name=>{
    const w = state.students[name].wrong || {};
    Object.keys(w).forEach(id=>{
      wrongAgg[id] = (wrongAgg[id]||0) + (w[id]||0);
    });
  });

  tblWrong.innerHTML = "";
  Object.entries(wrongAgg).sort((a,b)=>b[1]-a[1]).slice(0,30).forEach(([id,c])=>{
    const ww = WORDS.find(x=>x.id===Number(id));
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${ww?escapeHtml(ww.en):id}</b></td>
      <td>${ww?escapeHtml(ww.zh):"-"}</td>
      <td class="right">${c}</td>
    `;
    tblWrong.appendChild(tr);
  });
}
function exportCSV(){
  const rows = [];
  rows.push(["student","level","passed","bestScore","bestTimeSec","attempts","plays","lastAt"]);
  Object.keys(state.students||{}).forEach(name=>{
    const s = state.students[name];
    for(let lv=1;lv<=LEVELS;lv++){
      const r = s.levels?.[lv];
      if(!r) continue;
      rows.push([
        name,
        lv,
        r.passed ? 1 : 0,
        r.bestScore||0,
        r.bestTimeMs ? Math.round(r.bestTimeMs/1000) : 0,
        r.attempts||0,
        s.plays||0,
        s.lastAt ? new Date(s.lastAt).toISOString() : ""
      ]);
    }
  });
  downloadCSV("nmps_spelling_progress.csv", rows);
  toast("å·²åŒ¯å‡ºCSV");
}
function exportJSON(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  downloadBlob("nmps_spelling_state.json", blob);
  toast("å·²åŒ¯å‡ºJSON");
}
async function importJSON(e){
  const f = e.target.files?.[0];
  if(!f) return;
  const txt = await f.text();
  try{
    const obj = JSON.parse(txt);
    if(obj.students){
      Object.keys(obj.students).forEach(name=>{
        if(!state.students[name]) state.students[name] = obj.students[name];
        else{
          // merge
          const a = state.students[name];
          const b = obj.students[name];
          a.levels = a.levels || {};
          b.levels = b.levels || {};
          Object.keys(b.levels).forEach(lv=>{
            const L = lv;
            if(!a.levels[L]) a.levels[L] = b.levels[L];
            else{
              const r1 = a.levels[L], r2 = b.levels[L];
              const bestScore = Math.max(r1.bestScore||0, r2.bestScore||0);
              let bestTime = r1.bestTimeMs||0;
              if(bestScore === (r2.bestScore||0)){
                if(bestTime===0 || (r2.bestTimeMs||0) < bestTime) bestTime = r2.bestTimeMs||0;
              }
              a.levels[L] = {
                bestScore,
                bestTimeMs: bestTime,
                attempts: (r1.attempts||0) + (r2.attempts||0),
                passed: !!(r1.passed || r2.passed),
                firstPassConfettiDone: !!(r1.firstPassConfettiDone || r2.firstPassConfettiDone)
              };
            }
          });
          a.wrong = a.wrong || {};
          b.wrong = b.wrong || {};
          Object.keys(b.wrong).forEach(id=>{
            a.wrong[id] = (a.wrong[id]||0) + (b.wrong[id]||0);
          });
          a.events = a.events || {};
          b.events = b.events || {};
          Object.keys(b.events).forEach(k=>{
            a.events[k] = a.events[k] || b.events[k];
          });
          a.plays = (a.plays||0) + (b.plays||0);
          a.lastAt = Math.max(a.lastAt||0, b.lastAt||0);
        }
      });
      saveState();
      renderTeacher();
      renderAll();
      toast("å·²åŒ¯å…¥ä¸¦å½™æ•´å®Œæˆ");
    }else{
      toast("JSONæ ¼å¼ä¸æ­£ç¢º");
    }
  }catch{
    toast("è®€å–JSONå¤±æ•—");
  }finally{
    importFile.value = "";
  }
}
function resetAll(){
  if(confirm("ç¢ºå®šæ¸…ç©ºæœ¬è£ç½®æ‰€æœ‰å­¸ç”Ÿè³‡æ–™ï¼Ÿæ­¤å‹•ä½œä¸å¯å¾©åŸã€‚")){
    localStorage.removeItem(LS_KEY);
    state = loadState();
    curStudent = "";
    renderAll();
    toast("å·²æ¸…ç©º");
  }
}

/* ========= wrong stats ========= */
function bumpWrong(stu, wordId){
  if(!wordId) return;
  if(!stu.wrong) stu.wrong = {};
  stu.wrong[wordId] = (stu.wrong[wordId]||0) + 1;
}

/* ========= full screen ========= */
function requestFull(){
  const el = document.documentElement;
  if(el.requestFullscreen){
    el.requestFullscreen().catch(()=>toast("æ­¤ç€è¦½å™¨ä¸æ”¯æ´å…¨è¢å¹•"));
  }else{
    toast("æ­¤ç€è¦½å™¨ä¸æ”¯æ´å…¨è¢å¹•");
  }
}

/* ========= FX: confetti + streak animations ========= */
function resizeFx(){
  fx.width = window.innerWidth * devicePixelRatio;
  fx.height = window.innerHeight * devicePixelRatio;
  fx.style.width = window.innerWidth+"px";
  fx.style.height = window.innerHeight+"px";
  fxCtx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
function confetti(){
  // pass confetti
  runParticles(180, 1.0, false);
}
function streakBurst(n){
  // 5: small burst, 10: big burst with stars
  if(n>=10){
    runParticles(260, 1.25, true);
    toast("ğŸ”¥ é€£çºŒç­”å° 10 é¡Œï¼å¤ªå¼·äº†ï¼");
  }else{
    runParticles(160, 1.0, false);
    toast("âœ¨ é€£çºŒç­”å° 5 é¡Œï¼è®šï¼");
  }
}
function runParticles(count, speedMul, star){
  const W = window.innerWidth, H = window.innerHeight;
  const colors = ["#22c55e","#60a5fa","#f59e0b","#ef4444","#a78bfa","#14b8a6"];
  const pieces = [];
  for(let i=0;i<count;i++){
    pieces.push({
      x: Math.random()*W,
      y: -20 - Math.random()*H*0.2,
      vx: (Math.random()-0.5)*4*speedMul,
      vy: (2 + Math.random()*6)*speedMul,
      r: 3 + Math.random()*6,
      c: colors[Math.floor(Math.random()*colors.length)],
      rot: Math.random()*Math.PI,
      vr: (Math.random()-0.5)*0.25,
      star
    });
  }
  let t0 = performance.now();
  function step(t){
    const dt = (t - t0)/16.7;
    t0 = t;
    fxCtx.clearRect(0,0,W,H);
    pieces.forEach(p=>{
      p.x += p.vx*dt;
      p.y += p.vy*dt;
      p.vy += 0.06*dt;
      p.rot += p.vr*dt;

      fxCtx.save();
      fxCtx.translate(p.x,p.y);
      fxCtx.rotate(p.rot);
      fxCtx.fillStyle = p.c;

      if(p.star){
        // draw star
        drawStar(fxCtx, 0, 0, 5, p.r*1.6, p.r*0.7);
      }else{
        fxCtx.fillRect(-p.r, -p.r, p.r*2.2, p.r*1.4);
      }
      fxCtx.restore();
    });
    for(let i=pieces.length-1;i>=0;i--){
      if(pieces[i].y > H+60) pieces.splice(i,1);
    }
    if(pieces.length>0) requestAnimationFrame(step);
    else fxCtx.clearRect(0,0,W,H);
  }
  requestAnimationFrame(step);
}
function drawStar(ctx, x, y, spikes, outerRadius, innerRadius){
  let rot = Math.PI/2 * 3;
  let cx = x, cy = y;
  let step = Math.PI / spikes;
  ctx.beginPath();
  ctx.moveTo(cx, cy - outerRadius);
  for(let i=0;i<spikes;i++){
    ctx.lineTo(cx + Math.cos(rot) * outerRadius, cy + Math.sin(rot) * outerRadius);
    rot += step;
    ctx.lineTo(cx + Math.cos(rot) * innerRadius, cy + Math.sin(rot) * innerRadius);
    rot += step;
  }
  ctx.lineTo(cx, cy - outerRadius);
  ctx.closePath();
  ctx.fill();
}

/* ========= utilities ========= */
function pickUnique(arr, n){
  const copy = arr.slice();
  shuffle(copy);
  return copy.slice(0, n);
}
function pickDistractorsZh(correctId, k){
  const pool = WORDS.filter(w=>w.id!==correctId).map(w=>w.zh);
  const picked = [];
  while(picked.length<k){
    const z = pool[Math.floor(Math.random()*pool.length)];
    if(!picked.includes(z)) picked.push(z);
  }
  return picked;
}
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function randSeed(i){
  const x = Math.sin(i*999.123)*10000;
  return x - Math.floor(x);
}
function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}
function toast(msg){
  const t = document.createElement("div");
  t.textContent = msg;
  t.style.position="fixed";
  t.style.left="50%";
  t.style.bottom="18px";
  t.style.transform="translateX(-50%)";
  t.style.background="rgba(15,23,42,.92)";
  t.style.color="#fff";
  t.style.padding="10px 12px";
  t.style.borderRadius="14px";
  t.style.boxShadow="0 18px 34px rgba(2,6,23,.35)";
  t.style.fontWeight="1000";
  t.style.zIndex=70;
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.opacity="0"; t.style.transition="opacity .25s"; }, 1300);
  setTimeout(()=>t.remove(), 1700);
}
function downloadCSV(filename, rows){
  const csv = rows.map(r=>r.map(x=>{
    const s = String(x??"");
    if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
    return s;
  }).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  downloadBlob(filename, blob);
}
function downloadBlob(filename, blob){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

/* ========= hook up top buttons ========= */
btnMap.addEventListener("click", showMap);

/* ========= start from current view ========= */
(function bootstrapView(){
  // show map by default
  showMap();
})();
</script>
</body>
</html>
