<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<title>å—é–€åœ‹å°æ‹¼å­—æŒ‘æˆ° Go</title>
<style>
:root{
  --bg1:#dbeafe; --bg2:#fef3c7; --card:#fff; --ink:#0f172a;
  --blue:#2563eb; --gold:#f59e0b; --ok:#22c55e; --bad:#ef4444;
  --muted:#64748b;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Noto Sans TC",system-ui;
  color:var(--ink);
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
}
header{
  position:sticky; top:0; z-index:10;
  background:linear-gradient(90deg,#1d4ed8,#2563eb);
  color:#fff; padding:12px 10px;
  text-align:center; font-size:22px; font-weight:1000;
}
.wrap{max-width:1100px;margin:10px auto;padding:10px}
.card{
  background:var(--card);
  border-radius:20px;
  padding:14px;
  box-shadow:0 16px 34px rgba(2,6,23,.18);
  margin-bottom:12px;
}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.hidden{display:none !important}
h2{margin:6px 0 10px}
small{color:var(--muted)}
input[type="text"]{
  width:min(420px,100%);
  padding:12px 12px;
  border-radius:14px;
  border:1px solid #cbd5e1;
  font-size:16px;
}
button{
  padding:11px 14px;
  border-radius:14px;
  border:none;
  font-size:16px;
  font-weight:1000;
  cursor:pointer;
  background:var(--blue);
  color:#fff;
}
button.ghost{background:#e5e7eb;color:#111}
button.warn{background:var(--gold);color:#111}
button.danger{background:#ef4444}
.chip{
  display:inline-flex; align-items:center; gap:6px;
  padding:8px 10px; border-radius:999px;
  background:#f1f5f9; font-weight:900; color:#111;
}
.sep{height:1px;background:#e2e8f0;margin:10px 0}
.kbd{font-weight:900;background:#111;color:#fff;border-radius:8px;padding:2px 8px;font-size:12px}
label.opt{
  display:inline-flex; align-items:center; gap:8px;
  padding:10px 12px; border-radius:14px;
  background:#f8fafc; border:1px solid #e2e8f0;
  font-weight:900;
}
label.opt input{transform:scale(1.2)}
/* ===== å¯¶è—åœ°åœ– ===== */
.map{
  position:relative;
  overflow:hidden;
  border-radius:24px;
  border:2px solid var(--gold);
  background:
    radial-gradient(1200px 600px at 15% 0%, #ffffff, transparent 55%),
    linear-gradient(180deg, #bae6fd 0%, #93c5fd 35%, #fef3c7 100%);
  box-shadow:0 22px 48px rgba(2,6,23,.22);
}
.mapInner{height:560px;overflow:auto;padding:16px}
.path{position:relative;min-height:1900px}
.path::before{
  content:"";
  position:absolute; left:50%; top:0; transform:translateX(-50%);
  width:6px; height:100%;
  background:repeating-linear-gradient(to bottom, rgba(120,53,15,.35) 0 12px, transparent 12px 26px);
  border-radius:999px; opacity:.35;
}
.node{
  position:absolute; width:86px; height:86px; border-radius:30px;
  display:grid; place-items:center; text-align:center;
  font-weight:1000; user-select:none;
  background:linear-gradient(180deg,#fff7ed,#fde68a);
  border:3px solid var(--gold);
  box-shadow:0 10px 0 var(--gold), 0 20px 30px rgba(120,53,15,.35);
  transition:transform .15s ease, box-shadow .15s ease;
}
.node:hover{transform:translateY(-4px) scale(1.05)}
.node:active{transform:translateY(3px); box-shadow:0 6px 0 var(--gold),0 12px 18px rgba(120,53,15,.35)}
.node.locked{opacity:.35;filter:grayscale(1)}
.node.passed{
  background:linear-gradient(180deg,#dcfce7,#86efac);
  border-color:var(--ok);
  box-shadow:0 10px 0 var(--ok),0 20px 30px rgba(22,163,74,.35);
}
.node.passed::after{
  content:"ğŸ’°";
  position:absolute; top:-10px; right:-10px;
  background:#fff7ed; border-radius:50%; padding:4px;
  box-shadow:0 6px 12px rgba(0,0,0,.25);
}
.node.current{
  background:linear-gradient(180deg,#fef3c7,#fde047);
  border-color:#eab308;
  animation:pulse 1.4s infinite;
}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(234,179,8,.55)}
  70%{box-shadow:0 0 0 16px rgba(234,179,8,0)}
  100%{box-shadow:0 0 0 0 rgba(234,179,8,0)}
}
.node .ico{font-size:22px; line-height:1}
.node .lv{font-size:12px; margin-top:2px}
.coin{
  position:absolute; font-size:22px; pointer-events:none;
  animation:coinFall 1.8s linear forwards;
}
@keyframes coinFall{
  0%{transform:translateY(-20px) rotate(0deg);opacity:1}
  100%{transform:translateY(120px) rotate(360deg);opacity:0}
}
/* ===== éŠæˆ² ===== */
.topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.big{
  font-size:28px; font-weight:1000; text-align:center; margin:10px 0 6px;
}
.sub{color:var(--muted); text-align:center; font-weight:900}
.modeHint{
  display:flex; gap:8px; flex-wrap:wrap; justify-content:center;
}
.badge{
  display:inline-flex; gap:6px; align-items:center;
  padding:8px 10px; border-radius:999px;
  background:#f8fafc; border:1px solid #e2e8f0;
  font-weight:1000;
}
.choice{
  background:#e0f2fe;
  padding:14px;
  border-radius:16px;
  margin:10px 0;
  font-size:18px;
  font-weight:1000;
  cursor:pointer;
  border:2px solid rgba(0,0,0,0);
}
.choice:hover{transform:translateY(-1px)}
.choice.correct{background:#bbf7d0;border-color:rgba(34,197,94,.45)}
.choice.wrong{background:#fecaca;border-color:rgba(239,68,68,.45)}
.grid2{display:grid;grid-template-columns:1fr;gap:10px}
@media (min-width:760px){.grid2{grid-template-columns:1fr 1fr}}
.cardMini{
  padding:12px;border-radius:16px;background:#f8fafc;border:1px solid #e2e8f0;
  font-weight:1000; cursor:pointer; text-align:center;
}
.cardMini.sel{outline:4px solid rgba(37,99,235,.25); background:#eff6ff}
.answerBox{
  width:min(420px,100%);
  margin:10px auto 0;
  display:flex; gap:10px; justify-content:center; align-items:center;
}
.answerBox input{
  flex:1;
  padding:12px 12px; border-radius:14px; border:1px solid #cbd5e1;
  font-size:18px; font-weight:1000;
  text-transform:lowercase;
}
.notice{
  text-align:center;
  font-weight:1000;
  margin:10px 0 0;
}
.notice.ok{color:var(--ok)}
.notice.bad{color:var(--bad)}
/* ===== Overlay å‹•ç•« ===== */
#overlay{
  position:fixed; inset:0; z-index:50;
  display:none; place-items:center;
  background:rgba(2,6,23,.35);
}
#overlay .box{
  width:min(520px,92vw);
  background:#fff;
  border-radius:22px;
  padding:16px;
  text-align:center;
  box-shadow:0 20px 50px rgba(0,0,0,.35);
}
#overlay .title{font-size:26px;font-weight:1000;margin:6px 0}
#overlay .msg{color:var(--muted);font-weight:900}
#confetti{
  position:fixed; inset:0; z-index:60; pointer-events:none;
  display:none;
}
</style>
</head>
<body>
<header>ğŸ´â€â˜ ï¸ å—é–€åœ‹å°æ‹¼å­—æŒ‘æˆ° Go</header>

<canvas id="confetti"></canvas>

<div id="overlay">
  <div class="box">
    <div class="title" id="ovTitle">ğŸ‰</div>
    <div class="msg" id="ovMsg">å¤ªæ£’äº†ï¼</div>
    <div style="margin-top:12px">
      <button onclick="closeOverlay()">OK</button>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- ç™»å…¥ / è¨­å®š -->
  <div id="screenHome" class="card">
    <h2>ğŸ‘¦ å­¸ç”Ÿç™»å…¥</h2>
    <div class="row">
      <input id="studentName" type="text" placeholder="è¼¸å…¥å­¸ç”Ÿå§“åï¼ˆä¾‹å¦‚ï¼šå°æ˜ï¼‰" />
      <button onclick="login()">é–‹å§‹</button>
      <button class="ghost" onclick="resetAll()">æ¸…ç©ºé€™å°è£ç½®ç´€éŒ„</button>
    </div>

    <div class="sep"></div>

    <h2>ğŸ® é¡Œå‹é¸æ“‡ï¼ˆæ¯é—œ 10 é¡Œï¼‰</h2>
    <div class="row">
      <label class="opt"><input type="checkbox" id="tA" checked /> Aï¼šè½åŠ›é¸å­—</label>
      <label class="opt"><input type="checkbox" id="tB" checked /> Bï¼šçœ‹è‹±é¸å­—</label>
      <label class="opt"><input type="checkbox" id="tC" checked /> Cï¼šä¸­è‹±é…å°</label>
      <label class="opt"><input type="checkbox" id="tD" checked /> Dï¼šè½åŠ›æ‹¼éŸ³</label>
      <span class="chip">å…¨é¸=å››é¡éƒ½è¦</span>
    </div>

    <div class="sep"></div>

    <h2>ğŸ”Š ç™¼éŸ³è¨­å®š</h2>
    <div class="row">
      <span class="chip">é€Ÿåº¦ <b id="rateVal">1.0</b>x</span>
      <input id="rate" type="range" min="0.6" max="1.3" step="0.05" value="1.0" oninput="setRate(this.value)" />
      <button class="warn" onclick="testSpeak()">æ¸¬è©¦ç™¼éŸ³</button>
      <button class="ghost" onclick="toggleFullscreen()">å¹³æ¿å…¨è¢å¹•</button>
    </div>
    <small>æç¤ºï¼šç¬¬ä¸€æ¬¡ä½¿ç”¨è«‹å…ˆæŒ‰ã€Œæ¸¬è©¦ç™¼éŸ³ã€ï¼Œç¢ºä¿ Safari/Chrome æœ‰è²éŸ³ã€‚</small>

    <div class="sep"></div>

    <div class="row">
      <span class="chip">ğŸ’° å·²é€šé—œï¼š<b id="passedCount">0</b>/100</span>
      <span class="chip">ğŸ—ºï¸ ä¸‹ä¸€é—œï¼š<b id="nextLevel">1</b></span>
      <span class="chip">ğŸ… å¾½ç« ï¼š<b id="badgeText">0</b></span>
    </div>
    <small>å¾½ç« ï¼šé€šé—œ 1 / 10 / 50 / 100 é—œæœƒè‡ªå‹•è§£é–ã€‚</small>
  </div>

  <!-- åœ°åœ– -->
  <div id="screenMap" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:6px 0">ğŸ—ºï¸ å¯¶è—åœ°åœ–</h2>
      <div class="row">
        <button class="ghost" onclick="goHome()">è¿”å›é¦–é </button>
      </div>
    </div>
    <div class="map">
      <div class="mapInner" id="mapInner">
        <div class="path" id="path"></div>
      </div>
    </div>
    <small>æ¯é—œå¯é‡ç©ï¼›åªæœ‰ã€Œç¬¬ä¸€æ¬¡é€šé—œã€æœƒç‘å½©å¸¶èˆ‡å¯¶è—ç‰¹æ•ˆã€‚</small>
  </div>

  <!-- éŠæˆ² -->
  <div id="screenGame" class="card hidden">
    <div class="topbar">
      <div class="row">
        <span class="chip">ğŸ‘¦ <b id="who"></b></span>
        <span class="chip">ğŸ¯ ç¬¬ <b id="lvNow"></b> é—œ</span>
        <span class="chip">ğŸ§© ç¬¬ <b id="qNow"></b>/10 é¡Œ</span>
        <span class="chip">âœ… åˆ†æ•¸ <b id="scoreNow">0</b>/10</span>
        <span class="chip">ğŸ”¥ é€£å° <b id="streakNow">0</b></span>
      </div>
      <div class="row">
        <button class="ghost" onclick="prevQuestion()">ä¸Šä¸€é¡Œ</button>
        <button class="ghost" onclick="backToMap()">å›åœ°åœ–</button>
      </div>
    </div>

    <div class="modeHint" id="modeHint"></div>

    <div class="big" id="questionTitle">é¡Œç›®</div>
    <div class="sub" id="questionSub"></div>

    <div id="gameArea"></div>

    <div class="row" style="justify-content:center;margin-top:10px">
      <button onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>
      <button class="warn" onclick="replayAudio()">å†è½ä¸€æ¬¡</button>
    </div>
  </div>
</div>

<script>
/* =======================
   153 å–®å­—é¡Œåº«ï¼ˆè‹±/ä¸­ï¼‰
   ======================= */
const WORDS = [
  {en:"able",zh:"èƒ½å¤ "},{en:"about",zh:"é—œæ–¼"},{en:"after",zh:"åœ¨â€¦ä¹‹å¾Œ"},{en:"again",zh:"å†ä¸€æ¬¡"},{en:"air",zh:"ç©ºæ°£"},
  {en:"all",zh:"æ‰€æœ‰"},{en:"always",zh:"ç¸½æ˜¯"},{en:"angry",zh:"ç”Ÿæ°£çš„"},{en:"animal",zh:"å‹•ç‰©"},{en:"answer",zh:"ç­”æ¡ˆ"},
  {en:"ant",zh:"èèŸ»"},{en:"apple",zh:"è˜‹æœ"},{en:"April",zh:"å››æœˆ"},{en:"arm",zh:"æ‰‹è‡‚"},{en:"ask",zh:"å•"},
  {en:"baby",zh:"å¬°å…’"},{en:"back",zh:"èƒŒéƒ¨"},{en:"ball",zh:"çƒ"},{en:"banana",zh:"é¦™è•‰"},{en:"bath",zh:"æ´—æ¾¡"},
  {en:"bear",zh:"ç†Š"},{en:"bed",zh:"åºŠ"},{en:"bee",zh:"èœœèœ‚"},{en:"behind",zh:"åœ¨â€¦å¾Œé¢"},{en:"bike",zh:"è…³è¸è»Š"},
  {en:"bird",zh:"é³¥"},{en:"black",zh:"é»‘è‰²"},{en:"blue",zh:"è—è‰²"},{en:"boat",zh:"èˆ¹"},{en:"book",zh:"æ›¸"},
  {en:"box",zh:"ç›’å­"},{en:"boy",zh:"ç”·å­©"},{en:"bread",zh:"éºµåŒ…"},{en:"break",zh:"æ‰“ç ´;ä¼‘æ¯"},{en:"brown",zh:"æ£•è‰²"},
  {en:"bus",zh:"å…¬è»Š"},{en:"but",zh:"ä½†æ˜¯"},{en:"butter",zh:"å¥¶æ²¹"},{en:"cake",zh:"è›‹ç³•"},{en:"call",zh:"æ‰“é›»è©±"},
  {en:"cap",zh:"å¸½å­"},{en:"car",zh:"æ±½è»Š"},{en:"cat",zh:"è²“"},{en:"chair",zh:"æ¤…å­"},{en:"chicken",zh:"é›"},
  {en:"children",zh:"å­©å­å€‘"},{en:"Chinese",zh:"ä¸­æ–‡;ä¸­åœ‹äºº"},{en:"chopsticks",zh:"ç­·å­"},{en:"class",zh:"ç­ç´š"},{en:"clean",zh:"ä¹¾æ·¨çš„;æ‰“æƒ"},
  {en:"close",zh:"é—œä¸Š"},{en:"cloud",zh:"é›²"},{en:"cold",zh:"å†·çš„"},{en:"color",zh:"é¡è‰²"},{en:"come",zh:"ä¾†"},
  {en:"cool",zh:"æ¶¼çˆ½çš„;é…·"},{en:"cow",zh:"ç‰›"},{en:"cute",zh:"å¯æ„›çš„"},{en:"dad",zh:"çˆ¸çˆ¸"},{en:"day",zh:"å¤©"},
  {en:"desk",zh:"æ›¸æ¡Œ"},{en:"dirty",zh:"é«’çš„"},{en:"do",zh:"åš"},{en:"doctor",zh:"é†«ç”Ÿ"},{en:"dog",zh:"ç‹—"},
  {en:"doll",zh:"å¨ƒå¨ƒ"},{en:"door",zh:"é–€"},{en:"down",zh:"å‘ä¸‹"},{en:"draw",zh:"ç•«"},{en:"dream",zh:"å¤¢"},
  {en:"drink",zh:"å–"},{en:"drive",zh:"é–‹è»Š"},{en:"duck",zh:"é´¨å­"},{en:"ear",zh:"è€³æœµ"},{en:"eat",zh:"åƒ"},
  {en:"egg",zh:"è›‹"},{en:"eight",zh:"8"},{en:"eleven",zh:"11"},{en:"English",zh:"è‹±æ–‡"},{en:"erase",zh:"æ“¦æ‰"},
  {en:"eraser",zh:"æ©¡çš®æ“¦"},{en:"evening",zh:"æ™šä¸Š"},{en:"eye",zh:"çœ¼ç›"},{en:"face",zh:"è‡‰"},{en:"family",zh:"å®¶åº­"},
  {en:"far",zh:"é çš„"},{en:"fast",zh:"å¿«çš„"},{en:"father",zh:"çˆ¸çˆ¸"},{en:"favorite",zh:"æœ€å–œæ­¡çš„"},{en:"feel",zh:"æ„Ÿè¦º"},
  {en:"fish",zh:"é­š"},{en:"five",zh:"5"},{en:"flower",zh:"èŠ±"},{en:"fly",zh:"é£›"},{en:"food",zh:"é£Ÿç‰©"},
  {en:"four",zh:"4"},{en:"friend",zh:"æœ‹å‹"},{en:"from",zh:"å¾â€¦ä¾†"},{en:"fun",zh:"æœ‰è¶£çš„"},{en:"game",zh:"éŠæˆ²"},
  {en:"garden",zh:"èŠ±åœ’"},{en:"get",zh:"å¾—åˆ°"},{en:"girl",zh:"å¥³å­©"},{en:"give",zh:"çµ¦"},{en:"go",zh:"å»"},
  {en:"good",zh:"å¥½çš„"},{en:"grandma",zh:"å¥¶å¥¶/å¤–å©†"},{en:"grandpa",zh:"çˆºçˆº/å¤–å…¬"},{en:"gray",zh:"ç°è‰²"},{en:"green",zh:"ç¶ è‰²"},
  {en:"hair",zh:"é ­é«®"},{en:"hand",zh:"æ‰‹"},{en:"happy",zh:"é–‹å¿ƒçš„"},{en:"hat",zh:"å¸½å­"},{en:"have",zh:"æœ‰"},
  {en:"head",zh:"é ­"},{en:"help",zh:"å¹«åŠ©"},{en:"here",zh:"é€™è£¡"},{en:"home",zh:"å®¶"},{en:"hot",zh:"ç†±çš„"},
  {en:"house",zh:"æˆ¿å­"},{en:"how",zh:"å¦‚ä½•"},{en:"hungry",zh:"é¤“çš„"},{en:"ice",zh:"å†°"},{en:"in",zh:"åœ¨â€¦è£¡"},
  {en:"inside",zh:"è£¡é¢"},{en:"jump",zh:"è·³"},{en:"kid",zh:"å°å­©"},{en:"kite",zh:"é¢¨ç®"},{en:"lake",zh:"æ¹–"},
  {en:"leg",zh:"è…¿"},{en:"like",zh:"å–œæ­¡;åƒ"},{en:"lion",zh:"ç…å­"},{en:"listen",zh:"è½"},{en:"little",zh:"å°çš„"},
  {en:"look",zh:"çœ‹"},{en:"love",zh:"æ„›"},{en:"lunch",zh:"åˆé¤"},{en:"man",zh:"ç”·äºº"},{en:"many",zh:"å¾ˆå¤š"},
  {en:"mask",zh:"é¢å…·"},{en:"me",zh:"æˆ‘(å—æ ¼)"},{en:"milk",zh:"ç‰›å¥¶"},{en:"mom",zh:"åª½åª½"},{en:"money",zh:"éŒ¢"},
  {en:"moon",zh:"æœˆäº®"},{en:"morning",zh:"æ—©ä¸Š"},{en:"mouse",zh:"è€é¼ "},{en:"my",zh:"æˆ‘çš„"},{en:"name",zh:"åå­—"},
  {en:"near",zh:"é è¿‘çš„"},{en:"new",zh:"æ–°çš„"},{en:"night",zh:"å¤œæ™š"},{en:"nine",zh:"9"},{en:"no",zh:"ä¸"},
  {en:"nose",zh:"é¼»å­"},{en:"not",zh:"ä¸"},{en:"now",zh:"ç¾åœ¨"},{en:"October",zh:"åæœˆ"},{en:"of",zh:"â€¦çš„"},
  {en:"on",zh:"åœ¨â€¦ä¸Š"},{en:"one",zh:"1"},{en:"open",zh:"æ‰“é–‹"},{en:"orange",zh:"æ©˜å­;æ©˜è‰²"},{en:"out",zh:"å¤–é¢"},
  {en:"page",zh:"é æ•¸"},{en:"park",zh:"å…¬åœ’"},{en:"pen",zh:"ç­†"},{en:"pencil",zh:"é‰›ç­†"},{en:"pet",zh:"å¯µç‰©"},
  {en:"pig",zh:"è±¬"},{en:"play",zh:"ç©"},{en:"please",zh:"è«‹"},{en:"put",zh:"æ”¾"},{en:"rain",zh:"é›¨"},
  {en:"read",zh:"è®€"},{en:"red",zh:"ç´…è‰²"},{en:"run",zh:"è·‘"},{en:"sad",zh:"é›£éçš„"},{en:"say",zh:"èªª"},
  {en:"school",zh:"å­¸æ ¡"},{en:"sea",zh:"æµ·"},{en:"see",zh:"çœ‹è¦‹"},{en:"seven",zh:"7"},{en:"she",zh:"å¥¹"},
  {en:"ship",zh:"èˆ¹"},{en:"shoe",zh:"é‹å­"},{en:"six",zh:"6"},{en:"sleep",zh:"ç¡è¦º"},{en:"small",zh:"å°çš„"},
  {en:"snow",zh:"é›ª"},{en:"sorry",zh:"å°ä¸èµ·"},{en:"sun",zh:"å¤ªé™½"},{en:"table",zh:"æ¡Œå­"},{en:"talk",zh:"èªªè©±"},
  {en:"teacher",zh:"è€å¸«"},{en:"ten",zh:"10"},{en:"thank",zh:"è¬è¬"},{en:"three",zh:"3"},{en:"time",zh:"æ™‚é–“"},
  {en:"tiger",zh:"è€è™"},{en:"to",zh:"åˆ°;å»"},{en:"today",zh:"ä»Šå¤©"},{en:"tomorrow",zh:"æ˜å¤©"},{en:"two",zh:"2"},
  {en:"turtle",zh:"çƒé¾œ"},{en:"under",zh:"åœ¨â€¦ä¸‹é¢"},{en:"up",zh:"ä¸Šé¢"},{en:"water",zh:"æ°´"},{en:"week",zh:"æ˜ŸæœŸ"},
  {en:"white",zh:"ç™½è‰²"},{en:"why",zh:"ç‚ºä»€éº¼"},{en:"with",zh:"å’Œâ€¦ä¸€èµ·"},{en:"yellow",zh:"é»ƒè‰²"},{en:"zoo",zh:"å‹•ç‰©åœ’"}
];
// è‹¥ä½ æƒ³æª¢æŸ¥æ•¸é‡ï¼š
if(WORDS.length!==153){ console.warn("WORDS length:", WORDS.length); }

/* ========= ç‹€æ…‹å„²å­˜ ========= */
const STORE_KEY="nmps_spelling_go_singlefile_v1";
const state = loadState();

function loadState(){
  try{ return JSON.parse(localStorage.getItem(STORE_KEY)) || {students:{},settings:{rate:1.0}}; }
  catch{ return {students:{},settings:{rate:1.0}}; }
}
function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

function getStudent(name){
  if(!state.students[name]){
    state.students[name]={
      passed:{}, // level -> true
      bestScore:{}, // level -> best
      firstPassConfetti:{}, // level -> true
      badges:{b1:false,b10:false,b50:false,b100:false}
    };
  }
  return state.students[name];
}

/* ========= UI å…ƒç´  ========= */
const screenHome=document.getElementById("screenHome");
const screenMap=document.getElementById("screenMap");
const screenGame=document.getElementById("screenGame");
const pathEl=document.getElementById("path");
const mapInner=document.getElementById("mapInner");

const passedCountEl=document.getElementById("passedCount");
const nextLevelEl=document.getElementById("nextLevel");
const badgeTextEl=document.getElementById("badgeText");

const whoEl=document.getElementById("who");
const lvNowEl=document.getElementById("lvNow");
const qNowEl=document.getElementById("qNow");
const scoreNowEl=document.getElementById("scoreNow");
const streakNowEl=document.getElementById("streakNow");

const modeHintEl=document.getElementById("modeHint");
const questionTitle=document.getElementById("questionTitle");
const questionSub=document.getElementById("questionSub");
const gameArea=document.getElementById("gameArea");

const rateSlider=document.getElementById("rate");
const rateVal=document.getElementById("rateVal");

/* ========= å…¨åŸŸéŠæˆ²ç‹€æ…‹ ========= */
let studentName="";
let stu=null;
let selectedTypes=["A","B","C","D"];
let currentLevel=1;
let plan=[]; // 10 é¡Œé¡Œå‹
let qIndex=0;
let score=0;
let streak=0;

let curWord=null;          // æœ¬é¡Œç›®å­—
let curType="A";
let lastSpokenWord=null;   // for replay
let answered=false;
let history=[]; // é¡Œç›®è¨˜éŒ„ï¼ˆå¯ä¸Šä¸€é¡Œï¼‰ï¼š[{type, word, ...snapshot}]

/* ========= é¡Œå‹æé†’ ========= */
const TYPE_DESC = {
  A:"Aï¼šè½åŠ›é¸å­—ï¼ˆä¸é¡¯ç¤ºè‹±æ–‡ï¼‰",
  B:"Bï¼šçœ‹è‹±é¸å­—",
  C:"Cï¼šä¸­è‹±é…å°",
  D:"Dï¼šè½åŠ›æ‹¼éŸ³ï¼ˆéŒ¯äº†é¡¯ç¤ºæ­£è§£ï¼‰"
};

/* ========= ç™¼éŸ³ï¼ˆæ›´æ¸…æ¥šï¼šåªå¿µå–®å­—ï¼‰ ========= */
let speakRate = state.settings.rate ?? 1.0;
rateSlider.value = String(speakRate);
rateVal.textContent = String(speakRate.toFixed(2)).replace(/\.00$/,".0");

function setRate(v){
  speakRate = Number(v);
  rateVal.textContent = String(speakRate.toFixed(2)).replace(/\.00$/,".0");
  state.settings.rate = speakRate;
  saveState();
}

function speakWord(word){
  lastSpokenWord = word;
  try{
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(word);
    u.lang = "en-US";
    u.rate = speakRate;
    u.pitch = 1.0;
    u.volume = 1.0;
    window.speechSynthesis.speak(u);
  }catch(e){
    console.warn(e);
  }
}
function replayAudio(){
  if(lastSpokenWord) speakWord(lastSpokenWord);
}
function testSpeak(){
  speakWord("hello");
}

/* ========= é¦–é  ========= */
function login(){
  const v=document.getElementById("studentName").value.trim();
  if(!v) return alert("è«‹è¼¸å…¥å­¸ç”Ÿå§“å");
  studentName=v;
  stu=getStudent(studentName);

  // è®€å–é¡Œå‹
  const A=document.getElementById("tA").checked;
  const B=document.getElementById("tB").checked;
  const C=document.getElementById("tC").checked;
  const D=document.getElementById("tD").checked;
  selectedTypes=[];
  if(A) selectedTypes.push("A");
  if(B) selectedTypes.push("B");
  if(C) selectedTypes.push("C");
  if(D) selectedTypes.push("D");
  if(selectedTypes.length===0){
    alert("è‡³å°‘é¸ä¸€ç¨®é¡Œå‹");
    return;
  }

  updateHomeStats();
  showMap();
}

function updateHomeStats(){
  if(!stu) return;
  const passed = Object.keys(stu.passed).length;
  passedCountEl.textContent = String(passed);

  // ä¸‹ä¸€é—œ = æœ€å°æœªé€šé—œ
  let next=1;
  for(let i=1;i<=100;i++){
    if(!stu.passed[String(i)]){ next=i; break; }
  }
  nextLevelEl.textContent = String(next);

  // å¾½ç« æ–‡å­—
  const b = [];
  if(stu.badges.b1) b.push("ğŸª™");
  if(stu.badges.b10) b.push("ğŸ§°");
  if(stu.badges.b50) b.push("ğŸ´â€â˜ ï¸");
  if(stu.badges.b100) b.push("ğŸ†");
  badgeTextEl.textContent = b.length ? b.join(" ") : "0";
}

function resetAll(){
  if(!confirm("ç¢ºå®šè¦æ¸…ç©ºé€™å°è£ç½®çš„æ‰€æœ‰å­¸ç”Ÿç´€éŒ„ï¼Ÿ")) return;
  localStorage.removeItem(STORE_KEY);
  location.reload();
}

function goHome(){
  screenMap.classList.add("hidden");
  screenGame.classList.add("hidden");
  screenHome.classList.remove("hidden");
  updateHomeStats();
}

/* ========= åœ°åœ– ========= */
function showMap(){
  screenHome.classList.add("hidden");
  screenGame.classList.add("hidden");
  screenMap.classList.remove("hidden");
  renderMap();
}

function renderMap(){
  pathEl.innerHTML="";
  const nextLv = Number(nextLevelEl.textContent || "1");

  for(let i=1;i<=100;i++){
    const n=document.createElement("div");
    const passed=!!stu.passed[String(i)];
    const locked = i>nextLv+10 ? false : false; // ä¸é–ï¼Œå…¨éƒ¨å¯ç©ï¼ˆä½ è¦æ±‚å¯é‡ç©ã€å¯é¸é—œï¼‰
    n.className="node"+(passed?" passed":"")+(i===nextLv?" current":"")+(locked?" locked":"");

    // å·¦å³è›‡å½¢è·¯ç·š
    const isLeft = (Math.floor((i-1)/5)%2===0) ? ((i-1)%5<3) : !((i-1)%5<3);
    const x = isLeft ? 22 : 68;
    const y = 40 + (i-1)*80; // æ‹‰é•·è·¯ç·š
    n.style.left = `calc(${x}% - 43px)`;
    n.style.top  = `${y}px`;

    const ico =
      (i%10===0) ? "ğŸ†" :
      (i%5===0) ? "ğŸ§°" :
      (i%4===0) ? "ğŸ’°" :
      (i%3===0) ? "âŒ" : "ğŸ—ºï¸";

    n.innerHTML = `<div class="ico">${ico}</div><div class="lv">ç¬¬${i}é—œ</div>`;
    n.onclick = ()=>startLevel(i);
    pathEl.appendChild(n);
  }

  // æ²åˆ°ç›®å‰é—œ
  setTimeout(()=>{
    const cur = [...pathEl.querySelectorAll(".node")].find(el=>el.classList.contains("current"));
    if(cur){
      const top = cur.offsetTop - 220;
      mapInner.scrollTop = Math.max(0, top);
      // æ‰é‡‘å¹£ï¼ˆåŠ å¯¶è—æ„Ÿï¼‰
      const r = cur.getBoundingClientRect();
      dropCoins(r.left + r.width/2, r.top + mapInner.scrollTop);
    }
  }, 50);
}

function dropCoins(x, y){
  for(let i=0;i<8;i++){
    const c=document.createElement("div");
    c.className="coin";
    c.textContent="ğŸª™";
    c.style.left = (x + (Math.random()*50-25)) + "px";
    c.style.top  = (y + (Math.random()*10-5)) + "px";
    pathEl.appendChild(c);
    setTimeout(()=>c.remove(),1800);
  }
}

/* ========= é¡Œå‹è¨ˆç•«ï¼ˆæ¯é—œ10é¡Œï¼‰ ========= */
function buildPlan(types){
  const plan=[];
  // ä¿è­‰ã€Œå…¨é¸ã€æ™‚å››é¡éƒ½æœƒå‡ºç¾
  const uniq = [...new Set(types)];
  if(uniq.length===4){
    // 10é¡Œåˆ†é…ï¼šA,B,C,D å…ˆå„ 2 é¡Œ =8ï¼Œå†è£œ2é¡Œéš¨æ©Ÿ
    const base = ["A","A","B","B","C","C","D","D"];
    base.forEach(t=>plan.push(t));
    while(plan.length<10) plan.push(uniq[Math.floor(Math.random()*uniq.length)]);
  }else{
    // å…ˆè®“æ¯ä¸€é¡è‡³å°‘å‡ºç¾ä¸€æ¬¡ï¼ˆè‹¥é¡Œæ•¸è¶³å¤ ï¼‰
    uniq.forEach(t=>plan.push(t));
    while(plan.length<10) plan.push(uniq[Math.floor(Math.random()*uniq.length)]);
  }
  // æ‰“äº‚
  for(let i=plan.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [plan[i],plan[j]]=[plan[j],plan[i]];
  }
  return plan;
}

/* ========= é–‹å§‹é—œå¡ ========= */
function startLevel(lv){
  currentLevel=lv;
  plan = buildPlan(selectedTypes);
  qIndex=0; score=0; streak=0;
  history=[];
  whoEl.textContent=studentName;
  lvNowEl.textContent=String(currentLevel);
  scoreNowEl.textContent="0";
  streakNowEl.textContent="0";

  screenMap.classList.add("hidden");
  screenHome.classList.add("hidden");
  screenGame.classList.remove("hidden");

  nextQuestion(true);
}

function backToMap(){
  screenGame.classList.add("hidden");
  screenMap.classList.remove("hidden");
  updateHomeStats();
  renderMap();
}

/* ========= é¡Œç›®éš¨æ©Ÿå–å­— + ç”Ÿæˆé¸é … ========= */
function randWord(){
  return WORDS[Math.floor(Math.random()*WORDS.length)];
}
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function pickZhChoices(correctZh, n=4){
  const set=new Set([correctZh]);
  while(set.size<n){
    set.add(WORDS[Math.floor(Math.random()*WORDS.length)].zh);
  }
  return shuffle([...set]);
}

/* ========= é¡Œç›®é¡¯ç¤º ========= */
function renderHint(){
  // é¡Œå‹æé†’ï¼ˆ4ç¨®ï¼‰
  const chips = ["A","B","C","D"].map(t=>{
    const on = selectedTypes.includes(t);
    return `<span class="badge" style="opacity:${on?1:.35}">${t}ï½œ${TYPE_DESC[t].split("ï½œ")[1] || TYPE_DESC[t]}</span>`;
  }).join("");
  modeHintEl.innerHTML = chips;
}

function setHeader(){
  lvNowEl.textContent=String(currentLevel);
  qNowEl.textContent=String(qIndex+1);
  scoreNowEl.textContent=String(score);
  streakNowEl.textContent=String(streak);
}

function nextQuestion(isFirst=false){
  if(!isFirst && !answered){
    // æ²’ä½œç­”å°±æŒ‰ä¸‹ä¸€é¡Œï¼šæé†’ä¸€ä¸‹ï¼ˆä¸ç¡¬æ“‹ï¼‰
    flashOverlay("âš ï¸ å…ˆä½œç­”å†ä¸‹ä¸€é¡Œ", "é€™é¡Œé‚„æ²’é¸ç­”æ¡ˆå–”ï¼");
    return;
  }

  // é—œå¡çµæŸ
  if(qIndex>=10){
    finishLevel();
    return;
  }

  answered=false;
  renderHint();
  setHeader();

  curType = plan[qIndex];
  curWord = randWord();
  lastSpokenWord = null;

  // é¡Œç›®æ¨™é¡Œ
  questionSub.textContent = TYPE_DESC[curType];
  gameArea.innerHTML = "";

  // Aï¼šè½åŠ›é¸å­—ï¼ˆä¸é¡¯ç¤ºè‹±æ–‡ï¼‰
  if(curType==="A"){
    questionTitle.textContent = "ğŸ”Š è½ä¸€è½ï¼Œé¸æ­£ç¢ºä¸­æ–‡";
    const btnRow = document.createElement("div");
    btnRow.className="row";
    btnRow.style.justifyContent="center";
    btnRow.innerHTML = `<button class="warn" onclick="speakWord(curWord.en)">æ’­æ”¾ç™¼éŸ³</button>`;
    gameArea.appendChild(btnRow);

    // ä¸é¡¯ç¤ºè‹±æ–‡å–®å­—
    const choices = pickZhChoices(curWord.zh, 4);
    choices.forEach(c=>{
      const d=document.createElement("div");
      d.className="choice";
      d.textContent=c;
      d.onclick=()=>gradeChoice(c, curWord.zh, null);
      gameArea.appendChild(d);
    });

    // é€²ä¾†å°±è‡ªå‹•æ’­ä¸€æ¬¡
    setTimeout(()=>speakWord(curWord.en), 200);
  }

  // Bï¼šçœ‹è‹±é¸å­—
  if(curType==="B"){
    questionTitle.textContent = curWord.en;
    questionSub.textContent = "ğŸ‘€ çœ‹è‹±æ–‡ï¼Œé¸æ­£ç¢ºä¸­æ–‡";
    const choices = pickZhChoices(curWord.zh, 4);
    choices.forEach(c=>{
      const d=document.createElement("div");
      d.className="choice";
      d.textContent=c;
      d.onclick=()=>gradeChoice(c, curWord.zh, null);
      gameArea.appendChild(d);
    });
  }

  // Cï¼šä¸­è‹±é…å°ï¼ˆ4çµ„ï¼‰
  if(curType==="C"){
    questionTitle.textContent = "ğŸ§© ä¸­è‹±é…å°ï¼ˆé…æˆä¸€çµ„ï¼‰";
    questionSub.textContent = "é»ä¸€å€‹è‹±æ–‡ â†’ å†é»ä¸€å€‹ä¸­æ–‡å®Œæˆé…å°";
    // å– 4 å€‹ä¸åŒå–®å­—
    const pool=[];
    while(pool.length<4){
      const w=randWord();
      if(!pool.some(x=>x.en===w.en)) pool.push(w);
    }
    const ens=shuffle(pool.map(w=>w.en));
    const zhs=shuffle(pool.map(w=>w.zh));
    const map = new Map(pool.map(w=>[w.en,w.zh]));

    const left=document.createElement("div");
    const right=document.createElement("div");
    left.className="cardMiniList";
    right.className="cardMiniList";

    const wrap=document.createElement("div");
    wrap.className="grid2";

    const leftBox=document.createElement("div");
    const rightBox=document.createElement("div");
    leftBox.style.display="grid"; leftBox.style.gap="10px";
    rightBox.style.display="grid"; rightBox.style.gap="10px";

    let selEn=null, selEnEl=null;
    let matched=0;

    function mkCard(text, side){
      const c=document.createElement("div");
      c.className="cardMini";
      c.textContent=text;
      c.dataset.side=side;
      return c;
    }

    ens.forEach(en=>{
      const c=mkCard(en,"en");
      c.onclick=()=>{
        if(c.classList.contains("done")) return;
        if(selEnEl) selEnEl.classList.remove("sel");
        selEn=en; selEnEl=c; c.classList.add("sel");
      };
      leftBox.appendChild(c);
    });

    zhs.forEach(zh=>{
      const c=mkCard(zh,"zh");
      c.onclick=()=>{
        if(c.classList.contains("done")) return;
        if(!selEn) return;
        const correctZh = map.get(selEn);
        if(zh===correctZh){
          // æˆåŠŸ
          c.classList.add("done");
          selEnEl.classList.add("done");
          selEnEl.classList.remove("sel");
          c.style.background="#bbf7d0";
          selEnEl.style.background="#bbf7d0";
          matched++;
          selEn=null; selEnEl=null;
          if(matched===4){
            // å…¨å°æ‰ç®—å°
            gradeBoolean(true, "é…å°å®Œæˆ âœ…");
          }
        }else{
          // éŒ¯èª¤æç¤ºï¼ˆä¸æ‰£åˆ†å¤šæ¬¡ï¼Œç•¶ä½œé€™é¡Œä»å¯å®Œæˆï¼‰
          c.classList.add("wrongFlash");
          flashOverlay("âŒ ä¸å°å–”", "å†è©¦ä¸€æ¬¡ï½");
          setTimeout(()=>c.classList.remove("wrongFlash"),300);
        }
      };
      rightBox.appendChild(c);
    });

    wrap.appendChild(leftBox);
    wrap.appendChild(rightBox);
    gameArea.appendChild(wrap);
  }

  // Dï¼šè½åŠ›æ‹¼éŸ³ï¼ˆæ‹¼è‹±æ–‡ï¼‰
  if(curType==="D"){
    questionTitle.textContent = "ğŸ”Š è½ä¸€è½ï¼Œæ‹¼å‡ºè‹±æ–‡";
    questionSub.textContent = "ä¸çœ‹è‹±æ–‡ï¼Œé è€³æœµæ‹¼å­—ï¼ˆéŒ¯äº†æœƒé¡¯ç¤ºæ­£è§£ï¼‰";

    const btnRow=document.createElement("div");
    btnRow.className="row";
    btnRow.style.justifyContent="center";
    btnRow.innerHTML = `<button class="warn" onclick="speakWord(curWord.en)">æ’­æ”¾ç™¼éŸ³</button>`;
    gameArea.appendChild(btnRow);

    const box=document.createElement("div");
    box.className="answerBox";
    box.innerHTML = `
      <input id="spellInput" type="text" placeholder="è¼¸å…¥è‹±æ–‡æ‹¼å­—â€¦" autocomplete="off" autocapitalize="none" spellcheck="false">
      <button onclick="checkSpelling()">é€å‡º</button>
    `;
    gameArea.appendChild(box);

    setTimeout(()=>{ speakWord(curWord.en); document.getElementById("spellInput").focus(); }, 250);
  }

  // è¨˜éŒ„é¡Œç›®ï¼ˆçµ¦ä¸Šä¸€é¡Œç”¨ï¼‰
  history[qIndex] = { type:curType, word:curWord };
}

function prevQuestion(){
  if(qIndex<=0) return;
  // å›ä¸Šä¸€é¡Œï¼šä¸è¨ˆåˆ†å›æº¯ï¼ˆåªå›é¡¯é¡Œç›®ï¼‰
  qIndex--;
  answered=true; // é¿å…å¡ä½
  // é‡æ–°é¡¯ç¤ºä¸Šä¸€é¡Œï¼ˆç”¨åŸé¡Œå‹èˆ‡å–®å­—ï¼‰
  const snap = history[qIndex];
  curType = snap.type;
  curWord = snap.word;
  answered=false;
  renderHint();
  setHeader();

  questionSub.textContent = TYPE_DESC[curType];
  gameArea.innerHTML="";

  if(curType==="A"){
    questionTitle.textContent="ğŸ”Š è½ä¸€è½ï¼Œé¸æ­£ç¢ºä¸­æ–‡";
    const btnRow=document.createElement("div");
    btnRow.className="row"; btnRow.style.justifyContent="center";
    btnRow.innerHTML=`<button class="warn" onclick="speakWord(curWord.en)">æ’­æ”¾ç™¼éŸ³</button>`;
    gameArea.appendChild(btnRow);
    const choices = pickZhChoices(curWord.zh,4);
    choices.forEach(c=>{
      const d=document.createElement("div");
      d.className="choice"; d.textContent=c;
      d.onclick=()=>gradeChoice(c,curWord.zh,null);
      gameArea.appendChild(d);
    });
  }
  if(curType==="B"){
    questionTitle.textContent=curWord.en;
    questionSub.textContent="ğŸ‘€ çœ‹è‹±æ–‡ï¼Œé¸æ­£ç¢ºä¸­æ–‡";
    const choices = pickZhChoices(curWord.zh,4);
    choices.forEach(c=>{
      const d=document.createElement("div");
      d.className="choice"; d.textContent=c;
      d.onclick=()=>gradeChoice(c,curWord.zh,null);
      gameArea.appendChild(d);
    });
  }
  if(curType==="C"){
    // é‡åšé…å°ï¼ˆä¸Šä¸€é¡Œä¸åšä¿å­˜é…å°é€²åº¦ï¼‰
    questionTitle.textContent="ğŸ§© ä¸­è‹±é…å°ï¼ˆé…æˆä¸€çµ„ï¼‰";
    questionSub.textContent="é»ä¸€å€‹è‹±æ–‡ â†’ å†é»ä¸€å€‹ä¸­æ–‡å®Œæˆé…å°";
    // ç”¨å›ºå®š poolï¼šä»¥è©²å–®å­—ç‚ºå…¶ä¸­ä¹‹ä¸€ï¼Œè£œ3å€‹
    const pool=[curWord];
    while(pool.length<4){
      const w=randWord();
      if(!pool.some(x=>x.en===w.en)) pool.push(w);
    }
    const ens=shuffle(pool.map(w=>w.en));
    const zhs=shuffle(pool.map(w=>w.zh));
    const map = new Map(pool.map(w=>[w.en,w.zh]));
    const wrap=document.createElement("div"); wrap.className="grid2";
    const leftBox=document.createElement("div"); leftBox.style.display="grid"; leftBox.style.gap="10px";
    const rightBox=document.createElement("div"); rightBox.style.display="grid"; rightBox.style.gap="10px";
    let selEn=null, selEnEl=null, matched=0;

    ens.forEach(en=>{
      const c=document.createElement("div");
      c.className="cardMini"; c.textContent=en;
      c.onclick=()=>{
        if(c.classList.contains("done")) return;
        if(selEnEl) selEnEl.classList.remove("sel");
        selEn=en; selEnEl=c; c.classList.add("sel");
      };
      leftBox.appendChild(c);
    });
    zhs.forEach(zh=>{
      const c=document.createElement("div");
      c.className="cardMini"; c.textContent=zh;
      c.onclick=()=>{
        if(c.classList.contains("done")) return;
        if(!selEn) return;
        if(zh===map.get(selEn)){
          c.classList.add("done");
          selEnEl.classList.add("done");
          selEnEl.classList.remove("sel");
          c.style.background="#bbf7d0";
          selEnEl.style.background="#bbf7d0";
          matched++; selEn=null; selEnEl=null;
          if(matched===4) gradeBoolean(true,"é…å°å®Œæˆ âœ…");
        }else{
          flashOverlay("âŒ ä¸å°å–”","å†è©¦ä¸€æ¬¡ï½");
        }
      };
      rightBox.appendChild(c);
    });
    wrap.appendChild(leftBox); wrap.appendChild(rightBox);
    gameArea.appendChild(wrap);
  }
  if(curType==="D"){
    questionTitle.textContent="ğŸ”Š è½ä¸€è½ï¼Œæ‹¼å‡ºè‹±æ–‡";
    questionSub.textContent="ä¸çœ‹è‹±æ–‡ï¼Œé è€³æœµæ‹¼å­—ï¼ˆéŒ¯äº†æœƒé¡¯ç¤ºæ­£è§£ï¼‰";
    const btnRow=document.createElement("div");
    btnRow.className="row"; btnRow.style.justifyContent="center";
    btnRow.innerHTML=`<button class="warn" onclick="speakWord(curWord.en)">æ’­æ”¾ç™¼éŸ³</button>`;
    gameArea.appendChild(btnRow);
    const box=document.createElement("div");
    box.className="answerBox";
    box.innerHTML=`<input id="spellInput" type="text" placeholder="è¼¸å…¥è‹±æ–‡æ‹¼å­—â€¦" autocomplete="off" autocapitalize="none" spellcheck="false"><button onclick="checkSpelling()">é€å‡º</button>`;
    gameArea.appendChild(box);
  }
}

function gradeChoice(pick, correct, extra){
  if(answered) return;
  answered=true;
  const choices=[...document.querySelectorAll(".choice")];
  choices.forEach(el=>{
    if(el.textContent===correct) el.classList.add("correct");
    if(el.textContent===pick && pick!==correct) el.classList.add("wrong");
    el.style.pointerEvents="none";
  });
  if(pick===correct){
    score++; streak++;
    bumpStreak();
  }else{
    streak=0;
    // éŒ¯äº†é¡¯ç¤ºæ­£è§£ï¼ˆå·²æ¨™ç¶ ï¼‰
    flashOverlay("âŒ ç­”éŒ¯äº†", `æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correct}`);
  }
  scoreNowEl.textContent=String(score);
  streakNowEl.textContent=String(streak);
  qIndex++;
}

function gradeBoolean(ok, msg){
  if(answered) return;
  answered=true;
  if(ok){
    score++; streak++;
    bumpStreak();
    flashOverlay("âœ… å¤ªæ£’äº†ï¼", msg || "ç­”å°ï¼");
  }else{
    streak=0;
    flashOverlay("âŒ å†è©¦ä¸€æ¬¡", msg || "");
  }
  scoreNowEl.textContent=String(score);
  streakNowEl.textContent=String(streak);
  qIndex++;
}

function checkSpelling(){
  if(answered) return;
  const input=document.getElementById("spellInput");
  if(!input) return;
  const v=(input.value||"").trim().toLowerCase();
  const correct=curWord.en.toLowerCase();
  answered=true;

  const note=document.createElement("div");
  if(v===correct){
    score++; streak++;
    bumpStreak();
    note.className="notice ok";
    note.textContent="âœ… æ­£ç¢ºï¼";
  }else{
    streak=0;
    note.className="notice bad";
    note.textContent=`âŒ éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆï¼š${curWord.en}`;
    flashOverlay("âŒ æ‹¼éŒ¯äº†", `æ­£ç¢ºç­”æ¡ˆï¼š${curWord.en}`);
  }
  gameArea.appendChild(note);

  scoreNowEl.textContent=String(score);
  streakNowEl.textContent=String(streak);
  qIndex++;
}

/* ========= é€£å‹å‹•ç•«ï¼ˆ5/10ï¼‰ ========= */
let streak5Shown=false, streak10Shown=false;
function bumpStreak(){
  if(streak===5 && !streak5Shown){
    streak5Shown=true;
    flashOverlay("ğŸ”¥ é€£çºŒç­”å° 5 é¡Œï¼","å¤ªå¼·äº†ï¼Œç¹¼çºŒæŒ–å¯¶ï½");
  }
  if(streak===10 && !streak10Shown){
    streak10Shown=true;
    flashOverlay("ğŸ’¥ é€£çºŒç­”å° 10 é¡Œï¼","ä½ æ˜¯æ‹¼å­—å¤§é­”ç‹ï¼");
  }
}

/* ========= é—œå¡çµæŸ ========= */
function finishLevel(){
  // å­˜æœ€ä½³åˆ†
  const lvKey=String(currentLevel);
  const best = stu.bestScore[lvKey] ?? 0;
  if(score>best) stu.bestScore[lvKey]=score;

  const firstPass = !stu.passed[lvKey];
  if(score>=7){ // 7/10 ä»¥ä¸Šç®—é€šé—œï¼ˆä½ å¯è‡ªè¡Œæ”¹ï¼‰
    stu.passed[lvKey]=true;
  }

  // æ›´æ–°å¾½ç« ï¼ˆçœ‹é€šé—œæ•¸ï¼‰
  const passed = Object.keys(stu.passed).length;
  if(passed>=1) stu.badges.b1=true;
  if(passed>=10) stu.badges.b10=true;
  if(passed>=50) stu.badges.b50=true;
  if(passed>=100) stu.badges.b100=true;

  saveState();
  updateHomeStats();

  // åªåœ¨ç¬¬ä¸€æ¬¡é€šé—œç‘å½©å¸¶
  if(firstPass && score>=7){
    runConfetti();
    flashOverlay("ğŸ´â€â˜ ï¸ æ‰¾åˆ°å¯¶è—äº†ï¼", `ç¬¬ ${currentLevel} é—œé€šé—œï¼åˆ†æ•¸ ${score}/10`);
  }else{
    flashOverlay(score>=7 ? "âœ… é€šé—œæˆåŠŸï¼" : "â›ï¸ å†æŒ–ä¸€æ¬¡ï¼", `åˆ†æ•¸ ${score}/10ï¼ˆé€šé—œé–€æª» 7ï¼‰`);
  }

  // å›åœ°åœ–
  backToMap();
}

/* ========= Overlay ========= */
function flashOverlay(title, msg){
  document.getElementById("ovTitle").textContent=title;
  document.getElementById("ovMsg").textContent=msg||"";
  document.getElementById("overlay").style.display="grid";
}
function closeOverlay(){
  document.getElementById("overlay").style.display="none";
}

/* ========= å…¨è¢å¹• ========= */
async function toggleFullscreen(){
  try{
    if(!document.fullscreenElement){
      await document.documentElement.requestFullscreen();
    }else{
      await document.exitFullscreen();
    }
  }catch(e){
    alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´å…¨è¢å¹•ï¼ŒiPad å¯ç”¨ã€åŠ å…¥ä¸»ç•«é¢ã€é”åˆ°é¡ä¼¼æ•ˆæœã€‚");
  }
}

/* ========= å½©å¸¶ï¼ˆç°¡å–®ç‰ˆ confettiï¼‰ ========= */
const confettiCanvas=document.getElementById("confetti");
const ctx=confettiCanvas.getContext("2d");
let confettiOn=false;
let confettiPieces=[];
function resizeConfetti(){
  confettiCanvas.width=window.innerWidth;
  confettiCanvas.height=window.innerHeight;
}
window.addEventListener("resize", resizeConfetti);
resizeConfetti();

function runConfetti(){
  confettiCanvas.style.display="block";
  confettiOn=true;
  confettiPieces=[];
  const n=180;
  for(let i=0;i<n;i++){
    confettiPieces.push({
      x:Math.random()*confettiCanvas.width,
      y:-20-Math.random()*confettiCanvas.height,
      r:4+Math.random()*6,
      vy:2+Math.random()*5,
      vx:(Math.random()-.5)*2,
      rot:Math.random()*Math.PI,
      vr:(Math.random()-.5)*0.2
    });
  }
  let t=0;
  function frame(){
    if(!confettiOn) return;
    t++;
    ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    confettiPieces.forEach((p,idx)=>{
      p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr;
      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = `hsl(${(idx*7)%360} 90% 55%)`;
      ctx.fillRect(-p.r, -p.r/2, p.r*2, p.r);
      ctx.restore();
    });
    confettiPieces = confettiPieces.filter(p=>p.y<confettiCanvas.height+40);
    if(t<140){
      requestAnimationFrame(frame);
    }else{
      confettiOn=false;
      confettiCanvas.style.display="none";
    }
  }
  requestAnimationFrame(frame);
}

/* ========= å…¥å£ï¼šå›å¡«çµ±è¨ˆ ========= */
(function init(){
  // å…ˆæ›´æ–°é¦–é æ•¸å­—ï¼ˆæœªç™»å…¥æ™‚é¡¯ç¤º 0ï¼‰
  passedCountEl.textContent="0";
  nextLevelEl.textContent="1";
  badgeTextEl.textContent="0";
})();
</script>
</body>
</html>
