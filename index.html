<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>å—é–€åœ‹å°æ‹¼å­—æŒ‘æˆ°Go</title>
  <style>
    :root{
      --bg1:#f6fbff; --bg2:#eef4ff;
      --card:#ffffffcc; --card2:#ffffff;
      --text:#111827; --muted:#6b7280;
      --primary:#2563eb; --primary2:#1d4ed8;
      --good:#16a34a; --bad:#ef4444; --warn:#f59e0b;
      --chip:#e5efff;
      --shadow: 0 12px 30px rgba(15,23,42,.10);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", Arial;
      color:var(--text);
      background: radial-gradient(1000px 700px at 20% 10%, #ffffff, transparent 60%),
                  radial-gradient(900px 600px at 90% 30%, #dbeafe, transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    a{color:var(--primary); text-decoration:none}
    .wrap{max-width:980px; margin:0 auto; padding:18px 14px 42px;}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:10px; margin:6px 0 12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, #60a5fa, #22c55e);
      display:grid; place-items:center; color:white; box-shadow: var(--shadow);
      font-size:22px;
    }
    .title{
      line-height:1.1;
    }
    .title h1{margin:0; font-size:20px;}
    .title p{margin:2px 0 0; color:var(--muted); font-size:12px;}
    .topbtns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    button{
      border:0; border-radius:14px; padding:10px 12px;
      background: #fff; color:var(--text);
      box-shadow: 0 10px 22px rgba(2,6,23,.08);
      cursor:pointer; font-weight:700;
    }
    button.primary{background: linear-gradient(180deg, var(--primary), var(--primary2)); color:white;}
    button.ghost{background:#ffffffaa}
    button.small{padding:8px 10px; border-radius:12px; font-weight:800}
    button:disabled{opacity:.45; cursor:not-allowed}
    .card{
      background: var(--card);
      border: 1px solid rgba(15,23,42,.06);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding:16px;
      backdrop-filter: blur(8px);
    }
    .grid{display:grid; gap:12px;}
    @media(min-width:860px){ .grid.cols2{grid-template-columns: 1.1fr .9fr;} }

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .muted{color:var(--muted)}
    .chip{
      background: var(--chip);
      padding:7px 10px;
      border-radius: 999px;
      font-weight:800;
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid rgba(37,99,235,.14);
    }
    .chip b{font-weight:900}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background:#fff; border:1px solid rgba(15,23,42,.08);
      box-shadow: 0 10px 22px rgba(2,6,23,.06);
      font-weight:800;
    }
    .input{
      width:min(360px, 92vw);
      padding:12px 12px; border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      font-size:16px; outline:none;
    }
    .map{
      position:relative;
      overflow:hidden;
      border-radius: var(--radius);
      border:1px solid rgba(15,23,42,.06);
      background: linear-gradient(180deg, #ffffffcc, #f8fbffcc);
      box-shadow: var(--shadow);
      min-height: 520px;
    }
    .mapInner{
      height: 520px;
      overflow:auto;
      padding:16px 14px 26px;
      scroll-behavior:smooth;
    }
    .path{
      position:relative;
      width:100%;
      min-height: 1600px;
      padding-bottom: 40px;
    }
    .node{
      position:absolute;
      width:70px; height:70px;
      border-radius: 22px;
      display:grid; place-items:center;
      font-weight:1000;
      user-select:none;
      border:1px solid rgba(15,23,42,.10);
      box-shadow: 0 14px 24px rgba(2,6,23,.10);
      background:#fff;
    }
    .node .n{font-size:14px}
    .node .i{font-size:20px; line-height:1}
    .node.locked{opacity:.45; filter:grayscale(.35)}
    .node.passed{
      background: linear-gradient(180deg, #dcfce7, #bbf7d0);
      border-color: rgba(22,163,74,.25);
    }
    .node.current{
      outline: 4px solid rgba(37,99,235,.20);
    }
    .node:active{transform: translateY(1px)}
    .legend{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
    }
    .legend .left{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .progressbar{
      height:10px; width:100%;
      background: rgba(15,23,42,.08);
      border-radius:999px; overflow:hidden;
    }
    .progressbar > div{
      height:100%; width:0%;
      background: linear-gradient(90deg, #22c55e, #60a5fa);
      border-radius:999px;
      transition: width .25s ease;
    }

    /* Game */
    .game{
      display:none;
    }
    .gameHeader{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;
    }
    .bigWord{
      font-size:44px; letter-spacing:.5px; font-weight:1000;
      text-align:center;
      margin:14px 0 8px;
    }
    .sub{ text-align:center; color:var(--muted); font-weight:800; margin-bottom: 10px;}
    .choices{
      display:grid; gap:10px;
    }
    @media(min-width:560px){ .choices.grid2{grid-template-columns: 1fr 1fr;} }
    .choice{
      background:#fff;
      border:1px solid rgba(15,23,42,.08);
      padding:14px 14px;
      border-radius: 18px;
      font-size:20px; font-weight:1000;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
      cursor:pointer;
    }
    .choice:hover{transform: translateY(-1px)}
    .choice.correct{border-color: rgba(22,163,74,.35); background: #dcfce7;}
    .choice.wrong{border-color: rgba(239,68,68,.35); background: #fee2e2;}
    .hintBox{
      background:#fff;
      border:1px solid rgba(15,23,42,.08);
      border-radius: 18px;
      padding:12px;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
    }
    .controls{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:10px;
    }
    .barRow{
      display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap;
    }
    .range{
      width:min(260px, 86vw);
    }
    .modeTag{
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      padding:8px 12px; border-radius:999px; background:#fff;
      border:1px solid rgba(15,23,42,.08); font-weight:1000;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
    }
    .status{
      text-align:center;
      font-weight:1000;
      margin-top:8px;
      min-height: 26px;
    }
    .status.good{color:var(--good)}
    .status.bad{color:var(--bad)}
    .answerReveal{
      margin-top:8px; text-align:center; font-weight:1000;
      color: var(--muted);
    }

    /* Matching */
    .matchGrid{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;
    }
    .tile{
      background:#fff;
      border:1px solid rgba(15,23,42,.08);
      border-radius:18px;
      padding:14px 12px;
      font-weight:1000;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
      cursor:pointer;
      min-height:54px;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      user-select:none;
    }
    .tile.sel{outline:4px solid rgba(37,99,235,.20)}
    .tile.done{opacity:.40}
    .tile.ok{background:#dcfce7; border-color: rgba(22,163,74,.35)}
    .tile.no{background:#fee2e2; border-color: rgba(239,68,68,.35)}

    /* Spell */
    .spellRow{
      display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin:10px 0;
    }
    .box{
      width:36px; height:44px; border-radius:12px;
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      display:grid; place-items:center;
      font-size:20px; font-weight:1000;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
    }
    .kbd{
      display:grid; grid-template-columns: repeat(7, 1fr);
      gap:8px; margin-top:10px;
    }
    @media(min-width:560px){ .kbd{grid-template-columns: repeat(10, 1fr);} }
    .kbtn{
      padding:12px 0;
      border-radius:14px;
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
      font-weight:1000;
      box-shadow: 0 10px 18px rgba(2,6,23,.05);
      cursor:pointer;
      user-select:none;
    }
    .kbtn:active{transform: translateY(1px)}
    .footerBtns{
      display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:14px;
    }

    /* Teacher modal */
    .modal{
      position:fixed; inset:0;
      display:none; place-items:center;
      background: rgba(2,6,23,.55);
      padding:16px;
      z-index: 50;
    }
    .modal .panel{
      width:min(1000px, 96vw);
      max-height: 86vh;
      overflow:auto;
      background:#fff;
      border-radius: 22px;
      box-shadow: 0 28px 70px rgba(2,6,23,.25);
      padding:16px;
    }
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{border-bottom:1px solid rgba(15,23,42,.08); padding:8px; text-align:left; vertical-align:top}
    th{background:#f8fafc}
    .right{text-align:right}
    .kpi{
      display:grid; grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media(max-width:860px){ .kpi{grid-template-columns: repeat(2, 1fr);} }
    .kpi .k{
      background:#f8fafc; border:1px solid rgba(15,23,42,.08);
      border-radius:18px; padding:10px;
    }
    .k .v{font-size:18px; font-weight:1000}
    .k .l{color:var(--muted); font-weight:900; font-size:12px}
    .note{font-size:12px; color:var(--muted); line-height:1.5}

    /* Confetti canvas */
    #fx{
      position:fixed; inset:0; pointer-events:none; z-index: 40;
    }
  </style>
</head>

<body>
<canvas id="fx"></canvas>

<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">ğŸ«</div>
      <div class="title">
        <h1>å—é–€åœ‹å°æ‹¼å­—æŒ‘æˆ°Go</h1>
        <p>153é¡Œåº«ï½œåœ°åœ–100é—œï½œæ¯é—œ10é¡Œï½œæ¯é—œéš¨æ©Ÿæ¨¡å¼ A/B/C/D</p>
      </div>
    </div>
    <div class="topbtns">
      <button class="small ghost" id="btnFullscreen">ğŸ–¥ï¸ å…¨è¢å¹•</button>
      <button class="small" id="btnMap">ğŸ—ºï¸ åœ°åœ–</button>
      <button class="small" id="btnTeacher">ğŸ‘©â€ğŸ« è€å¸«å¾Œå°</button>
    </div>
  </header>

  <!-- Login + Map -->
  <div id="screenMap" class="grid cols2">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="pill">ğŸ‘¦ å­¸ç”Ÿç™»å…¥</span>
          <span class="chip">ç›®å‰ï¼š<b id="curStudent">æœªç™»å…¥</b></span>
        </div>
        <div class="row">
          <button class="small" id="btnSwitch">ğŸ” åˆ‡æ›</button>
          <button class="small primary" id="btnStartNext">â–¶ï¸ é–‹å§‹ä¸‹ä¸€é—œ</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <input class="input" id="studentInput" placeholder="è¼¸å…¥å­¸ç”Ÿå§“åï¼ˆä¾‹ï¼šå°æ˜ï¼‰" />
        <button class="primary" id="btnLogin">ç™»å…¥</button>
      </div>
      <div class="note" style="margin-top:10px">
        âœ… åŒä¸€æ”¯æ‰‹æ©Ÿ/å¹³æ¿æœƒè¨˜éŒ„å¤šä½å­¸ç”Ÿã€‚<br>
        âš ï¸ å¦‚æœå­¸ç”Ÿåœ¨ã€Œä¸åŒæ‰‹æ©Ÿã€ç™»å…¥åŒå/ä¸åŒåï¼šå› ç‚ºé€™æ˜¯ç´”å‰ç«¯ç¶²é ï¼Œè³‡æ–™<strong>åªå­˜è©²è£ç½®</strong>ã€‚è¦å½™æ•´è«‹ç”¨ã€Œè€å¸«å¾Œå° â†’ åŒ¯å‡ºCSVã€æˆ–ã€ŒåŒ¯å‡º/åŒ¯å…¥JSONã€æ”¶ä½œæ¥­ã€‚
      </div>

      <div class="card" style="margin-top:12px; background:#fff">
        <div class="legend">
          <div class="left">
            <span class="pill">ğŸ¯ é€²åº¦</span>
            <span class="chip">å·²é€šé—œï¼š<b id="passedCount">0</b>/100</span>
            <span class="chip">ä¸‹ä¸€é—œï¼š<b id="nextLevel">1</b></span>
          </div>
          <span class="pill">æ¨¡å¼ï¼š<b id="todayMode">æ¯é—œéš¨æ©Ÿ</b></span>
        </div>
        <div style="margin-top:10px" class="progressbar"><div id="overallBar"></div></div>
      </div>
    </div>

    <div class="map">
      <div class="mapInner" id="mapInner">
        <div class="path" id="path"></div>
      </div>
    </div>
  </div>

  <!-- Game -->
  <div id="screenGame" class="game">
    <div class="card">
      <div class="gameHeader">
        <div class="row">
          <span class="pill">ğŸ¯ ç¬¬ <b id="gLevel">1</b> é—œ</span>
          <span class="chip">ç¬¬ <b id="gQ">1</b>/10 é¡Œ</span>
          <span class="chip">â­ <b id="gScore">0</b>/10</span>
          <span class="chip">â±ï¸ <b id="gTime">0:00</b></span>
        </div>
        <div class="row">
          <span class="modeTag" id="gModeTag">A</span>
          <button class="small" id="btnPrevQ">â¬…ï¸ ä¸Šä¸€é¡Œ</button>
          <button class="small" id="btnBackMap">ğŸ—ºï¸ å›åœ°åœ–</button>
        </div>
      </div>

      <div class="barRow" style="margin-top:10px">
        <button id="btnSpeak" class="primary">ğŸ”Š æ’­æ”¾</button>
        <span class="pill">ğŸ¢â¡ï¸ğŸ‡ ç™¼éŸ³é€Ÿåº¦</span>
        <input id="rate" class="range" type="range" min="0.7" max="1.2" step="0.05" value="0.95">
        <span class="chip">x<b id="rateVal">0.95</b></span>
        <button class="small" id="btnVoice">ğŸ™ï¸ é‡æ–°é¸èªéŸ³</button>
      </div>

      <div id="gameBody" style="margin-top:14px"></div>

      <div class="status" id="status"></div>
      <div class="answerReveal" id="reveal"></div>

      <div class="footerBtns">
        <button id="btnNext" class="primary">â¡ï¸ ä¸‹ä¸€é¡Œ</button>
        <button id="btnRetry" class="ghost">ğŸ” é‡ç©æœ¬é—œ</button>
      </div>
    </div>
  </div>
</div>

<!-- Teacher Modal -->
<div class="modal" id="teacherModal">
  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <span class="pill">ğŸ‘©â€ğŸ« è€å¸«å¾Œå°</span>
        <span class="chip">è£ç½®å…§å­¸ç”Ÿæ•¸ï¼š<b id="stuCount">0</b></span>
      </div>
      <div class="row">
        <button class="small" id="btnCloseTeacher">âœ–ï¸ é—œé–‰</button>
      </div>
    </div>

    <div class="note" style="margin:10px 0">
      âœ… åŒ¯å‡ºCSVå¯ç”¨Excelé–‹ã€‚<br>
      âœ… ã€ŒåŒ¯å‡ºJSONã€å¯è®“å­¸ç”ŸæŠŠè‡ªå·±é‚£å°çš„é€²åº¦äº¤çµ¦è€å¸«ï¼Œå†åœ¨è€å¸«çš„è£ç½®ã€ŒåŒ¯å…¥JSONã€å½™æ•´ã€‚<br>
      âš ï¸ GitHub Pages æ˜¯éœæ…‹ç¶²ç«™ï¼Œ<strong>ä¸æœƒè‡ªå‹•æŠŠä¸åŒæ‰‹æ©Ÿè³‡æ–™é›†ä¸­</strong>ï¼ˆé™¤éä½ åŠ å¾Œç«¯/è³‡æ–™åº«ï¼‰ã€‚
    </div>

    <div class="row" style="margin:10px 0; justify-content:space-between">
      <div class="row">
        <button class="small primary" id="btnExportCSV">â¬‡ï¸ åŒ¯å‡ºCSV(Excel)</button>
        <button class="small" id="btnExportJSON">â¬‡ï¸ åŒ¯å‡ºJSON(å½™æ•´ç”¨)</button>
        <button class="small" id="btnImportJSON">â¬†ï¸ åŒ¯å…¥JSON(å½™æ•´)</button>
        <input id="importFile" type="file" accept="application/json" style="display:none">
      </div>
      <div class="row">
        <button class="small" id="btnResetAll">ğŸ§¹ æ¸…ç©ºæœ¬è£ç½®è³‡æ–™</button>
      </div>
    </div>

    <div class="kpi" style="margin:10px 0">
      <div class="k"><div class="v" id="kTotalPlays">0</div><div class="l">ç¸½æŒ‘æˆ°æ¬¡æ•¸(å…¨éƒ¨å­¸ç”Ÿ)</div></div>
      <div class="k"><div class="v" id="kTotalPass">0</div><div class="l">ç¸½é€šé—œæ¬¡æ•¸(å«é‡ç©)</div></div>
      <div class="k"><div class="v" id="kAvgScore">0</div><div class="l">å¹³å‡åˆ†æ•¸(æ¯é—œ10é¡Œ)</div></div>
      <div class="k"><div class="v" id="kTopWrong">â€”</div><div class="l">æœ€å¸¸éŒ¯çš„å–®å­—</div></div>
    </div>

    <h3 style="margin:12px 0 6px">ğŸ“Š å­¸ç”Ÿé€²åº¦ä¸€è¦½</h3>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>å­¸ç”Ÿ</th>
            <th class="right">å·²é€šé—œ</th>
            <th class="right">ä¸‹ä¸€é—œ</th>
            <th class="right">ç¸½æŒ‘æˆ°æ¬¡æ•¸</th>
            <th>æœ€è¿‘ä¸€æ¬¡</th>
          </tr>
        </thead>
        <tbody id="tblStudents"></tbody>
      </table>
    </div>

    <h3 style="margin:14px 0 6px">âŒ éŒ¯é¡Œçµ±è¨ˆ(Top 30)</h3>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr><th>å–®å­—</th><th>ä¸­æ–‡</th><th class="right">éŒ¯èª¤æ¬¡æ•¸</th></tr>
        </thead>
        <tbody id="tblWrong"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* =======================
   é¡Œåº«ï¼š153ï¼ˆè‹±â†’ä¸­ï¼‰
   ======================= */
const WORDS = [{"id": 1, "en": "able", "zh": "èƒ½å¤ "}, {"id": 2, "en": "all", "zh": "æ‰€æœ‰"}, {"id": 3, "en": "after", "zh": "åœ¨â€¦ä¹‹å¾Œ"}, {"id": 4, "en": "and", "zh": "å’Œ"}, {"id": 5, "en": "any", "zh": "ä»»ä½•"}, {"id": 6, "en": "ant", "zh": "èèŸ»"}, {"id": 7, "en": "apple", "zh": "è˜‹æœ"}, {"id": 8, "en": "April", "zh": "å››æœˆ"}, {"id": 9, "en": "ask", "zh": "å•"}, {"id": 10, "en": "book", "zh": "æ›¸"}, {"id": 11, "en": "baby", "zh": "å¬°å…’"}, {"id": 12, "en": "back", "zh": "èƒŒéƒ¨"}, {"id": 13, "en": "bad", "zh": "å£çš„"}, {"id": 14, "en": "ball", "zh": "çƒ"}, {"id": 15, "en": "band", "zh": "æ¨‚éšŠ"}, {"id": 16, "en": "bar", "zh": "é…’å§"}, {"id": 17, "en": "bat", "zh": "è™è ;çƒæ£’"}, {"id": 18, "en": "beach", "zh": "æµ·ç˜"}, {"id": 19, "en": "bear", "zh": "ç†Š"}, {"id": 20, "en": "bee", "zh": "èœœèœ‚"}, {"id": 21, "en": "bite", "zh": "å’¬"}, {"id": 22, "en": "bicycle", "zh": "è…³è¸è»Š"}, {"id": 23, "en": "big", "zh": "å¤§çš„"}, {"id": 24, "en": "bird", "zh": "é³¥"}, {"id": 25, "en": "blue", "zh": "è—è‰²"}, {"id": 26, "en": "boat", "zh": "èˆ¹"}, {"id": 27, "en": "box", "zh": "ç›’å­"}, {"id": 28, "en": "boy", "zh": "ç”·å­©"}, {"id": 29, "en": "bread", "zh": "éºµåŒ…"}, {"id": 30, "en": "break", "zh": "æ‰“ç ´;ä¼‘æ¯"}, {"id": 31, "en": "bus", "zh": "å…¬è»Š"}, {"id": 32, "en": "but", "zh": "ä½†æ˜¯"}, {"id": 33, "en": "butter", "zh": "å¥¶æ²¹"}, {"id": 34, "en": "cake", "zh": "è›‹ç³•"}, {"id": 35, "en": "call", "zh": "æ‰“é›»è©±"}, {"id": 36, "en": "cap", "zh": "å¸½å­"}, {"id": 37, "en": "cat", "zh": "è²“"}, {"id": 38, "en": "chair", "zh": "æ¤…å­"}, {"id": 39, "en": "chicken", "zh": "é›"}, {"id": 40, "en": "Chinese", "zh": "ä¸­æ–‡;ä¸­åœ‹äºº"}, {"id": 41, "en": "chopsticks", "zh": "ç­·å­"}, {"id": 42, "en": "cool", "zh": "æ¶¼çˆ½çš„;é…·"}, {"id": 43, "en": "cow", "zh": "ç‰›"}, {"id": 44, "en": "cute", "zh": "å¯æ„›çš„"}, {"id": 45, "en": "dad", "zh": "çˆ¸çˆ¸"}, {"id": 46, "en": "day", "zh": "å¤©"}, {"id": 47, "en": "desk", "zh": "æ›¸æ¡Œ"}, {"id": 48, "en": "did", "zh": "åš(éå»å¼)"}, {"id": 49, "en": "do", "zh": "åš"}, {"id": 50, "en": "doctor", "zh": "é†«ç”Ÿ"}, {"id": 51, "en": "dog", "zh": "ç‹—"}, {"id": 52, "en": "doll", "zh": "å¨ƒå¨ƒ"}, {"id": 53, "en": "door", "zh": "é–€"}, {"id": 54, "en": "down", "zh": "å‘ä¸‹"}, {"id": 55, "en": "drink", "zh": "å–"}, {"id": 56, "en": "duck", "zh": "é´¨å­"}, {"id": 57, "en": "egg", "zh": "è›‹"}, {"id": 58, "en": "eight", "zh": "8"}, {"id": 59, "en": "eleven", "zh": "11"}, {"id": 60, "en": "English", "zh": "è‹±æ–‡"}, {"id": 61, "en": "erase", "zh": "æ“¦æ‰"}, {"id": 62, "en": "eraser", "zh": "æ©¡çš®æ“¦"}, {"id": 63, "en": "fact", "zh": "äº‹å¯¦"}, {"id": 64, "en": "fall", "zh": "ç§‹å¤©;è·Œå€’"}, {"id": 65, "en": "fan", "zh": "é›»æ‰‡;ç²‰çµ²"}, {"id": 66, "en": "father", "zh": "çˆ¸çˆ¸"}, {"id": 67, "en": "fin", "zh": "é­šé°­"}, {"id": 68, "en": "five", "zh": "5"}, {"id": 69, "en": "flower", "zh": "èŠ±"}, {"id": 70, "en": "four", "zh": "4"}, {"id": 71, "en": "friend", "zh": "æœ‹å‹"}, {"id": 72, "en": "from", "zh": "å¾â€¦ä¾†"}, {"id": 73, "en": "fun", "zh": "æœ‰è¶£çš„"}, {"id": 74, "en": "game", "zh": "éŠæˆ²"}, {"id": 75, "en": "girl", "zh": "å¥³å­©"}, {"id": 76, "en": "go", "zh": "å»"}, {"id": 77, "en": "good", "zh": "å¥½çš„"}, {"id": 78, "en": "green", "zh": "ç¶ è‰²"}, {"id": 79, "en": "hat", "zh": "å¸½å­"}, {"id": 80, "en": "have", "zh": "æœ‰"}, {"id": 81, "en": "he", "zh": "ä»–"}, {"id": 82, "en": "help", "zh": "å¹«åŠ©"}, {"id": 83, "en": "hot", "zh": "ç†±çš„"}, {"id": 84, "en": "how", "zh": "å¦‚ä½•"}, {"id": 85, "en": "I", "zh": "æˆ‘"}, {"id": 86, "en": "in", "zh": "åœ¨â€¦è£¡"}, {"id": 87, "en": "is", "zh": "æ˜¯"}, {"id": 88, "en": "it", "zh": "å®ƒ"}, {"id": 89, "en": "jacket", "zh": "å¤–å¥—"}, {"id": 90, "en": "January", "zh": "ä¸€æœˆ"}, {"id": 91, "en": "jump", "zh": "è·³"}, {"id": 92, "en": "kid", "zh": "å°å­©"}, {"id": 93, "en": "kite", "zh": "é¢¨ç®"}, {"id": 94, "en": "lake", "zh": "æ¹–"}, {"id": 95, "en": "leg", "zh": "è…¿"}, {"id": 96, "en": "let", "zh": "è®“"}, {"id": 97, "en": "like", "zh": "å–œæ­¡;åƒ"}, {"id": 98, "en": "lion", "zh": "ç…å­"}, {"id": 99, "en": "lips", "zh": "å˜´å”‡"}, {"id": 100, "en": "look", "zh": "çœ‹"}, {"id": 101, "en": "love", "zh": "æ„›"}, {"id": 102, "en": "man", "zh": "ç”·äºº"}, {"id": 103, "en": "mask", "zh": "é¢å…·"}, {"id": 104, "en": "me", "zh": "æˆ‘(å—æ ¼)"}, {"id": 105, "en": "milk", "zh": "ç‰›å¥¶"}, {"id": 106, "en": "mom", "zh": "åª½åª½"}, {"id": 107, "en": "moon", "zh": "æœˆäº®"}, {"id": 108, "en": "my", "zh": "æˆ‘çš„"}, {"id": 109, "en": "new", "zh": "æ–°çš„"}, {"id": 110, "en": "nine", "zh": "9"}, {"id": 111, "en": "nose", "zh": "é¼»å­"}, {"id": 112, "en": "not", "zh": "ä¸"}, {"id": 113, "en": "now", "zh": "ç¾åœ¨"}, {"id": 114, "en": "October", "zh": "åæœˆ"}, {"id": 115, "en": "of", "zh": "â€¦çš„"}, {"id": 116, "en": "on", "zh": "åœ¨â€¦ä¸Š"}, {"id": 117, "en": "one", "zh": "1"}, {"id": 118, "en": "open", "zh": "æ‰“é–‹"}, {"id": 119, "en": "orange", "zh": "æ©˜å­;æ©˜è‰²"}, {"id": 120, "en": "page", "zh": "é æ•¸"}, {"id": 121, "en": "pen", "zh": "ç­†"}, {"id": 122, "en": "pet", "zh": "å¯µç‰©"}, {"id": 123, "en": "pig", "zh": "è±¬"}, {"id": 124, "en": "play", "zh": "ç©"}, {"id": 125, "en": "please", "zh": "è«‹"}, {"id": 126, "en": "rain", "zh": "é›¨"}, {"id": 127, "en": "read", "zh": "è®€"}, {"id": 128, "en": "red", "zh": "ç´…è‰²"}, {"id": 129, "en": "run", "zh": "è·‘"}, {"id": 130, "en": "sad", "zh": "é›£éçš„"}, {"id": 131, "en": "say", "zh": "èªª"}, {"id": 132, "en": "school", "zh": "å­¸æ ¡"}, {"id": 133, "en": "sea", "zh": "æµ·"}, {"id": 134, "en": "see", "zh": "çœ‹è¦‹"}, {"id": 135, "en": "seven", "zh": "7"}, {"id": 136, "en": "she", "zh": "å¥¹"}, {"id": 137, "en": "six", "zh": "6"}, {"id": 138, "en": "sun", "zh": "å¤ªé™½"}, {"id": 139, "en": "table", "zh": "æ¡Œå­"}, {"id": 140, "en": "talk", "zh": "èªªè©±"}, {"id": 141, "en": "teacher", "zh": "è€å¸«"}, {"id": 142, "en": "ten", "zh": "10"}, {"id": 143, "en": "three", "zh": "3"}, {"id": 144, "en": "tiger", "zh": "è€è™"}, {"id": 145, "en": "time", "zh": "æ™‚é–“"}, {"id": 146, "en": "to", "zh": "åˆ°;å»"}, {"id": 147, "en": "two", "zh": "2"}, {"id": 148, "en": "tub", "zh": "æµ´ç¼¸"}, {"id": 149, "en": "turtle", "zh": "çƒé¾œ"}, {"id": 150, "en": "tree", "zh": "æ¨¹"}, {"id": 151, "en": "up", "zh": "ä¸Šé¢"}, {"id": 152, "en": "water", "zh": "æ°´"}, {"id": 153, "en": "yellow", "zh": "é»ƒè‰²"}];

/* =======================
   è¨­å®š
   ======================= */
const LEVELS = 100;
const Q_PER_LEVEL = 10;
const PASS_SCORE = 8; // >=8/10 è¦–ç‚ºé€šé—œ
const MODES = ["A","B","C","D"]; // Aè½â†’é¸ä¸­(ä¸é¡¯ç¤ºè‹±) Bçœ‹è‹±â†’é¸ä¸­ Cè‹±ä¸­é…å° Dè½â†’æ‹¼è‹±

const LS_KEY = "nmps_spelling_go_v3";

/* =======================
   ç‹€æ…‹
   ======================= */
let state = loadState();
let curStudent = state.curStudent || "";
let inLevel = 1;
let levelMode = "A";
let questions = [];
let qIndex = 0;
let score = 0;
let startTs = 0;
let timerId = null;
let canNext = false;
let lastSpokenWord = "";

// Teacher password (ç°¡å–®ä¿è­·ï¼šä½ å¯æ”¹)
const TEACHER_PASS = "nmps";

/* =======================
   DOM
   ======================= */
const $ = (id)=>document.getElementById(id);

const screenMap = $("screenMap");
const screenGame = $("screenGame");

const curStudentEl = $("curStudent");
const passedCountEl = $("passedCount");
const nextLevelEl = $("nextLevel");
const overallBar = $("overallBar");
const pathEl = $("path");
const mapInner = $("mapInner");

const studentInput = $("studentInput");

const gLevel = $("gLevel");
const gQ = $("gQ");
const gScore = $("gScore");
const gTime = $("gTime");
const gModeTag = $("gModeTag");
const gameBody = $("gameBody");
const statusEl = $("status");
const revealEl = $("reveal");

const btnLogin = $("btnLogin");
const btnSwitch = $("btnSwitch");
const btnStartNext = $("btnStartNext");
const btnMap = $("btnMap");
const btnTeacher = $("btnTeacher");
const btnBackMap = $("btnBackMap");
const btnPrevQ = $("btnPrevQ");
const btnNext = $("btnNext");
const btnRetry = $("btnRetry");
const btnSpeak = $("btnSpeak");
const btnVoice = $("btnVoice");

const rate = $("rate");
const rateVal = $("rateVal");

const btnFullscreen = $("btnFullscreen");

/* Teacher */
const teacherModal = $("teacherModal");
const btnCloseTeacher = $("btnCloseTeacher");
const btnExportCSV = $("btnExportCSV");
const btnExportJSON = $("btnExportJSON");
const btnImportJSON = $("btnImportJSON");
const importFile = $("importFile");
const btnResetAll = $("btnResetAll");
const tblStudents = $("tblStudents");
const tblWrong = $("tblWrong");
const stuCountEl = $("stuCount");
const kTotalPlays = $("kTotalPlays");
const kTotalPass = $("kTotalPass");
const kAvgScore = $("kAvgScore");
const kTopWrong = $("kTopWrong");
const todayMode = $("todayMode");

/* FX */
const fx = $("fx");
const fxCtx = fx.getContext("2d");

/* =======================
   Init
   ======================= */
function init(){
  // Fix canvas size
  resizeFx();
  window.addEventListener("resize", resizeFx);

  // Events
  btnLogin.onclick = doLogin;
  btnSwitch.onclick = ()=>{ state.curStudent=""; curStudent=""; saveState(); renderMapUI(); toast("å·²ç™»å‡ºï¼Œè«‹é‡æ–°è¼¸å…¥å§“å"); };
  btnStartNext.onclick = startNextLevel;
  btnMap.onclick = ()=>showMap();
  btnTeacher.onclick = openTeacher;
  btnCloseTeacher.onclick = ()=> teacherModal.style.display="none";
  btnBackMap.onclick = ()=> showMap();
  btnPrevQ.onclick = prevQuestion;
  btnNext.onclick = nextQuestion;
  btnRetry.onclick = ()=> startLevel(inLevel, true);
  btnSpeak.onclick = ()=> speakCurrent();
  btnVoice.onclick = ()=> pickBestVoice(true);

  rate.oninput = ()=>{
    rateVal.textContent = Number(rate.value).toFixed(2);
    state.settings.rate = Number(rate.value);
    saveState();
  };

  btnFullscreen.onclick = requestFull;

  document.addEventListener("keydown", (e)=>{
    if(screenGame.style.display!=="none"){
      if(e.key==="ArrowRight") nextQuestion();
      if(e.key==="ArrowLeft") prevQuestion();
      if(e.key===" ") { e.preventDefault(); speakCurrent(); }
    }
  });

  // load settings
  if(!state.settings) state.settings = {};
  if(!state.settings.rate) state.settings.rate = 0.95;
  rate.value = state.settings.rate;
  rateVal.textContent = Number(rate.value).toFixed(2);

  // render
  renderMap();
  renderMapUI();

  // voices
  speechSynthesis.onvoiceschanged = ()=> pickBestVoice(false);
  pickBestVoice(false);
}
init();

/* =======================
   Storage
   ======================= */
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return {students:{}, curStudent:"", settings:{rate:0.95}};
    const obj = JSON.parse(raw);
    if(!obj.students) obj.students = {};
    if(!obj.settings) obj.settings = {rate:0.95};
    return obj;
  }catch{
    return {students:{}, curStudent:"", settings:{rate:0.95}};
  }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function ensureStudent(name){
  if(!state.students[name]){
    state.students[name] = {
      createdAt: Date.now(),
      levels: {}, // level -> {bestScore, bestTimeMs, attempts, passed, firstPassConfettiDone}
      wrong: {},  // wordId -> count
      plays: 0,
      lastAt: 0
    };
  }
  return state.students[name];
}
function getStu(){
  if(!curStudent) return null;
  return ensureStudent(curStudent);
}

/* =======================
   Login
   ======================= */
function doLogin(){
  const name = (studentInput.value||"").trim();
  if(!name){ toast("è«‹è¼¸å…¥å§“å"); return; }
  curStudent = name;
  state.curStudent = name;
  ensureStudent(name);
  saveState();
  studentInput.value="";
  renderMapUI();
  toast(`ç™»å…¥æˆåŠŸï¼š${name}`);
}

/* =======================
   Map
   ======================= */
function renderMap(){
  // generate a wavy path with 100 nodes
  pathEl.innerHTML = "";
  const W = pathEl.clientWidth || 600;
  const topPadding = 30;
  const gapY = 140; // spacing between nodes
  const totalH = topPadding + gapY*(LEVELS-1) + 120;
  pathEl.style.minHeight = totalH+"px";

  for(let i=1;i<=LEVELS;i++){
    const node = document.createElement("div");
    node.className = "node";
    node.dataset.level = i;

    // x alternates: left/right with slight randomness
    const t = i-1;
    const base = (t%2===0) ? 0.25 : 0.75;
    const jitter = (randSeed(i)*0.12)-0.06;
    const x = clamp(base + jitter, 0.16, 0.84);
    const y = topPadding + gapY*(i-1);

    node.style.left = `calc(${(x*100).toFixed(2)}% - 35px)`;
    node.style.top = `${y}px`;

    const icon = (i%10===0) ? "ğŸ†" : (i%5===0) ? "ğŸ" : (i%3===0) ? "â­" : "ğŸ¯";
    node.innerHTML = `<div class="i">${icon}</div><div class="n">ç¬¬${i}é—œ</div>`;
    node.onclick = ()=> startLevel(i, false);

    pathEl.appendChild(node);
  }
  // scroll to near current
  setTimeout(()=>scrollToCurrent(), 200);
}
function renderMapUI(){
  curStudentEl.textContent = curStudent || "æœªç™»å…¥";
  const stu = getStu();
  let passedCount = 0;
  let nextLv = 1;

  if(stu){
    for(let i=1;i<=LEVELS;i++){
      if(stu.levels[i]?.passed) passedCount++;
    }
    nextLv = 1;
    for(let i=1;i<=LEVELS;i++){
      if(!stu.levels[i]?.passed){ nextLv=i; break; }
      nextLv = Math.min(LEVELS, i+1);
    }
  }

  passedCountEl.textContent = passedCount;
  nextLevelEl.textContent = nextLv;
  overallBar.style.width = `${Math.round((passedCount/LEVELS)*100)}%`;

  // update nodes locked/passed/current
  const nodes = [...pathEl.querySelectorAll(".node")];
  nodes.forEach(n=>{
    const lv = Number(n.dataset.level);
    n.classList.remove("locked","passed","current");
    let locked = true;
    let passed = false;
    if(!stu){
      locked = (lv!==1);
    }else{
      passed = !!stu.levels[lv]?.passed;
      locked = (lv>1 && !stu.levels[lv-1]?.passed && !passed); // lock unless previous passed (or itself already passed)
      if(lv===1) locked = false;
    }
    if(locked) n.classList.add("locked");
    if(passed) n.classList.add("passed");
    if(stu && lv===nextLv) n.classList.add("current");
  });

  todayMode.textContent = "æ¯é—œéš¨æ©Ÿ A/B/C/D";

  btnStartNext.disabled = !curStudent;
}
function scrollToCurrent(){
  const stu = getStu();
  if(!stu) return;
  let nextLv = 1;
  for(let i=1;i<=LEVELS;i++){
    if(!stu.levels[i]?.passed){ nextLv=i; break; }
    nextLv = Math.min(LEVELS, i+1);
  }
  const node = pathEl.querySelector(`.node[data-level="${nextLv}"]`);
  if(node){
    const y = node.offsetTop - 160;
    mapInner.scrollTo({top: Math.max(0,y), behavior:"smooth"});
  }
}
function startNextLevel(){
  if(!curStudent){ toast("è«‹å…ˆç™»å…¥å­¸ç”Ÿå§“å"); return; }
  const stu = getStu();
  let nextLv = 1;
  for(let i=1;i<=LEVELS;i++){
    if(!stu.levels[i]?.passed){ nextLv=i; break; }
    nextLv = Math.min(LEVELS, i+1);
  }
  startLevel(nextLv, false);
}

/* =======================
   Game flow
   ======================= */
function showMap(){
  stopTimer();
  screenGame.style.display = "none";
  screenMap.style.display = "grid";
  renderMapUI();
  scrollToCurrent();
}
function showGame(){
  screenMap.style.display = "none";
  screenGame.style.display = "block";
}
function startLevel(level, forceReplay){
  const stu = getStu();
  if(!stu){ toast("è«‹å…ˆç™»å…¥å­¸ç”Ÿå§“å"); return; }

  // lock check
  if(level>1 && !stu.levels[level-1]?.passed && !stu.levels[level]?.passed){
    toast("ğŸ”’ å…ˆé€šéä¸Šä¸€é—œæ‰å¯æŒ‘æˆ°é€™ä¸€é—œ");
    return;
  }

  inLevel = level;

  // mode: each attempt random
  levelMode = MODES[Math.floor(Math.random()*MODES.length)];
  gModeTag.textContent = modeLabel(levelMode);

  // build 10 questions from 153 pool (no duplicates in a level)
  const picked = pickUnique(WORDS, Q_PER_LEVEL);
  questions = buildQuestionsForMode(levelMode, picked);

  qIndex = 0;
  score = 0;
  startTs = Date.now();
  canNext = false;

  // record attempt
  if(!stu.levels[level]) stu.levels[level] = {bestScore:0, bestTimeMs:0, attempts:0, passed:false, firstPassConfettiDone:false};
  if(forceReplay || true){
    stu.levels[level].attempts = (stu.levels[level].attempts||0) + 1;
    stu.plays = (stu.plays||0) + 1;
    stu.lastAt = Date.now();
    saveState();
  }

  showGame();
  renderQuestion();
  startTimer();
}
function buildQuestionsForMode(mode, picked){
  if(mode==="C"){
    // Matching: 10 words => two rounds of 5 pairs each
    const a = picked.slice(0,5);
    const b = picked.slice(5,10);
    return [
      {mode:"C", pairs:a, round:1},
      {mode:"C", pairs:b, round:2},
    ];
  }
  // A/B/D: 10 individual questions
  return picked.map(w=>{
    if(mode==="A"){
      return {mode:"A", word:w};
    }
    if(mode==="B"){
      return {mode:"B", word:w};
    }
    if(mode==="D"){
      return {mode:"D", word:w};
    }
  });
}
function renderQuestion(){
  statusEl.textContent = "";
  statusEl.className = "status";
  revealEl.textContent = "";
  btnNext.disabled = true;
  canNext = false;

  gLevel.textContent = inLevel;

  if(levelMode==="C"){
    // there are 2 rounds, each counts as 5 questions => map to 10
    const answeredSoFar = (qIndex===0)?0:5;
    gQ.textContent = answeredSoFar + 1; // show "ç¬¬ 1/10" feeling
  }else{
    gQ.textContent = qIndex + 1;
  }
  gScore.textContent = score;

  btnPrevQ.disabled = (qIndex===0);
  btnRetry.disabled = false;

  gameBody.innerHTML = "";

  if(levelMode==="A") renderModeA(questions[qIndex]);
  if(levelMode==="B") renderModeB(questions[qIndex]);
  if(levelMode==="C") renderModeC(questions[qIndex]);
  if(levelMode==="D") renderModeD(questions[qIndex]);
}
function prevQuestion(){
  if(qIndex<=0) return;
  qIndex--;
  renderQuestion();
}
function nextQuestion(){
  if(!canNext){
    toast("å…ˆä½œç­”å†ä¸‹ä¸€é¡Œ");
    return;
  }
  if(levelMode==="C"){
    // two rounds only; each round must be completed then next
    if(qIndex < questions.length-1){
      qIndex++;
      renderQuestion();
    }else{
      endLevel();
    }
    return;
  }
  if(qIndex < questions.length-1){
    qIndex++;
    renderQuestion();
  }else{
    endLevel();
  }
}
function endLevel(){
  stopTimer();
  const ms = Date.now() - startTs;
  const stu = getStu();

  // finalize: score already in /10
  const lv = inLevel;
  const rec = stu.levels[lv] || {bestScore:0, bestTimeMs:0, attempts:0, passed:false, firstPassConfettiDone:false};

  // best score/time
  if(score > (rec.bestScore||0) || (score === (rec.bestScore||0) && (rec.bestTimeMs===0 || ms < rec.bestTimeMs))){
    rec.bestScore = score;
    rec.bestTimeMs = ms;
  }

  const passedNow = score >= PASS_SCORE;
  let firstPass = false;
  if(passedNow && !rec.passed){
    rec.passed = true;
    firstPass = true;
  }

  // confetti only first pass once
  if(firstPass && !rec.firstPassConfettiDone){
    rec.firstPassConfettiDone = true;
    confetti();
  }

  stu.levels[lv] = rec;
  saveState();

  // Show completion screen inside gameBody
  const minutes = Math.floor(ms/60000);
  const seconds = Math.floor((ms%60000)/1000);
  const timeStr = `${minutes}:${String(seconds).padStart(2,"0")}`;

  const passText = passedNow ? "âœ… é€šé—œæˆåŠŸï¼" : "âš ï¸ åˆ†æ•¸ä¸è¶³ï¼Œé‡ç©å†æŒ‘æˆ°ä¸€æ¬¡ï½";
  const passColor = passedNow ? "good" : "bad";

  const html = `
    <div class="card" style="background:#fff">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="row">
          <span class="pill">ğŸ‰ ç¬¬ ${lv} é—œå®Œæˆ</span>
          <span class="chip">æ¨¡å¼ï¼š<b>${modeLabel(levelMode)}</b></span>
        </div>
        <span class="pill">ğŸ” æœ¬é—œç¬¬ <b>${rec.attempts}</b> æ¬¡</span>
      </div>
      <div class="bigWord" style="margin:10px 0 0; font-size:30px">${passText}</div>
      <div class="sub">å¾—åˆ†ï¼š<b>${score}/10</b>ã€€ï½œã€€æ™‚é–“ï¼š<b>${timeStr}</b>ã€€ï½œã€€é€šé—œé–€æª»ï¼š<b>${PASS_SCORE}/10</b></div>
      <div class="footerBtns">
        <button class="ghost" onclick="showMap()">ğŸ—ºï¸ å›åœ°åœ–</button>
        <button class="primary" onclick="startLevel(${lv}, true)">ğŸ” é‡ç©æœ¬é—œ</button>
        <button class="primary" onclick="startLevel(Math.min(${LEVELS}, ${lv}+1), false)">â¡ï¸ ä¸‹ä¸€é—œ</button>
      </div>
      <div class="note" style="margin-top:10px; text-align:center">
        â­ æœ¬é—œå¯é‡ç©ï¼›è€å¸«å¾Œå°æœƒåˆ†é–‹è¨˜éŒ„ã€Œæœ€ä½³æˆç¸¾ã€èˆ‡ã€ŒæŒ‘æˆ°æ¬¡æ•¸ã€ã€‚
      </div>
    </div>
  `;
  gameBody.innerHTML = html;

  statusEl.textContent = "";
  revealEl.textContent = "";
  btnNext.disabled = true;
  btnPrevQ.disabled = true;
}
function modeLabel(m){
  if(m==="A") return "A è½ â†’ é¸ä¸­æ–‡ï¼ˆä¸é¡¯ç¤ºè‹±æ–‡ï¼‰";
  if(m==="B") return "B çœ‹è‹±æ–‡ â†’ é¸ä¸­æ–‡";
  if(m==="C") return "C è‹±æ–‡ â†” ä¸­æ–‡é…å°";
  if(m==="D") return "D è½ â†’ æ‹¼è‹±æ–‡å–®å­—";
  return m;
}

/* =======================
   Mode A: listen -> choose zh (no english shown)
   ======================= */
function renderModeA(q){
  const w = q.word;
  const correct = w.zh;
  const distract = pickDistractorsZh(w.id, 3);
  const options = shuffle([correct, ...distract]);

  const title = document.createElement("div");
  title.className = "bigWord";
  title.style.fontSize = "26px";
  title.textContent = "ğŸ”Š è½éŸ³é¸ä¸­æ–‡";
  gameBody.appendChild(title);

  const sub = document.createElement("div");
  sub.className = "sub";
  sub.textContent = "æŒ‰ã€Œæ’­æ”¾ã€è½è‹±æ–‡ï¼Œé¸å‡ºæ­£ç¢ºä¸­æ–‡æ„æ€ï¼ˆä¸æœƒé¡¯ç¤ºè‹±æ–‡å–®å­—ï¼‰";
  gameBody.appendChild(sub);

  const box = document.createElement("div");
  box.className = "choices";
  box.classList.add("grid2");

  options.forEach(txt=>{
    const btn = document.createElement("div");
    btn.className = "choice";
    btn.textContent = txt;
    btn.onclick = ()=>{
      if(canNext) return;
      const ok = (txt===correct);
      markChoice(btn, ok);
      finalizeAnswer(ok, w, {showEnglishOnWrong:true});
      // mark other buttons
      [...box.children].forEach(el=>{
        if(el!==btn){
          if(el.textContent===correct) el.classList.add("correct");
          el.style.pointerEvents="none";
        }else{
          el.style.pointerEvents="none";
        }
      });
    };
    box.appendChild(btn);
  });

  gameBody.appendChild(box);

  // auto speak once when entering (after small delay)
  setTimeout(()=> speak(w.en), 300);
}

/* =======================
   Mode B: show english -> choose zh
   ======================= */
function renderModeB(q){
  const w = q.word;
  const correct = w.zh;
  const distract = pickDistractorsZh(w.id, 3);
  const options = shuffle([correct, ...distract]);

  const big = document.createElement("div");
  big.className = "bigWord";
  big.textContent = w.en;
  gameBody.appendChild(big);

  const sub = document.createElement("div");
  sub.className = "sub";
  sub.textContent = "é¸å‡ºæ­£ç¢ºä¸­æ–‡æ„æ€";
  gameBody.appendChild(sub);

  const box = document.createElement("div");
  box.className = "choices";
  box.classList.add("grid2");

  options.forEach(txt=>{
    const btn = document.createElement("div");
    btn.className = "choice";
    btn.textContent = txt;
    btn.onclick = ()=>{
      if(canNext) return;
      const ok = (txt===correct);
      markChoice(btn, ok);
      finalizeAnswer(ok, w, {showEnglishOnWrong:true});
      [...box.children].forEach(el=>{
        if(el!==btn){
          if(el.textContent===correct) el.classList.add("correct");
          el.style.pointerEvents="none";
        }else{
          el.style.pointerEvents="none";
        }
      });
    };
    box.appendChild(btn);
  });

  gameBody.appendChild(box);
}

/* =======================
   Mode C: matching (two rounds, 5 pairs each)
   ======================= */
function renderModeC(q){
  const pairs = q.pairs; // 5 words
  const left = pairs.map(w=>({type:"en", id:w.id, text:w.en, w}));
  const right = pairs.map(w=>({type:"zh", id:w.id, text:w.zh, w}));
  const leftSh = shuffle(left);
  const rightSh = shuffle(right);
  const tiles = [...leftSh, ...rightSh];

  const title = document.createElement("div");
  title.className = "bigWord";
  title.style.fontSize="26px";
  title.textContent = `ğŸ§© è‹±ä¸­é…å°ï¼ˆç¬¬ ${q.round}/2 çµ„ï¼‰`;
  gameBody.appendChild(title);

  const sub = document.createElement("div");
  sub.className = "sub";
  sub.textContent = "é»é¸è‹±æ–‡ï¼Œå†é»é¸å°æ‡‰ä¸­æ–‡ï¼ˆæˆ–åéä¾†ä¹Ÿå¯ä»¥ï¼‰";
  gameBody.appendChild(sub);

  const grid = document.createElement("div");
  grid.className = "matchGrid";

  let selected = null;
  let matched = new Set();
  let localWrong = 0;

  function tileClick(tile, item){
    if(tile.classList.contains("done")) return;
    if(!selected){
      selected = {tile, item};
      tile.classList.add("sel");
      return;
    }
    if(selected.tile===tile) return;

    // check match
    const ok = selected.item.id === item.id && selected.item.type !== item.type;
    selected.tile.classList.remove("sel");
    tile.classList.remove("sel");

    if(ok){
      selected.tile.classList.add("ok","done");
      tile.classList.add("ok","done");
      matched.add(item.id);
      selected = null;

      if(matched.size===pairs.length){
        // round complete => counts as 5 questions
        // scoring: +1 per correct pair (5), minus wrong pairs (up to 0)
        const gained = Math.max(0, 5 - localWrong);
        // normalize into /10 across two rounds:
        // each round max 5 points => total 10
        score += gained;
        gScore.textContent = score;

        statusEl.className="status good";
        statusEl.textContent = `âœ… é€™çµ„å®Œæˆï¼æœ¬çµ„å¾—åˆ†ï¼š${gained}/5`;
        revealEl.textContent = "";
        btnNext.disabled = false;
        canNext = true;
      }
    }else{
      localWrong++;
      selected.tile.classList.add("no");
      tile.classList.add("no");
      setTimeout(()=>{
        selected?.tile?.classList.remove("no");
        tile.classList.remove("no");
      }, 350);

      // record wrong for both items involved if they are a word
      const stu = getStu();
      if(stu){
        bumpWrong(stu, selected.item.w?.id);
        bumpWrong(stu, item.w?.id);
        saveState();
      }

      selected = null;
    }
  }

  tiles.forEach(item=>{
    const t = document.createElement("div");
    t.className = "tile";
    t.textContent = item.text;
    t.onclick = ()=> tileClick(t, item);
    grid.appendChild(t);
  });

  gameBody.appendChild(grid);

  // In matching, disable speak by default (but keep speak button usable: speaks selected EN if any)
  statusEl.textContent = "";
  revealEl.textContent = "";
  btnNext.disabled = true;
  canNext = false;
}

/* =======================
   Mode D: listen -> spell english
   ======================= */
function renderModeD(q){
  const w = q.word;
  const target = w.en.toLowerCase();
  const title = document.createElement("div");
  title.className = "bigWord";
  title.style.fontSize="26px";
  title.textContent = "ğŸ§ è½éŸ³æ‹¼è‹±æ–‡";
  gameBody.appendChild(title);

  const sub = document.createElement("div");
  sub.className = "sub";
  sub.textContent = "æŒ‰æ’­æ”¾è½è‹±æ–‡ï¼Œæ‹¼å‡ºè‹±æ–‡å–®å­—";
  gameBody.appendChild(sub);

  const hint = document.createElement("div");
  hint.className = "hintBox";
  hint.innerHTML = `<div class="row" style="justify-content:space-between">
    <span class="chip">ä¸­æ–‡æç¤ºï¼š<b>${w.zh}</b></span>
    <span class="chip">é•·åº¦ï¼š<b>${target.length}</b></span>
  </div>`;
  gameBody.appendChild(hint);

  const spell = document.createElement("div");
  spell.className = "spellRow";
  gameBody.appendChild(spell);

  let typed = "";

  function drawBoxes(){
    spell.innerHTML = "";
    for(let i=0;i<target.length;i++){
      const b = document.createElement("div");
      b.className = "box";
      b.textContent = typed[i] ? typed[i].toUpperCase() : "";
      spell.appendChild(b);
    }
  }
  drawBoxes();

  const kbd = document.createElement("div");
  kbd.className = "kbd";
  const letters = "abcdefghijklmnopqrstuvwxyz".split("");
  // choose a compact set: include all target letters + random
  const set = new Set(target.split(""));
  while(set.size < Math.min(14, 26)){
    set.add(letters[Math.floor(Math.random()*letters.length)]);
  }
  const keys = shuffle([...set]);

  keys.forEach(ch=>{
    const b = document.createElement("div");
    b.className = "kbtn";
    b.textContent = ch.toUpperCase();
    b.onclick = ()=>{
      if(canNext) return;
      if(typed.length >= target.length) return;
      typed += ch;
      drawBoxes();
      if(typed.length === target.length){
        // auto check
        const ok = typed.toLowerCase() === target;
        finalizeAnswer(ok, w, {typed, showEnglishOnWrong:true});
      }
    };
    kbd.appendChild(b);
  });

  // Backspace & clear
  const bk = document.createElement("div");
  bk.className = "kbtn";
  bk.textContent = "âŒ«";
  bk.onclick = ()=>{
    if(canNext) return;
    typed = typed.slice(0,-1);
    drawBoxes();
  };
  kbd.appendChild(bk);

  const clr = document.createElement("div");
  clr.className = "kbtn";
  clr.textContent = "æ¸…é™¤";
  clr.onclick = ()=>{
    if(canNext) return;
    typed = "";
    drawBoxes();
  };
  kbd.appendChild(clr);

  gameBody.appendChild(kbd);

  setTimeout(()=> speak(w.en), 300);
}

/* =======================
   Answer handling
   ======================= */
function markChoice(btn, ok){
  btn.classList.add(ok ? "correct" : "wrong");
}
function finalizeAnswer(ok, word, meta={}){
  const stu = getStu();
  if(stu){
    // record wrong
    if(!ok){
      bumpWrong(stu, word.id);
      saveState();
    }
    saveState();
  }

  if(ok){
    score += 1;
    statusEl.className = "status good";
    statusEl.textContent = "âœ… ç­”å°ï¼";
    revealEl.textContent = "";
  }else{
    statusEl.className = "status bad";
    statusEl.textContent = "âŒ éŒ¯äº†";
    // show correct answer (ä½ è¦æ±‚ï¼šéŒ¯äº†è¦çµ¦æ­£ç¢ºç­”æ¡ˆ)
    revealEl.textContent = `æ­£è§£ï¼š${word.en} ï¼ ${word.zh}`;
  }
  gScore.textContent = score;

  btnNext.disabled = false;
  canNext = true;
}

/* =======================
   Wrong stats
   ======================= */
function bumpWrong(stu, wordId){
  if(!wordId) return;
  if(!stu.wrong) stu.wrong = {};
  stu.wrong[wordId] = (stu.wrong[wordId]||0) + 1;
}

/* =======================
   Timer
   ======================= */
function startTimer(){
  stopTimer();
  timerId = setInterval(()=>{
    const ms = Date.now() - startTs;
    const m = Math.floor(ms/60000);
    const s = Math.floor((ms%60000)/1000);
    gTime.textContent = `${m}:${String(s).padStart(2,"0")}`;
  }, 250);
}
function stopTimer(){
  if(timerId){ clearInterval(timerId); timerId=null; }
}

/* =======================
   Speech: best voice + clean speaking
   ======================= */
let bestVoice = null;

function pickBestVoice(forceToast){
  const voices = speechSynthesis.getVoices() || [];
  if(!voices.length){
    if(forceToast) toast("èªéŸ³å°šæœªè¼‰å…¥ï¼Œç­‰ä¸€ä¸‹å†æŒ‰ä¸€æ¬¡");
    return;
  }
  // prefer en-US + Google/Samantha + non-local? (varies by device)
  const prefer = voices
    .filter(v => (v.lang||"").toLowerCase().startsWith("en"))
    .sort((a,b)=>{
      const an = (a.name||"").toLowerCase();
      const bn = (b.name||"").toLowerCase();
      const scoreV = (v)=>{
        let s = 0;
        if((v.lang||"").toLowerCase().startsWith("en-us")) s += 30;
        const n = (v.name||"").toLowerCase();
        if(n.includes("google")) s += 40;
        if(n.includes("samantha")) s += 35; // iOS common
        if(n.includes("enhanced")) s += 20;
        if(n.includes("premium")) s += 20;
        if(n.includes("natural")) s += 20;
        if(v.localService===false) s += 5;
        return s;
      };
      return scoreV(b) - scoreV(a);
    });

  bestVoice = prefer[0] || voices[0];
  if(forceToast){
    toast(`å·²é¸ç”¨èªéŸ³ï¼š${bestVoice.name}ï¼ˆ${bestVoice.lang}ï¼‰`);
  }
}
function speak(text){
  if(!text) return;
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(String(text));
    u.lang = (bestVoice && bestVoice.lang) ? bestVoice.lang : "en-US";
    if(bestVoice) u.voice = bestVoice;
    u.rate = Number(rate.value || 0.95);
    u.pitch = 1.0;
    u.volume = 1.0;
    lastSpokenWord = text;
    speechSynthesis.speak(u);
  }catch(e){
    toast("æ­¤è£ç½®ä¸æ”¯æ´ç™¼éŸ³");
  }
}
function speakCurrent(){
  // Speak current target word only (ä¸å¿µé¡Œè™Ÿã€ä¸å¿µä¸­æ–‡)
  if(levelMode==="C"){
    // speak selected EN tile if any, else nothing
    speak(" ");
    return;
  }
  let w = null;
  if(levelMode==="A"||levelMode==="B"||levelMode==="D"){
    const q = questions[qIndex];
    w = q.word;
  }
  if(w) speak(w.en);
}

/* =======================
   Fullscreen
   ======================= */
function requestFull(){
  const el = document.documentElement;
  if(el.requestFullscreen){
    el.requestFullscreen().catch(()=>toast("æ­¤ç€è¦½å™¨ä¸æ”¯æ´å…¨è¢å¹•"));
  }else{
    toast("iPhone/iPad Safari ä¸ä¸€å®šæ”¯æ´çœŸæ­£å…¨è¢å¹•ï¼›å¯ç”¨ã€åŠ å…¥ä¸»ç•«é¢ã€æ•ˆæœæ›´åƒApp");
  }
}

/* =======================
   Teacher backend
   ======================= */
function openTeacher(){
  const pass = prompt("è¼¸å…¥è€å¸«å¯†ç¢¼ï¼š");
  if(pass!==TEACHER_PASS){
    toast("å¯†ç¢¼éŒ¯èª¤");
    return;
  }
  renderTeacher();
  teacherModal.style.display="grid";
}
function renderTeacher(){
  const names = Object.keys(state.students||{});
  stuCountEl.textContent = names.length;

  // KPIs
  let totalPlays = 0;
  let totalPass = 0;
  let totalScoreSum = 0;
  let totalLevelAttempts = 0;
  const wrongAgg = {};

  names.forEach(n=>{
    const s = state.students[n];
    totalPlays += (s.plays||0);
    // level stats
    for(let lv=1;lv<=LEVELS;lv++){
      const r = s.levels?.[lv];
      if(!r) continue;
      totalLevelAttempts += (r.attempts||0);
      totalScoreSum += (r.bestScore||0);
      if(r.passed) totalPass += 1;
    }
    // wrong
    const w = s.wrong||{};
    Object.keys(w).forEach(id=>{
      wrongAgg[id] = (wrongAgg[id]||0) + (w[id]||0);
    });
  });

  kTotalPlays.textContent = totalPlays;
  kTotalPass.textContent = totalPass;
  const avg = totalScoreSum ? (totalScoreSum / Math.max(1, countBestRecords())).toFixed(2) : "0";
  kAvgScore.textContent = avg;

  // top wrong
  const topWrongId = Object.entries(wrongAgg).sort((a,b)=>b[1]-a[1])[0]?.[0];
  if(topWrongId){
    const ww = WORDS.find(x=>x.id===Number(topWrongId));
    kTopWrong.textContent = ww ? `${ww.en}` : "â€”";
  }else{
    kTopWrong.textContent = "â€”";
  }

  // student table
  tblStudents.innerHTML = "";
  names.sort((a,b)=>a.localeCompare(b,"zh-Hant")).forEach(name=>{
    const s = state.students[name];
    let passed = 0;
    let nextLv = 1;
    for(let i=1;i<=LEVELS;i++){
      if(s.levels?.[i]?.passed) passed++;
    }
    for(let i=1;i<=LEVELS;i++){
      if(!s.levels?.[i]?.passed){ nextLv=i; break; }
      nextLv = Math.min(LEVELS, i+1);
    }
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${escapeHtml(name)}</b></td>
      <td class="right">${passed}</td>
      <td class="right">${nextLv}</td>
      <td class="right">${s.plays||0}</td>
      <td>${s.lastAt ? new Date(s.lastAt).toLocaleString() : "-"}</td>
    `;
    tblStudents.appendChild(tr);
  });

  // wrong top 30
  tblWrong.innerHTML = "";
  const top = Object.entries(wrongAgg).sort((a,b)=>b[1]-a[1]).slice(0,30);
  top.forEach(([id,c])=>{
    const ww = WORDS.find(x=>x.id===Number(id));
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${ww?escapeHtml(ww.en):id}</b></td>
      <td>${ww?escapeHtml(ww.zh):"-"}</td>
      <td class="right">${c}</td>
    `;
    tblWrong.appendChild(tr);
  });
}
function countBestRecords(){
  let cnt = 0;
  Object.values(state.students||{}).forEach(s=>{
    for(let lv=1;lv<=LEVELS;lv++){
      if(s.levels?.[lv]) cnt++;
    }
  });
  return cnt;
}
btnExportCSV.onclick = ()=>{
  const rows = [];
  rows.push(["student","level","passed","bestScore","bestTimeSec","attempts","lastAt"]);
  Object.keys(state.students||{}).forEach(name=>{
    const s = state.students[name];
    for(let lv=1;lv<=LEVELS;lv++){
      const r = s.levels?.[lv];
      if(!r) continue;
      rows.push([
        name,
        lv,
        r.passed ? 1 : 0,
        r.bestScore||0,
        r.bestTimeMs ? Math.round(r.bestTimeMs/1000) : 0,
        r.attempts||0,
        s.lastAt ? new Date(s.lastAt).toISOString() : ""
      ]);
    }
  });
  downloadCSV("nmps_spelling_progress.csv", rows);
  toast("å·²åŒ¯å‡ºCSV");
};
btnExportJSON.onclick = ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  downloadBlob("nmps_spelling_state.json", blob);
  toast("å·²åŒ¯å‡ºJSON");
};
btnImportJSON.onclick = ()=> importFile.click();
importFile.onchange = async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const txt = await f.text();
  try{
    const obj = JSON.parse(txt);
    // merge students only
    if(obj.students){
      Object.keys(obj.students).forEach(name=>{
        if(!state.students[name]) state.students[name] = obj.students[name];
        else{
          // merge levels & wrong (sum)
          const a = state.students[name];
          const b = obj.students[name];
          a.levels = a.levels || {};
          b.levels = b.levels || {};
          Object.keys(b.levels).forEach(lv=>{
            const L = lv;
            if(!a.levels[L]) a.levels[L] = b.levels[L];
            else{
              // keep better bestScore/time, sum attempts, passed if either
              const r1 = a.levels[L], r2 = b.levels[L];
              const bestScore = Math.max(r1.bestScore||0, r2.bestScore||0);
              let bestTime = r1.bestTimeMs||0;
              if(bestScore === (r2.bestScore||0)){
                if(bestTime===0 || (r2.bestTimeMs||0) < bestTime) bestTime = r2.bestTimeMs||0;
              }
              a.levels[L] = {
                bestScore,
                bestTimeMs: bestTime,
                attempts: (r1.attempts||0) + (r2.attempts||0),
                passed: !!(r1.passed || r2.passed),
                firstPassConfettiDone: !!(r1.firstPassConfettiDone || r2.firstPassConfettiDone)
              };
            }
          });
          a.wrong = a.wrong || {};
          b.wrong = b.wrong || {};
          Object.keys(b.wrong).forEach(id=>{
            a.wrong[id] = (a.wrong[id]||0) + (b.wrong[id]||0);
          });
          a.plays = (a.plays||0) + (b.plays||0);
          a.lastAt = Math.max(a.lastAt||0, b.lastAt||0);
        }
      });
      saveState();
      renderTeacher();
      renderMapUI();
      toast("å·²åŒ¯å…¥ä¸¦å½™æ•´å®Œæˆ");
    }else{
      toast("JSONæ ¼å¼ä¸æ­£ç¢º");
    }
  }catch{
    toast("è®€å–JSONå¤±æ•—");
  }finally{
    importFile.value="";
  }
};
btnResetAll.onclick = ()=>{
  if(confirm("ç¢ºå®šæ¸…ç©ºæœ¬è£ç½®æ‰€æœ‰å­¸ç”Ÿè³‡æ–™ï¼Ÿæ­¤å‹•ä½œä¸å¯å¾©åŸã€‚")){
    localStorage.removeItem(LS_KEY);
    state = loadState();
    curStudent = "";
    renderMap();
    renderMapUI();
    renderTeacher();
    toast("å·²æ¸…ç©º");
  }
};

/* =======================
   Utilities
   ======================= */
function pickUnique(arr, n){
  const copy = arr.slice();
  shuffle(copy);
  return copy.slice(0,n);
}
function pickDistractorsZh(correctId, k){
  const pool = WORDS.filter(w=>w.id!==correctId).map(w=>w.zh);
  const picked = [];
  while(picked.length<k){
    const z = pool[Math.floor(Math.random()*pool.length)];
    if(!picked.includes(z)) picked.push(z);
  }
  return picked;
}
function randSeed(i){
  // deterministic pseudo random 0..1
  const x = Math.sin(i*999.123)*10000;
  return x - Math.floor(x);
}
function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
function toast(msg){
  // simple toast
  const t = document.createElement("div");
  t.textContent = msg;
  t.style.position="fixed";
  t.style.left="50%";
  t.style.bottom="18px";
  t.style.transform="translateX(-50%)";
  t.style.background="rgba(17,24,39,.92)";
  t.style.color="#fff";
  t.style.padding="10px 12px";
  t.style.borderRadius="14px";
  t.style.boxShadow="0 18px 34px rgba(2,6,23,.35)";
  t.style.fontWeight="900";
  t.style.zIndex=60;
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.opacity="0"; t.style.transition="opacity .25s"; }, 1300);
  setTimeout(()=>t.remove(), 1700);
}
function downloadCSV(filename, rows){
  const csv = rows.map(r=>r.map(x=>{
    const s = String(x??"");
    if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
    return s;
  }).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  downloadBlob(filename, blob);
}
function downloadBlob(filename, blob){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

/* =======================
   Confetti (first pass only)
   ======================= */
function resizeFx(){
  fx.width = window.innerWidth * devicePixelRatio;
  fx.height = window.innerHeight * devicePixelRatio;
  fx.style.width = window.innerWidth+"px";
  fx.style.height = window.innerHeight+"px";
  fxCtx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
function confetti(){
  const pieces = [];
  const colors = ["#22c55e","#60a5fa","#f59e0b","#ef4444","#a78bfa","#14b8a6"];
  const W = window.innerWidth;
  const H = window.innerHeight;

  for(let i=0;i<160;i++){
    pieces.push({
      x: Math.random()*W,
      y: -20 - Math.random()*H*0.2,
      vx: (Math.random()-0.5)*3,
      vy: 2 + Math.random()*5,
      r: 3 + Math.random()*5,
      c: colors[Math.floor(Math.random()*colors.length)],
      rot: Math.random()*Math.PI,
      vr: (Math.random()-0.5)*0.2
    });
  }
  let t0 = performance.now();
  function step(t){
    const dt = (t - t0)/16.7;
    t0 = t;
    fxCtx.clearRect(0,0,W,H);
    pieces.forEach(p=>{
      p.x += p.vx*dt;
      p.y += p.vy*dt;
      p.vy += 0.06*dt;
      p.rot += p.vr*dt;
      fxCtx.save();
      fxCtx.translate(p.x,p.y);
      fxCtx.rotate(p.rot);
      fxCtx.fillStyle = p.c;
      fxCtx.fillRect(-p.r, -p.r, p.r*2.2, p.r*1.4);
      fxCtx.restore();
    });
    // remove offscreen
    for(let i=pieces.length-1;i>=0;i--){
      if(pieces[i].y > H+40) pieces.splice(i,1);
    }
    if(pieces.length>0) requestAnimationFrame(step);
    else fxCtx.clearRect(0,0,W,H);
  }
  requestAnimationFrame(step);
}
</script>
</body>
</html>
